import { Injectable, inject } from '@angular/core';
import { catchError, filter, map, of, switchMap } from 'rxjs';
import { CamBaseService, HandleSimpleRequest } from '@ta/server';
import { isNonNullable } from '@ta/utils';
import { TaUsersService } from './users.service';
import { functionProps } from './users/dto/function';
import { roleProps } from './users/dto/role';
import { ADD_FUNCTION, ADD_FUNCTION_TO_USER, REMOVE_FUNCTION_FROM_USER, UPDATE_FUNCTION } from './users/userMutations';
import { GET_FUNCTIONS, GET_ROLES } from './users/userQueries';
import * as i0 from "@angular/core";
const graphEndpoint = {
    clientName: 'userService',
    endpoint: 'user',
};
export class CamFunctionsService extends CamBaseService {
    constructor() {
        super();
        this.functions = new HandleSimpleRequest();
        this.roles = new HandleSimpleRequest();
        this._usersService = inject(TaUsersService);
        super.registerRoutes({ graphEndpoint: graphEndpoint });
    }
    fetchFunctions$() {
        return this.functions.fetch(this._graphService
            .fetchPagedQueryList(GET_FUNCTIONS('', `
              ${functionProps.get('id')}
              ${functionProps.get('name')}
              ${functionProps.get('roles')} {
                ${roleProps.get('id')}
                ${roleProps.get('name')}
              }
            `), 'functions', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? [])));
    }
    fetchRoles$() {
        return this.roles.fetch(this._graphService
            .fetchPagedQueryList(GET_ROLES('', `
              ${roleProps.get('id')}
              ${roleProps.get('name')}
            `), 'roles', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? [])));
    }
    addFunction$(functionAddedPayload) {
        return this._graphService
            .mutate(ADD_FUNCTION(functionAddedPayload), 'addFunction', graphEndpoint.clientName, ['functions'])
            .pipe(filter(isNonNullable), switchMap(() => this.fetchFunctions$()), catchError(error => {
            console.error('Error adding function:', error);
            return of(null);
        }));
    }
    updateFunction$(functionModifierPayload) {
        return this._graphService
            .mutate(UPDATE_FUNCTION(functionModifierPayload), 'updateFunction', graphEndpoint.clientName, [
            'functions',
        ])
            .pipe(filter(isNonNullable), switchMap(() => this.fetchFunctions$()), catchError(error => {
            console.error('Error adding function:', error);
            return of(null);
        }));
    }
    addFunctionToUser$(payload) {
        return this._graphService
            .mutate(ADD_FUNCTION_TO_USER(payload), 'addFunctionToUser', graphEndpoint.clientName, ['userById'])
            .pipe(filter(isNonNullable), switchMap(() => this._usersService.fetchUser$(payload.userId)), catchError(error => {
            console.error('Error adding function:', error);
            return of(null);
        }));
    }
    removeFunctionFromUser$(payload) {
        return this._graphService
            .mutate(REMOVE_FUNCTION_FROM_USER(payload), 'removeFunctionFromUser', graphEndpoint.clientName, [
            'userById',
        ])
            .pipe(filter(isNonNullable), switchMap(() => this._usersService.fetchUser$(payload.userId)), catchError(error => {
            console.error('Error adding function:', error);
            return of(null);
        }));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamFunctionsService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamFunctionsService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamFunctionsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL21vZHVsZXMvdXNlci9zZXJ2aWNlcy9mdW5jdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRCxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUxRSxPQUFPLEVBQUUsY0FBYyxFQUFpQixtQkFBbUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNoRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQThELGFBQWEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pILE9BQU8sRUFBUSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLHlCQUF5QixFQUFFLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3ZILE9BQU8sRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7O0FBRS9ELE1BQU0sYUFBYSxHQUFrQjtJQUNuQyxVQUFVLEVBQUUsYUFBYTtJQUN6QixRQUFRLEVBQUUsTUFBTTtDQUNqQixDQUFDO0FBS0YsTUFBTSxPQUFPLG1CQUFvQixTQUFRLGNBQWM7SUFNckQ7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQU5ILGNBQVMsR0FBRyxJQUFJLG1CQUFtQixFQUFjLENBQUM7UUFDbEQsVUFBSyxHQUFHLElBQUksbUJBQW1CLEVBQVUsQ0FBQztRQUV6QyxrQkFBYSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FB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QUFVLENBQUMsQ0FBQzthQUM1RyxJQUFJLENBQ0gsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUNyQixTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQzlELFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQy9DLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDTixDQUFDO0lBRU0sdUJBQXVCLENBQUMsT0FBNEI7UUFDekQsT0FBTyxJQUFJLENBQUMsYUFBYTthQUN0QixNQUFNLENBQVcseUJBQXlCLENBQUMsT0FBTyxDQUFDLEVBQUUsd0JBQXdCLEVBQUUsYUFBYSxDQUFDLFVBQVUsRUFBRTtZQUN4RyxVQUFVO1NBQ1gsQ0FBQzthQUNELElBQUksQ0FDSCxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQ3JCLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDOUQsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDL0MsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7K0dBL0dVLG1CQUFtQjttSEFBbkIsbUJBQW1CLGNBRmxCLE1BQU07OzRGQUVQLG1CQUFtQjtrQkFIL0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgY2F0Y2hFcnJvciwgZmlsdGVyLCBtYXAsIG9mLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgQ2FtQmFzZVNlcnZpY2UsIEdyYXBoRW5kcG9pbnQsIEhhbmRsZVNpbXBsZVJlcXVlc3QgfSBmcm9tICdAdGEvc2VydmVyJztcbmltcG9ydCB7IGlzTm9uTnVsbGFibGUgfSBmcm9tICdAdGEvdXRpbHMnO1xuXG5pbXBvcnQgeyBUYVVzZXJzU2VydmljZSB9IGZyb20gJy4vdXNlcnMuc2VydmljZSc7XG5pbXBvcnQgeyBGdW5jdGlvbiwgRnVuY3Rpb25DcmVhdGlvblBheWxvYWQsIEZ1bmN0aW9uTW9kaWZpZXJQYXlsb2FkLCBmdW5jdGlvblByb3BzIH0gZnJvbSAnLi91c2Vycy9kdG8vZnVuY3Rpb24nO1xuaW1wb3J0IHsgUm9sZSwgcm9sZVByb3BzIH0gZnJvbSAnLi91c2Vycy9kdG8vcm9sZSc7XG5pbXBvcnQgeyBVc2VyRnVuY3Rpb25QYXlsb2FkIH0gZnJvbSAnLi91c2Vycy9kdG8vdXNlcic7XG5pbXBvcnQgeyBBRERfRlVOQ1RJT04sIEFERF9GVU5DVElPTl9UT19VU0VSLCBSRU1PVkVfRlVOQ1RJT05fRlJPTV9VU0VSLCBVUERBVEVfRlVOQ1RJT04gfSBmcm9tICcuL3VzZXJzL3VzZXJNdXRhdGlvbnMnO1xuaW1wb3J0IHsgR0VUX0ZVTkNUSU9OUywgR0VUX1JPTEVTIH0gZnJvbSAnLi91c2Vycy91c2VyUXVlcmllcyc7XG5cbmNvbnN0IGdyYXBoRW5kcG9pbnQ6IEdyYXBoRW5kcG9pbnQgPSB7XG4gIGNsaWVudE5hbWU6ICd1c2VyU2VydmljZScsXG4gIGVuZHBvaW50OiAndXNlcicsXG59O1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgQ2FtRnVuY3Rpb25zU2VydmljZSBleHRlbmRzIENhbUJhc2VTZXJ2aWNlIHtcbiAgcHVibGljIGZ1bmN0aW9ucyA9IG5ldyBIYW5kbGVTaW1wbGVSZXF1ZXN0PEZ1bmN0aW9uW10+KCk7XG4gIHB1YmxpYyByb2xlcyA9IG5ldyBIYW5kbGVTaW1wbGVSZXF1ZXN0PFJvbGVbXT4oKTtcblxuICBwcml2YXRlIF91c2Vyc1NlcnZpY2UgPSBpbmplY3QoVGFVc2Vyc1NlcnZpY2UpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgc3VwZXIucmVnaXN0ZXJSb3V0ZXMoeyBncmFwaEVuZHBvaW50OiBncmFwaEVuZHBvaW50IH0pO1xuICB9XG5cbiAgcHVibGljIGZldGNoRnVuY3Rpb25zJCgpIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnMuZmV0Y2goXG4gICAgICB0aGlzLl9ncmFwaFNlcnZpY2VcbiAgICAgICAgLmZldGNoUGFnZWRRdWVyeUxpc3Q8RnVuY3Rpb24+KFxuICAgICAgICAgIEdFVF9GVU5DVElPTlMoXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgICAgIGBcbiAgICAgICAgICAgICAgJHtmdW5jdGlvblByb3BzLmdldCgnaWQnKX1cbiAgICAgICAgICAgICAgJHtmdW5jdGlvblByb3BzLmdldCgnbmFtZScpfVxuICAgICAgICAgICAgICAke2Z1bmN0aW9uUHJvcHMuZ2V0KCdyb2xlcycpfSB7XG4gICAgICAgICAgICAgICAgJHtyb2xlUHJvcHMuZ2V0KCdpZCcpfVxuICAgICAgICAgICAgICAgICR7cm9sZVByb3BzLmdldCgnbmFtZScpfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBgXG4gICAgICAgICAgKSxcbiAgICAgICAgICAnZnVuY3Rpb25zJyxcbiAgICAgICAgICBncmFwaEVuZHBvaW50LmNsaWVudE5hbWVcbiAgICAgICAgKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSlcbiAgICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hSb2xlcyQoKSB7XG4gICAgcmV0dXJuIHRoaXMucm9sZXMuZmV0Y2goXG4gICAgICB0aGlzLl9ncmFwaFNlcnZpY2VcbiAgICAgICAgLmZldGNoUGFnZWRRdWVyeUxpc3Q8Um9sZT4oXG4gICAgICAgICAgR0VUX1JPTEVTKFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICBgXG4gICAgICAgICAgICAgICR7cm9sZVByb3BzLmdldCgnaWQnKX1cbiAgICAgICAgICAgICAgJHtyb2xlUHJvcHMuZ2V0KCduYW1lJyl9XG4gICAgICAgICAgICBgXG4gICAgICAgICAgKSxcbiAgICAgICAgICAncm9sZXMnLFxuICAgICAgICAgIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZVxuICAgICAgICApXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIGZpbHRlcihpc05vbk51bGxhYmxlKSxcbiAgICAgICAgICBtYXAoZGF0YSA9PiBkYXRhLml0ZW1zID8/IFtdKVxuICAgICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRGdW5jdGlvbiQoZnVuY3Rpb25BZGRlZFBheWxvYWQ6IEZ1bmN0aW9uQ3JlYXRpb25QYXlsb2FkKTogT2JzZXJ2YWJsZTxGdW5jdGlvbltdIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLl9ncmFwaFNlcnZpY2VcbiAgICAgIC5tdXRhdGU8RnVuY3Rpb24+KEFERF9GVU5DVElPTihmdW5jdGlvbkFkZGVkUGF5bG9hZCksICdhZGRGdW5jdGlvbicsIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSwgWydmdW5jdGlvbnMnXSlcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmZldGNoRnVuY3Rpb25zJCgpKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWRkaW5nIGZ1bmN0aW9uOicsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUZ1bmN0aW9uJChmdW5jdGlvbk1vZGlmaWVyUGF5bG9hZDogUGFydGlhbDxGdW5jdGlvbk1vZGlmaWVyUGF5bG9hZD4pOiBPYnNlcnZhYmxlPEZ1bmN0aW9uW10gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZVxuICAgICAgLm11dGF0ZTxGdW5jdGlvbj4oVVBEQVRFX0ZVTkNUSU9OKGZ1bmN0aW9uTW9kaWZpZXJQYXlsb2FkKSwgJ3VwZGF0ZUZ1bmN0aW9uJywgZ3JhcGhFbmRwb2ludC5jbGllbnROYW1lLCBbXG4gICAgICAgICdmdW5jdGlvbnMnLFxuICAgICAgXSlcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmZldGNoRnVuY3Rpb25zJCgpKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWRkaW5nIGZ1bmN0aW9uOicsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcHVibGljIGFkZEZ1bmN0aW9uVG9Vc2VyJChwYXlsb2FkOiBVc2VyRnVuY3Rpb25QYXlsb2FkKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZVxuICAgICAgLm11dGF0ZTxGdW5jdGlvbj4oQUREX0ZVTkNUSU9OX1RPX1VTRVIocGF5bG9hZCksICdhZGRGdW5jdGlvblRvVXNlcicsIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSwgWyd1c2VyQnlJZCddKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcihpc05vbk51bGxhYmxlKSxcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuX3VzZXJzU2VydmljZS5mZXRjaFVzZXIkKHBheWxvYWQudXNlcklkKSksXG4gICAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFkZGluZyBmdW5jdGlvbjonLCBlcnJvcik7XG4gICAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVGdW5jdGlvbkZyb21Vc2VyJChwYXlsb2FkOiBVc2VyRnVuY3Rpb25QYXlsb2FkKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZVxuICAgICAgLm11dGF0ZTxGdW5jdGlvbj4oUkVNT1ZFX0ZVTkNUSU9OX0ZST01fVVNFUihwYXlsb2FkKSwgJ3JlbW92ZUZ1bmN0aW9uRnJvbVVzZXInLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUsIFtcbiAgICAgICAgJ3VzZXJCeUlkJyxcbiAgICAgIF0pXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKGlzTm9uTnVsbGFibGUpLFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5fdXNlcnNTZXJ2aWNlLmZldGNoVXNlciQocGF5bG9hZC51c2VySWQpKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWRkaW5nIGZ1bmN0aW9uOicsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG59XG4iXX0=