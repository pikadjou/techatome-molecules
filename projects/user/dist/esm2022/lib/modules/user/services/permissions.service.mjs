import { Injectable } from '@angular/core';
import { BehaviorSubject, filter, map } from 'rxjs';
import { Logger } from '@ta/server';
import { isNonNullable } from '@ta/utils';
import * as i0 from "@angular/core";
const accessLevels = ['reader', 'contributor', 'administrator'];
export class CamPermissionsService {
    get received() {
        return this._updated$.value !== null;
    }
    constructor() {
        this._updated$ = new BehaviorSubject(null);
        this._isFill = { permissions: false, isAuthenticated: false };
        this.features = [];
        this.guards = {};
        this.roles = [];
        this.isAuthenticated = false;
        this.updated$ = this._updated$.pipe(filter(isNonNullable));
    }
    set(info, isAuthenticated) {
        Logger.LogInfo('[PERMISSIONS] List brut:', info.permissions);
        this.features = info.features ?? [];
        this.roles = info.roles ?? [];
        this.guards = this.roles.reduce((acc, role) => {
            if (!role.includes('-')) {
                return acc;
            }
            const [domain, access] = role.split('-');
            const lastAccess = accessLevels.indexOf(access) > accessLevels.indexOf(acc[domain] || '') ? access : acc[domain];
            return {
                ...acc,
                [domain]: lastAccess,
            };
        }, {});
        Logger.LogInfo('[PERMISSIONS] Guard', this.guards);
        this._isFill.permissions = true;
        this.setSilentAuthenticated(isAuthenticated);
        this._canYouUpdate();
    }
    setSilentAuthenticated(isAuthenticated) {
        this.isAuthenticated = isAuthenticated;
        this._isFill.isAuthenticated = true;
        this._canYouUpdate();
    }
    setAuthenticated(isAuthenticated) {
        this.isAuthenticated = isAuthenticated;
        this._updated$.next(Date.now());
    }
    hasRole(role) {
        return this.roles.some(x => x === role);
    }
    canDirectAccess(feature, level) {
        if (level === 'authenticated') {
            return this.isAuthenticated;
        }
        if (level === 'authorize') {
            return this.features.includes(feature);
        }
        if (!feature) {
            return true;
        }
        const featureGuard = this.guards[feature];
        if (!featureGuard) {
            return true;
        }
        return accessLevels.indexOf(featureGuard) >= accessLevels.indexOf(level);
    }
    canAccess$(feature, level) {
        return this._updated$.pipe(map(() => this.canDirectAccess(feature, level)));
    }
    _canYouUpdate() {
        if (!this._isFill.isAuthenticated || !this._isFill.permissions) {
            return;
        }
        this._updated$.next(Date.now());
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy91c2VyL3NlcnZpY2VzL3Blcm1pc3Npb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sV0FBVyxDQUFDOztBQWtCMUMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxRQUFRLEVBQUUsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBS2hFLE1BQU0sT0FBTyxxQkFBcUI7SUFXaEMsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQUVEO1FBZFEsY0FBUyxHQUFHLElBQUksZUFBZSxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUNyRCxZQUFPLEdBQUcsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUUxRCxhQUFRLEdBQW1DLEVBQUUsQ0FBQztRQUM5QyxXQUFNLEdBQStCLEVBQUUsQ0FBQztRQUN4QyxVQUFLLEdBQWEsRUFBRSxDQUFDO1FBQ3JCLG9CQUFlLEdBQVksS0FBSyxDQUFDO1FBRWpDLGFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQU05QyxDQUFDO0lBRVQsR0FBRyxDQUNSLElBSUMsRUFDRCxlQUF3QjtRQUV4QixNQUFNLENBQUMsT0FBTyxDQUFDLDBCQUEwQixFQUFFLElBQUks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QUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVPLGFBQWE7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMvRCxPQUFPO1FBQ1QsQ0FBQztRQUNELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7K0dBakdVLHFCQUFxQjttSEFBckIscUJBQXFCLGNBRnBCLE1BQU07OzRGQUVQLHFCQUFxQjtrQkFIakMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIGZpbHRlciwgbWFwIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAdGEvc2VydmVyJztcclxuaW1wb3J0IHsgaXNOb25OdWxsYWJsZSB9IGZyb20gJ0B0YS91dGlscyc7XHJcblxyXG5leHBvcnQgdHlwZSBMZXZlbCA9ICdhdXRoZW50aWNhdGVkJyB8ICdhdXRob3JpemUnIHwgJ3JlYWRlcicgfCAnY29udHJpYnV0b3InIHwgJ2FkbWluaXN0cmF0b3InIHwgJ3JlYWQnO1xyXG5cclxuZXhwb3J0IHR5cGUgUGVybWlzc2lvbkZlYXR1cmUgPSAnY2hpZnQnIHwgJ3RpY2tldGluZyc7XHJcbmV4cG9ydCB0eXBlIERvbWFpbiA9XHJcbiAgfCAnYXV0b21hdGlvbidcclxuICB8ICdpbnZvaWNlJ1xyXG4gIHwgJ2NvbnRhY3QnXHJcbiAgfCAndGFzaydcclxuICB8ICdwcm9qZWN0J1xyXG4gIHwgJ3F1b3RhdGlvbidcclxuICB8ICdtYWludGVuYW5jZSdcclxuICB8ICdjb252ZXJzYXRpb24nXHJcbiAgfCAndXNlcidcclxuICB8ICdkb2N1bWVudCdcclxuICB8ICdvcmdhbml6YXRpb24nO1xyXG5cclxuY29uc3QgYWNjZXNzTGV2ZWxzID0gWydyZWFkZXInLCAnY29udHJpYnV0b3InLCAnYWRtaW5pc3RyYXRvciddO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIENhbVBlcm1pc3Npb25zU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBfdXBkYXRlZCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG51bWJlciB8IG51bGw+KG51bGwpO1xyXG4gIHByaXZhdGUgX2lzRmlsbCA9IHsgcGVybWlzc2lvbnM6IGZhbHNlLCBpc0F1dGhlbnRpY2F0ZWQ6IGZhbHNlIH07XHJcblxyXG4gIHB1YmxpYyBmZWF0dXJlczogKHN0cmluZyB8IFBlcm1pc3Npb25GZWF0dXJlKVtdID0gW107XHJcbiAgcHVibGljIGd1YXJkczogeyBbaW5kZXg6IHN0cmluZ106IExldmVsIH0gPSB7fTtcclxuICBwdWJsaWMgcm9sZXM6IHN0cmluZ1tdID0gW107XHJcbiAgcHVibGljIGlzQXV0aGVudGljYXRlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICBwdWJsaWMgdXBkYXRlZCQgPSB0aGlzLl91cGRhdGVkJC5waXBlKGZpbHRlcihpc05vbk51bGxhYmxlKSk7XHJcblxyXG4gIGdldCByZWNlaXZlZCgpIHtcclxuICAgIHJldHVybiB0aGlzLl91cGRhdGVkJC52YWx1ZSAhPT0gbnVsbDtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge31cclxuXHJcbiAgcHVibGljIHNldChcclxuICAgIGluZm86IHtcclxuICAgICAgcGVybWlzc2lvbnM6IHN0cmluZ1tdO1xyXG4gICAgICByb2xlczogc3RyaW5nW107XHJcbiAgICAgIGZlYXR1cmVzOiBQZXJtaXNzaW9uRmVhdHVyZVtdO1xyXG4gICAgfSxcclxuICAgIGlzQXV0aGVudGljYXRlZDogYm9vbGVhblxyXG4gICkge1xyXG4gICAgTG9nZ2VyLkxvZ0luZm8oJ1tQRVJNSVNTSU9OU10gTGlzdCBicnV0OicsIGluZm8ucGVybWlzc2lvbnMpO1xyXG5cclxuICAgIHRoaXMuZmVhdHVyZXMgPSBpbmZvLmZlYXR1cmVzID8/IFtdO1xyXG4gICAgdGhpcy5yb2xlcyA9IGluZm8ucm9sZXMgPz8gW107XHJcblxyXG4gICAgdGhpcy5ndWFyZHMgPSB0aGlzLnJvbGVzLnJlZHVjZTx0eXBlb2YgdGhpcy5ndWFyZHM+KChhY2MsIHJvbGUpID0+IHtcclxuICAgICAgaWYgKCFyb2xlLmluY2x1ZGVzKCctJykpIHtcclxuICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IFtkb21haW4sIGFjY2Vzc10gPSByb2xlLnNwbGl0KCctJyk7XHJcblxyXG4gICAgICBjb25zdCBsYXN0QWNjZXNzID0gYWNjZXNzTGV2ZWxzLmluZGV4T2YoYWNjZXNzKSA+IGFjY2Vzc0xldmVscy5pbmRleE9mKGFjY1tkb21haW5dIHx8ICcnKSA/IGFjY2VzcyA6IGFjY1tkb21haW5dO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLmFjYyxcclxuICAgICAgICBbZG9tYWluXTogPExldmVsPmxhc3RBY2Nlc3MsXHJcbiAgICAgIH07XHJcbiAgICB9LCB7fSk7XHJcbiAgICBMb2dnZXIuTG9nSW5mbygnW1BFUk1JU1NJT05TXSBHdWFyZCcsIHRoaXMuZ3VhcmRzKTtcclxuXHJcbiAgICB0aGlzLl9pc0ZpbGwucGVybWlzc2lvbnMgPSB0cnVlO1xyXG5cclxuICAgIHRoaXMuc2V0U2lsZW50QXV0aGVudGljYXRlZChpc0F1dGhlbnRpY2F0ZWQpO1xyXG5cclxuICAgIHRoaXMuX2NhbllvdVVwZGF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldFNpbGVudEF1dGhlbnRpY2F0ZWQoaXNBdXRoZW50aWNhdGVkOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLmlzQXV0aGVudGljYXRlZCA9IGlzQXV0aGVudGljYXRlZDtcclxuICAgIHRoaXMuX2lzRmlsbC5pc0F1dGhlbnRpY2F0ZWQgPSB0cnVlO1xyXG5cclxuICAgIHRoaXMuX2NhbllvdVVwZGF0ZSgpO1xyXG4gIH1cclxuICBwdWJsaWMgc2V0QXV0aGVudGljYXRlZChpc0F1dGhlbnRpY2F0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuaXNBdXRoZW50aWNhdGVkID0gaXNBdXRoZW50aWNhdGVkO1xyXG5cclxuICAgIHRoaXMuX3VwZGF0ZWQkLm5leHQoRGF0ZS5ub3coKSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFzUm9sZShyb2xlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLnJvbGVzLnNvbWUoeCA9PiB4ID09PSByb2xlKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBjYW5EaXJlY3RBY2Nlc3MoZmVhdHVyZTogUGVybWlzc2lvbkZlYXR1cmUgfCBEb21haW4gfCBzdHJpbmcsIGxldmVsOiBMZXZlbCB8IHN0cmluZykge1xyXG4gICAgaWYgKGxldmVsID09PSAnYXV0aGVudGljYXRlZCcpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaXNBdXRoZW50aWNhdGVkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChsZXZlbCA9PT0gJ2F1dGhvcml6ZScpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMuaW5jbHVkZXMoZmVhdHVyZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFmZWF0dXJlKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZlYXR1cmVHdWFyZCA9IHRoaXMuZ3VhcmRzW2ZlYXR1cmVdO1xyXG4gICAgaWYgKCFmZWF0dXJlR3VhcmQpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGFjY2Vzc0xldmVscy5pbmRleE9mKGZlYXR1cmVHdWFyZCkgPj0gYWNjZXNzTGV2ZWxzLmluZGV4T2YobGV2ZWwpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNhbkFjY2VzcyQoZmVhdHVyZTogc3RyaW5nIHwgUGVybWlzc2lvbkZlYXR1cmUsIGxldmVsOiBMZXZlbCB8IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZWQkLnBpcGUobWFwKCgpID0+IHRoaXMuY2FuRGlyZWN0QWNjZXNzKGZlYXR1cmUsIGxldmVsKSkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfY2FuWW91VXBkYXRlKCkge1xyXG4gICAgaWYgKCF0aGlzLl9pc0ZpbGwuaXNBdXRoZW50aWNhdGVkIHx8ICF0aGlzLl9pc0ZpbGwucGVybWlzc2lvbnMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fdXBkYXRlZCQubmV4dChEYXRlLm5vdygpKTtcclxuICB9XHJcbn1cclxuIl19