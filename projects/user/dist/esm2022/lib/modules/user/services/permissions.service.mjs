import { Injectable } from '@angular/core';
import { BehaviorSubject, filter, map } from 'rxjs';
import { Logger } from '@ta/server';
import { isNonNullable } from '@ta/utils';
import * as i0 from "@angular/core";
const accessLevels = ['reader', 'contributor', 'administrator'];
export class CamPermissionsService {
    get received() {
        return this._updated$.value !== null;
    }
    constructor() {
        this._updated$ = new BehaviorSubject(null);
        this._isFill = { permissions: false, isAuthenticated: false };
        this.features = [];
        this.guards = {};
        this.roles = [];
        this.isAuthenticated = false;
        this.updated$ = this._updated$.pipe(filter(isNonNullable));
    }
    set(info, isAuthenticated) {
        Logger.LogInfo('[PERMISSIONS] List brut:', info.permissions);
        this.features = info.features ?? [];
        this.roles = info.roles ?? [];
        this.guards = this.roles
            .map(role => role.replace('Merlin_', ''))
            .reduce((acc, role) => {
            if (!role.includes('-')) {
                return acc;
            }
            const [domain, access] = role.split('-');
            const lastAccess = accessLevels.indexOf(access) > accessLevels.indexOf(acc[domain] || '') ? access : acc[domain];
            return {
                ...acc,
                [domain]: lastAccess,
            };
        }, {});
        Logger.LogInfo('[PERMISSIONS] Guard', this.guards);
        this._isFill.permissions = true;
        this.setSilentAuthenticated(isAuthenticated);
        this._canYouUpdate();
    }
    setSilentAuthenticated(isAuthenticated) {
        this.isAuthenticated = isAuthenticated;
        this._isFill.isAuthenticated = true;
        this._canYouUpdate();
    }
    setAuthenticated(isAuthenticated) {
        this.isAuthenticated = isAuthenticated;
        this._updated$.next(Date.now());
    }
    hasRole(role) {
        return this.roles.some(x => x === role);
    }
    canDirectAccess(feature, level) {
        if (level === 'authenticated') {
            return this.isAuthenticated;
        }
        if (level === 'authorize') {
            return this.features.includes(feature);
        }
        if (!feature) {
            return true;
        }
        const featureGuard = this.guards[feature];
        if (!featureGuard) {
            return true;
        }
        return accessLevels.indexOf(featureGuard) >= accessLevels.indexOf(level);
    }
    canAccess$(feature, level) {
        return this._updated$.pipe(map(() => this.canDirectAccess(feature, level)));
    }
    _canYouUpdate() {
        if (!this._isFill.isAuthenticated || !this._isFill.permissions) {
            return;
        }
        this._updated$.next(Date.now());
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy91c2VyL3NlcnZpY2VzL3Blcm1pc3Npb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sV0FBVyxDQUFDOztBQWtCMUMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxRQUFRLEVBQUUsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBS2hFLE1BQU0sT0FBTyxxQkFBcUI7SUFXaEMsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQUVEO1FBZFEsY0FBUyxHQUFHLElBQUksZUFBZSxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUNyRCxZQUFPLEdBQUcsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUUxRCxhQUFRLEdBQW1DLEVBQUUsQ0FBQztRQUM5QyxXQUFNLEdBQStCLEVBQUUsQ0FBQztRQUN4QyxVQUFLLEdBQWEsRUFBRSxDQUFDO1FBQ3JCLG9CQUFlLEdBQVksS0FBSyxDQUFDO1FBRWpDLGFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQU05QyxDQUFDO0lBRVQsR0FBRyxDQUNSLElBSUMsRUFDRCxlQUF3QjtRQUV4QixNQUFNLENBQUMsT0FBTyxDQUFDLDBCQUEwQixFQUFFLElBQUks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RSxDQUFDO0lBRU0sVUFBVSxDQUFDLE9BQW1DLEVBQUUsS0FBcUI7UUFDMUUsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFTyxhQUFhO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDL0QsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNsQyxDQUFDOytHQXBHVSxxQkFBcUI7bUhBQXJCLHFCQUFxQixjQUZwQixNQUFNOzs0RkFFUCxxQkFBcUI7a0JBSGpDLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnQHRhL3NlcnZlcic7XHJcbmltcG9ydCB7IGlzTm9uTnVsbGFibGUgfSBmcm9tICdAdGEvdXRpbHMnO1xyXG5cclxuZXhwb3J0IHR5cGUgTGV2ZWwgPSAnYXV0aGVudGljYXRlZCcgfCAnYXV0aG9yaXplJyB8ICdyZWFkZXInIHwgJ2NvbnRyaWJ1dG9yJyB8ICdhZG1pbmlzdHJhdG9yJyB8ICdyZWFkJztcclxuXHJcbmV4cG9ydCB0eXBlIFBlcm1pc3Npb25GZWF0dXJlID0gJ2NoaWZ0JyB8ICd0aWNrZXRpbmcnO1xyXG5leHBvcnQgdHlwZSBEb21haW4gPVxyXG4gIHwgJ2F1dG9tYXRpb24nXHJcbiAgfCAnaW52b2ljZSdcclxuICB8ICdjb250YWN0J1xyXG4gIHwgJ3Rhc2snXHJcbiAgfCAncHJvamVjdCdcclxuICB8ICdxdW90YXRpb24nXHJcbiAgfCAnbWFpbnRlbmFuY2UnXHJcbiAgfCAnY29udmVyc2F0aW9uJ1xyXG4gIHwgJ3VzZXInXHJcbiAgfCAnZG9jdW1lbnQnXHJcbiAgfCAnb3JnYW5pemF0aW9uJztcclxuXHJcbmNvbnN0IGFjY2Vzc0xldmVscyA9IFsncmVhZGVyJywgJ2NvbnRyaWJ1dG9yJywgJ2FkbWluaXN0cmF0b3InXTtcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDYW1QZXJtaXNzaW9uc1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgX3VwZGF0ZWQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxudW1iZXIgfCBudWxsPihudWxsKTtcclxuICBwcml2YXRlIF9pc0ZpbGwgPSB7IHBlcm1pc3Npb25zOiBmYWxzZSwgaXNBdXRoZW50aWNhdGVkOiBmYWxzZSB9O1xyXG5cclxuICBwdWJsaWMgZmVhdHVyZXM6IChzdHJpbmcgfCBQZXJtaXNzaW9uRmVhdHVyZSlbXSA9IFtdO1xyXG4gIHB1YmxpYyBndWFyZHM6IHsgW2luZGV4OiBzdHJpbmddOiBMZXZlbCB9ID0ge307XHJcbiAgcHVibGljIHJvbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gIHB1YmxpYyBpc0F1dGhlbnRpY2F0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgcHVibGljIHVwZGF0ZWQkID0gdGhpcy5fdXBkYXRlZCQucGlwZShmaWx0ZXIoaXNOb25OdWxsYWJsZSkpO1xyXG5cclxuICBnZXQgcmVjZWl2ZWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fdXBkYXRlZCQudmFsdWUgIT09IG51bGw7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcigpIHt9XHJcblxyXG4gIHB1YmxpYyBzZXQoXHJcbiAgICBpbmZvOiB7XHJcbiAgICAgIHBlcm1pc3Npb25zOiBzdHJpbmdbXTtcclxuICAgICAgcm9sZXM6IHN0cmluZ1tdO1xyXG4gICAgICBmZWF0dXJlczogUGVybWlzc2lvbkZlYXR1cmVbXTtcclxuICAgIH0sXHJcbiAgICBpc0F1dGhlbnRpY2F0ZWQ6IGJvb2xlYW5cclxuICApIHtcclxuICAgIExvZ2dlci5Mb2dJbmZvKCdbUEVSTUlTU0lPTlNdIExpc3QgYnJ1dDonLCBpbmZvLnBlcm1pc3Npb25zKTtcclxuXHJcbiAgICB0aGlzLmZlYXR1cmVzID0gaW5mby5mZWF0dXJlcyA/PyBbXTtcclxuICAgIHRoaXMucm9sZXMgPSBpbmZvLnJvbGVzID8/IFtdO1xyXG5cclxuICAgIHRoaXMuZ3VhcmRzID0gdGhpcy5yb2xlc1xyXG4gICAgICAubWFwKHJvbGUgPT4gcm9sZS5yZXBsYWNlKCdNZXJsaW5fJywgJycpKVxyXG4gICAgICAucmVkdWNlPHR5cGVvZiB0aGlzLmd1YXJkcz4oKGFjYywgcm9sZSkgPT4ge1xyXG4gICAgICAgIGlmICghcm9sZS5pbmNsdWRlcygnLScpKSB7XHJcbiAgICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBbZG9tYWluLCBhY2Nlc3NdID0gcm9sZS5zcGxpdCgnLScpO1xyXG5cclxuICAgICAgICBjb25zdCBsYXN0QWNjZXNzID1cclxuICAgICAgICAgIGFjY2Vzc0xldmVscy5pbmRleE9mKGFjY2VzcykgPiBhY2Nlc3NMZXZlbHMuaW5kZXhPZihhY2NbZG9tYWluXSB8fCAnJykgPyBhY2Nlc3MgOiBhY2NbZG9tYWluXTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgLi4uYWNjLFxyXG4gICAgICAgICAgW2RvbWFpbl06IDxMZXZlbD5sYXN0QWNjZXNzLFxyXG4gICAgICAgIH07XHJcbiAgICAgIH0sIHt9KTtcclxuICAgIExvZ2dlci5Mb2dJbmZvKCdbUEVSTUlTU0lPTlNdIEd1YXJkJywgdGhpcy5ndWFyZHMpO1xyXG5cclxuICAgIHRoaXMuX2lzRmlsbC5wZXJtaXNzaW9ucyA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5zZXRTaWxlbnRBdXRoZW50aWNhdGVkKGlzQXV0aGVudGljYXRlZCk7XHJcblxyXG4gICAgdGhpcy5fY2FuWW91VXBkYXRlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0U2lsZW50QXV0aGVudGljYXRlZChpc0F1dGhlbnRpY2F0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuaXNBdXRoZW50aWNhdGVkID0gaXNBdXRoZW50aWNhdGVkO1xyXG4gICAgdGhpcy5faXNGaWxsLmlzQXV0aGVudGljYXRlZCA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5fY2FuWW91VXBkYXRlKCk7XHJcbiAgfVxyXG4gIHB1YmxpYyBzZXRBdXRoZW50aWNhdGVkKGlzQXV0aGVudGljYXRlZDogYm9vbGVhbikge1xyXG4gICAgdGhpcy5pc0F1dGhlbnRpY2F0ZWQgPSBpc0F1dGhlbnRpY2F0ZWQ7XHJcblxyXG4gICAgdGhpcy5fdXBkYXRlZCQubmV4dChEYXRlLm5vdygpKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBoYXNSb2xlKHJvbGU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMucm9sZXMuc29tZSh4ID0+IHggPT09IHJvbGUpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNhbkRpcmVjdEFjY2VzcyhmZWF0dXJlOiBQZXJtaXNzaW9uRmVhdHVyZSB8IERvbWFpbiB8IHN0cmluZywgbGV2ZWw6IExldmVsIHwgc3RyaW5nKSB7XHJcbiAgICBpZiAobGV2ZWwgPT09ICdhdXRoZW50aWNhdGVkJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5pc0F1dGhlbnRpY2F0ZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGxldmVsID09PSAnYXV0aG9yaXplJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcy5pbmNsdWRlcyhmZWF0dXJlKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWZlYXR1cmUpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmVhdHVyZUd1YXJkID0gdGhpcy5ndWFyZHNbZmVhdHVyZV07XHJcbiAgICBpZiAoIWZlYXR1cmVHdWFyZCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYWNjZXNzTGV2ZWxzLmluZGV4T2YoZmVhdHVyZUd1YXJkKSA+PSBhY2Nlc3NMZXZlbHMuaW5kZXhPZihsZXZlbCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgY2FuQWNjZXNzJChmZWF0dXJlOiBzdHJpbmcgfCBQZXJtaXNzaW9uRmVhdHVyZSwgbGV2ZWw6IExldmVsIHwgc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fdXBkYXRlZCQucGlwZShtYXAoKCkgPT4gdGhpcy5jYW5EaXJlY3RBY2Nlc3MoZmVhdHVyZSwgbGV2ZWwpKSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9jYW5Zb3VVcGRhdGUoKSB7XHJcbiAgICBpZiAoIXRoaXMuX2lzRmlsbC5pc0F1dGhlbnRpY2F0ZWQgfHwgIXRoaXMuX2lzRmlsbC5wZXJtaXNzaW9ucykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLl91cGRhdGVkJC5uZXh0KERhdGUubm93KCkpO1xyXG4gIH1cclxufVxyXG4iXX0=