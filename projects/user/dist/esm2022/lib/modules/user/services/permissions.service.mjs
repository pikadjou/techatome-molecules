import { Injectable } from '@angular/core';
import { Logger } from '@ta/server';
import { isNonNullable } from '@ta/utils';
import { BehaviorSubject, filter, map } from 'rxjs';
import { Permissions } from './permissions';
import * as i0 from "@angular/core";
const accessLevels = ['reader', 'contributor', 'administrator'];
export class CamPermissionsService {
    get received() {
        return this._updated$.value !== null;
    }
    constructor() {
        this._updated$ = new BehaviorSubject(null);
        this._isFill = { permissions: false, isAuthenticated: false };
        this.features = [];
        this.guards = {};
        this.roles = [];
        this.isAuthenticated = false;
        this.updated$ = this._updated$.pipe(filter(isNonNullable));
    }
    set(info, isAuthenticated) {
        Logger.LogInfo('[PERMISSIONS] List brut:', info.permissions);
        this.features = info.features || [];
        this.roles = info.roles || [];
        this.guards = info.roles
            .map(role => role.replace('Merlin_', ''))
            .reduce((acc, role) => {
            if (!role.includes('-')) {
                return acc;
            }
            const [domain, access] = role.split('-');
            const lastAccess = accessLevels.indexOf(access) > accessLevels.indexOf(acc[domain] || '') ? access : acc[domain];
            return {
                ...acc,
                [domain]: lastAccess,
            };
        }, {});
        Logger.LogInfo('[PERMISSIONS] Guard', this.guards);
        this._isFill.permissions = true;
        this.setSilentAuthenticated(isAuthenticated);
        Permissions.set(info, isAuthenticated);
        this._canYouUpdate();
    }
    setSilentAuthenticated(isAuthenticated) {
        this.isAuthenticated = isAuthenticated;
        this._isFill.isAuthenticated = true;
        Permissions.setSilentAuthenticated(isAuthenticated);
        this._canYouUpdate();
    }
    setAuthenticated(isAuthenticated) {
        this.isAuthenticated = isAuthenticated;
        Permissions.setAuthenticated(isAuthenticated);
        this._updated$.next(Date.now());
    }
    hasRole(role) {
        return this.roles.some(x => x === role);
    }
    canDirectAccess(feature, level) {
        if (level === 'authenticated') {
            return this.isAuthenticated;
        }
        if (level === 'authorize') {
            return this.features.includes(feature);
        }
        if (!feature) {
            return Permissions.canDirectAccess(feature, level);
        }
        const featureGuard = this.guards[feature];
        if (!featureGuard) {
            return Permissions.canDirectAccess(feature, level);
        }
        return accessLevels.indexOf(featureGuard) >= accessLevels.indexOf(level);
    }
    canAccess$(feature, level) {
        return this._updated$.pipe(map(() => this.canDirectAccess(feature, level)));
    }
    _canYouUpdate() {
        if (!this._isFill.isAuthenticated || !this._isFill.permissions) {
            return;
        }
        this._updated$.next(Date.now());
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamPermissionsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy91c2VyL3NlcnZpY2VzL3Blcm1pc3Npb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDMUMsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRWhFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7O0FBa0I1QyxNQUFNLFlBQVksR0FBRyxDQUFDLFFBQVEsRUFBRSxhQUFhLEVBQUUsZUFBZSxDQUFDLENBQUM7QUFLaEUsTUFBTSxPQUFPLHFCQUFxQjtJQVdoQyxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQztJQUN2QyxDQUFDO0lBRUQ7UUFkUSxjQUFTLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO1FBQ3JELFlBQU8sR0FBRyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxDQUFDO1FBRTFELGFBQVEsR0FBbUMsRUFBRSxDQUFDO1FBQzlDLFdBQU0sR0FBK0IsRUFBRSxDQUFDO1FBQ3hDLFVBQUssR0FBYSxFQUFFLENBQUM7UUFDckIsb0JBQWUsR0FBWSxLQUFLLENBQUM7UUFFakMsYUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0lBTTlDLENBQUM7SUFFVCxHQUFHLENBQ1IsSUFJQyxFQUNELGVBQXdCO1FB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QztRQUNyRCxDQUFDO1FBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDbEIsT0FBTyxXQUFXLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBRUQsT0FBTyxZQUFZLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVNLFVBQVUsQ0FBQyxPQUFtQyxFQUFFLEtBQXFCO1FBQzFFLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5RSxDQUFDO0lBRU8sYUFBYTtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQy9ELE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQzsrR0F4R1UscUJBQXFCO21IQUFyQixxQkFBcUIsY0FGcEIsTUFBTTs7NEZBRVAscUJBQXFCO2tCQUhqQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ0B0YS9zZXJ2ZXInO1xyXG5pbXBvcnQgeyBpc05vbk51bGxhYmxlIH0gZnJvbSAnQHRhL3V0aWxzJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tICcuL3Blcm1pc3Npb25zJztcclxuXHJcbmV4cG9ydCB0eXBlIExldmVsID0gJ2F1dGhlbnRpY2F0ZWQnIHwgJ2F1dGhvcml6ZScgfCAncmVhZGVyJyB8ICdjb250cmlidXRvcicgfCAnYWRtaW5pc3RyYXRvcicgfCAncmVhZCc7XHJcblxyXG5leHBvcnQgdHlwZSBQZXJtaXNzaW9uRmVhdHVyZSA9ICdjaGlmdCcgfCAndGlja2V0aW5nJztcclxuZXhwb3J0IHR5cGUgRG9tYWluID1cclxuICB8ICdhdXRvbWF0aW9uJ1xyXG4gIHwgJ2ludm9pY2UnXHJcbiAgfCAnY29udGFjdCdcclxuICB8ICd0YXNrJ1xyXG4gIHwgJ3Byb2plY3QnXHJcbiAgfCAncXVvdGF0aW9uJ1xyXG4gIHwgJ21haW50ZW5hbmNlJ1xyXG4gIHwgJ2NvbnZlcnNhdGlvbidcclxuICB8ICd1c2VyJ1xyXG4gIHwgJ2RvY3VtZW50J1xyXG4gIHwgJ29yZ2FuaXphdGlvbic7XHJcblxyXG5jb25zdCBhY2Nlc3NMZXZlbHMgPSBbJ3JlYWRlcicsICdjb250cmlidXRvcicsICdhZG1pbmlzdHJhdG9yJ107XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2FtUGVybWlzc2lvbnNTZXJ2aWNlIHtcclxuICBwcml2YXRlIF91cGRhdGVkJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8bnVtYmVyIHwgbnVsbD4obnVsbCk7XHJcbiAgcHJpdmF0ZSBfaXNGaWxsID0geyBwZXJtaXNzaW9uczogZmFsc2UsIGlzQXV0aGVudGljYXRlZDogZmFsc2UgfTtcclxuXHJcbiAgcHVibGljIGZlYXR1cmVzOiAoc3RyaW5nIHwgUGVybWlzc2lvbkZlYXR1cmUpW10gPSBbXTtcclxuICBwdWJsaWMgZ3VhcmRzOiB7IFtpbmRleDogc3RyaW5nXTogTGV2ZWwgfSA9IHt9O1xyXG4gIHB1YmxpYyByb2xlczogc3RyaW5nW10gPSBbXTtcclxuICBwdWJsaWMgaXNBdXRoZW50aWNhdGVkOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gIHB1YmxpYyB1cGRhdGVkJCA9IHRoaXMuX3VwZGF0ZWQkLnBpcGUoZmlsdGVyKGlzTm9uTnVsbGFibGUpKTtcclxuXHJcbiAgZ2V0IHJlY2VpdmVkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZWQkLnZhbHVlICE9PSBudWxsO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoKSB7fVxyXG5cclxuICBwdWJsaWMgc2V0KFxyXG4gICAgaW5mbzoge1xyXG4gICAgICBwZXJtaXNzaW9uczogc3RyaW5nW107XHJcbiAgICAgIHJvbGVzOiBzdHJpbmdbXTtcclxuICAgICAgZmVhdHVyZXM6IFBlcm1pc3Npb25GZWF0dXJlW107XHJcbiAgICB9LFxyXG4gICAgaXNBdXRoZW50aWNhdGVkOiBib29sZWFuXHJcbiAgKSB7XHJcbiAgICBMb2dnZXIuTG9nSW5mbygnW1BFUk1JU1NJT05TXSBMaXN0IGJydXQ6JywgaW5mby5wZXJtaXNzaW9ucyk7XHJcblxyXG4gICAgdGhpcy5mZWF0dXJlcyA9IGluZm8uZmVhdHVyZXMgfHwgW107XHJcbiAgICB0aGlzLnJvbGVzID0gaW5mby5yb2xlcyB8fCBbXTtcclxuXHJcbiAgICB0aGlzLmd1YXJkcyA9IGluZm8ucm9sZXNcclxuICAgICAgLm1hcChyb2xlID0+IHJvbGUucmVwbGFjZSgnTWVybGluXycsICcnKSlcclxuICAgICAgLnJlZHVjZTx0eXBlb2YgdGhpcy5ndWFyZHM+KChhY2MsIHJvbGUpID0+IHtcclxuICAgICAgICBpZiAoIXJvbGUuaW5jbHVkZXMoJy0nKSkge1xyXG4gICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgW2RvbWFpbiwgYWNjZXNzXSA9IHJvbGUuc3BsaXQoJy0nKTtcclxuXHJcbiAgICAgICAgY29uc3QgbGFzdEFjY2VzcyA9XHJcbiAgICAgICAgICBhY2Nlc3NMZXZlbHMuaW5kZXhPZihhY2Nlc3MpID4gYWNjZXNzTGV2ZWxzLmluZGV4T2YoYWNjW2RvbWFpbl0gfHwgJycpID8gYWNjZXNzIDogYWNjW2RvbWFpbl07XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIC4uLmFjYyxcclxuICAgICAgICAgIFtkb21haW5dOiA8TGV2ZWw+bGFzdEFjY2VzcyxcclxuICAgICAgICB9O1xyXG4gICAgICB9LCB7fSk7XHJcbiAgICBMb2dnZXIuTG9nSW5mbygnW1BFUk1JU1NJT05TXSBHdWFyZCcsIHRoaXMuZ3VhcmRzKTtcclxuXHJcbiAgICB0aGlzLl9pc0ZpbGwucGVybWlzc2lvbnMgPSB0cnVlO1xyXG5cclxuICAgIHRoaXMuc2V0U2lsZW50QXV0aGVudGljYXRlZChpc0F1dGhlbnRpY2F0ZWQpO1xyXG4gICAgUGVybWlzc2lvbnMuc2V0KGluZm8sIGlzQXV0aGVudGljYXRlZCk7XHJcblxyXG4gICAgdGhpcy5fY2FuWW91VXBkYXRlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0U2lsZW50QXV0aGVudGljYXRlZChpc0F1dGhlbnRpY2F0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuaXNBdXRoZW50aWNhdGVkID0gaXNBdXRoZW50aWNhdGVkO1xyXG4gICAgdGhpcy5faXNGaWxsLmlzQXV0aGVudGljYXRlZCA9IHRydWU7XHJcbiAgICBQZXJtaXNzaW9ucy5zZXRTaWxlbnRBdXRoZW50aWNhdGVkKGlzQXV0aGVudGljYXRlZCk7XHJcblxyXG4gICAgdGhpcy5fY2FuWW91VXBkYXRlKCk7XHJcbiAgfVxyXG4gIHB1YmxpYyBzZXRBdXRoZW50aWNhdGVkKGlzQXV0aGVudGljYXRlZDogYm9vbGVhbikge1xyXG4gICAgdGhpcy5pc0F1dGhlbnRpY2F0ZWQgPSBpc0F1dGhlbnRpY2F0ZWQ7XHJcblxyXG4gICAgUGVybWlzc2lvbnMuc2V0QXV0aGVudGljYXRlZChpc0F1dGhlbnRpY2F0ZWQpO1xyXG5cclxuICAgIHRoaXMuX3VwZGF0ZWQkLm5leHQoRGF0ZS5ub3coKSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFzUm9sZShyb2xlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLnJvbGVzLnNvbWUoeCA9PiB4ID09PSByb2xlKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBjYW5EaXJlY3RBY2Nlc3MoZmVhdHVyZTogUGVybWlzc2lvbkZlYXR1cmUgfCBEb21haW4gfCBzdHJpbmcsIGxldmVsOiBMZXZlbCB8IHN0cmluZykge1xyXG4gICAgaWYgKGxldmVsID09PSAnYXV0aGVudGljYXRlZCcpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaXNBdXRoZW50aWNhdGVkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChsZXZlbCA9PT0gJ2F1dGhvcml6ZScpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMuaW5jbHVkZXMoZmVhdHVyZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFmZWF0dXJlKSB7XHJcbiAgICAgIHJldHVybiBQZXJtaXNzaW9ucy5jYW5EaXJlY3RBY2Nlc3MoZmVhdHVyZSwgbGV2ZWwpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZlYXR1cmVHdWFyZCA9IHRoaXMuZ3VhcmRzW2ZlYXR1cmVdO1xyXG4gICAgaWYgKCFmZWF0dXJlR3VhcmQpIHtcclxuICAgICAgcmV0dXJuIFBlcm1pc3Npb25zLmNhbkRpcmVjdEFjY2VzcyhmZWF0dXJlLCBsZXZlbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGFjY2Vzc0xldmVscy5pbmRleE9mKGZlYXR1cmVHdWFyZCkgPj0gYWNjZXNzTGV2ZWxzLmluZGV4T2YobGV2ZWwpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNhbkFjY2VzcyQoZmVhdHVyZTogc3RyaW5nIHwgUGVybWlzc2lvbkZlYXR1cmUsIGxldmVsOiBMZXZlbCB8IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZWQkLnBpcGUobWFwKCgpID0+IHRoaXMuY2FuRGlyZWN0QWNjZXNzKGZlYXR1cmUsIGxldmVsKSkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfY2FuWW91VXBkYXRlKCkge1xyXG4gICAgaWYgKCF0aGlzLl9pc0ZpbGwuaXNBdXRoZW50aWNhdGVkIHx8ICF0aGlzLl9pc0ZpbGwucGVybWlzc2lvbnMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fdXBkYXRlZCQubmV4dChEYXRlLm5vdygpKTtcclxuICB9XHJcbn1cclxuIl19