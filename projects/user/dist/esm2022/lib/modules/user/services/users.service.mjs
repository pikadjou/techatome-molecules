import { Injectable } from '@angular/core';
import { catchError, filter, map, of, switchMap, tap } from 'rxjs';
import { CamBaseService, HandleComplexRequest, HandleSimpleRequest } from '@ta/server';
import { isNonNullable } from '@ta/utils';
import { functionProps } from './users/dto/function';
import { userProps } from './users/dto/user';
import { ADD_USER, DISABLE_CURRENT_USER, DISABLE_USER, UPDATE_CURRENT_USER } from './users/userMutations';
import { GET_CONTACT_TENANT_ROUTE, GET_CURRENT_USER, GET_MY_CONTACTS, GET_SEARCH_USERS_CUSTOMERS, GET_USERS, GET_USER_BY_ID, } from './users/userQueries';
import * as i0 from "@angular/core";
export const cachedQueryName = {
    currentUser: 'currentUser',
};
const graphEndpoint = {
    clientName: 'userService',
    endpoint: 'user',
};
export class TaUsersService extends CamBaseService {
    constructor() {
        super();
        this.users = new HandleSimpleRequest();
        this.usersCustomers = new HandleSimpleRequest();
        this.userById = new HandleComplexRequest();
        this.user = new HandleComplexRequest();
        this.currentUser = new HandleSimpleRequest();
        this.currentUserContactIds = new HandleSimpleRequest();
        this.contactTenantRoute = new HandleSimpleRequest();
        super.registerRoutes({ graphEndpoint: graphEndpoint });
    }
    fetchUsers$() {
        return this.users.fetch(this._graphService
            .fetchPagedQueryList(GET_USERS('', `
              ${userProps.get('id')}
              ${userProps.get('userName')}
              ${userProps.get('firstName')}
              ${userProps.get('lastName')}
              ${userProps.get('phoneNumber')}
              ${userProps.get('functions')} {
                ${functionProps.get('id')}
                ${functionProps.get('name')}
              }
              ${userProps.get('culture')}
              ${userProps.get('trigram')}
              ${userProps.get('picture')}
              
            `, `order: { lastName: ASC }`), 'users', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? [])));
    }
    fetchContactTenantRoute$(contactId) {
        return this.contactTenantRoute.fetch(this._graphService
            .fetchQuery(GET_CONTACT_TENANT_ROUTE(contactId), 'contactTenantRoute', graphEndpoint.clientName)
            .pipe(filter(isNonNullable)));
    }
    fetchUsersByIds$(ids) {
        return this.users.fetch(this._graphService
            .fetchPagedQueryList(GET_USERS(`where: { id: { in: [${ids.map(id => `"${id}"`).join(', ')}] } }`, `
              ${userProps.get('id')}
              ${userProps.get('userName')}
              ${userProps.get('firstName')}
              ${userProps.get('lastName')}
              ${userProps.get('picture')}
              ${userProps.get('trigram')}
            `, `order: { lastName: ASC }`), 'users', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? [])));
    }
    fetchUser$(id) {
        return this.user.fetch(id, this._graphService.fetchQuery(GET_USER_BY_ID(id), 'userById', graphEndpoint.clientName));
    }
    fetchCurrentUser$() {
        return this.currentUser.fetch(this._graphService.fetchQuery(GET_CURRENT_USER(), cachedQueryName.currentUser, graphEndpoint.clientName));
    }
    fetchCurrentUserContactIds$() {
        return this.currentUserContactIds
            .fetch(this._graphService
            .fetchQueryList(GET_MY_CONTACTS(), 'myContacts', graphEndpoint.clientName)
            .pipe(map(data => data ?? [])))
            .pipe(tap(() => {
            this._graphService.contactsLoaded$.next(true);
        }));
    }
    fetchUsersCustomers$(search) {
        if (!search || search.length < 3) {
            return of([]);
        }
        return this._graphService
            .fetchPagedQueryList(GET_SEARCH_USERS_CUSTOMERS(search, `
              ${userProps.get('id')}
              ${userProps.get('picture')}
              ${userProps.get('trigram')}
              ${userProps.get('firstName')}
              ${userProps.get('lastName')}
              ${userProps.get('userName')}
            `), 'searchUsersCustomers', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? []), tap(list => list.forEach(element => {
            this.userById.add(element.id, element);
        })));
    }
    addUser$(userAddedPayload) {
        return this._graphService.mutate(ADD_USER(userAddedPayload), 'users', graphEndpoint.clientName).pipe(filter(isNonNullable), switchMap(() => this.fetchUsers$()), catchError(error => {
            console.error('Error adding user:', error);
            return of(null);
        }));
    }
    disableUser$(userId) {
        return this._graphService.mutate(DISABLE_USER(userId), 'users', graphEndpoint.clientName).pipe(switchMap(() => this.fetchUser$(userId)), catchError(error => {
            console.error('Error disabling user:', error);
            return of(null);
        }));
    }
    disableCurrentUser$() {
        return this._graphService.mutate(DISABLE_CURRENT_USER(), 'users', graphEndpoint.clientName).pipe(switchMap(() => this.fetchCurrentUser$()), catchError(error => {
            console.error('Error disabling user:', error);
            return of(null);
        }));
    }
    updateCurrentUser$(user) {
        return this._graphService
            .mutate(UPDATE_CURRENT_USER(user), 'users', graphEndpoint.clientName, [cachedQueryName.currentUser])
            .pipe(switchMap(() => this.fetchCurrentUser$()), catchError(error => {
            console.error('Error updating user:', error);
            return of(null);
        }));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaUsersService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaUsersService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaUsersService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlcnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy91c2VyL3NlcnZpY2VzL3VzZXJzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0UsT0FBTyxFQUFFLGNBQWMsRUFBaUIsb0JBQW9CLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEcsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUcxQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFckQsT0FBTyxFQUFRLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRW5ELE9BQU8sRUFBRSxRQUFRLEVBQUUsb0JBQW9CLEVBQUUsWUFBWSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUcsT0FBTyxFQUNMLHdCQUF3QixFQUN4QixnQkFBZ0IsRUFDaEIsZUFBZSxFQUNmLDBCQUEwQixFQUMxQixTQUFTLEVBQ1QsY0FBYyxHQUNmLE1BQU0scUJBQXFCLENBQUM7O0FBRTdCLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRztJQUM3QixXQUFXLEVBQUUsYUFBYTtDQUMzQixDQUFDO0FBQ0YsTUFBTSxhQUFhLEdBQWtCO0lBQ25DLFVBQVUsRUFBRSxhQUFhO0lBQ3pCLFFBQVEsRUFBRSxNQUFNO0NBQ2pCLENBQUM7QUFLRixNQUFNLE9BQU8sY0FBZSxTQUFRLGNBQWM7SUFXaEQ7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQVhILFVBQUssR0FBRyxJQUFJLG1CQUFtQixFQUFVLENBQUM7UUFDMUMsbUJB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SSxDQUFDLGlCQUFpQixFQUFFLENBQUMsRUFDekMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7K0dBdExVLGNBQWM7bUhBQWQsY0FBYyxjQUZiLE1BQU07OzRGQUVQLGNBQWM7a0JBSDFCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBjYXRjaEVycm9yLCBmaWx0ZXIsIG1hcCwgb2YsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IENhbUJhc2VTZXJ2aWNlLCBHcmFwaEVuZHBvaW50LCBIYW5kbGVDb21wbGV4UmVxdWVzdCwgSGFuZGxlU2ltcGxlUmVxdWVzdCB9IGZyb20gJ0B0YS9zZXJ2ZXInO1xuaW1wb3J0IHsgaXNOb25OdWxsYWJsZSB9IGZyb20gJ0B0YS91dGlscyc7XG5cbmltcG9ydCB7IEN1cnJlbnRVc2VyIH0gZnJvbSAnLi91c2Vycy9kdG8vY3VycmVudFVzZXInO1xuaW1wb3J0IHsgZnVuY3Rpb25Qcm9wcyB9IGZyb20gJy4vdXNlcnMvZHRvL2Z1bmN0aW9uJztcbmltcG9ydCB7IE1vZGlmeVVzZXJQYXlsb2FkSW5wdXQgfSBmcm9tICcuL3VzZXJzL2R0by9tb2RpZnlVc2VyUGF5bG9hZElucHV0JztcbmltcG9ydCB7IFVzZXIsIHVzZXJQcm9wcyB9IGZyb20gJy4vdXNlcnMvZHRvL3VzZXInO1xuaW1wb3J0IHsgVXNlckFkZGVkUGF5bG9hZCB9IGZyb20gJy4vdXNlcnMvZHRvL3VzZXJBZGRlZFBheWxvYWQnO1xuaW1wb3J0IHsgQUREX1VTRVIsIERJU0FCTEVfQ1VSUkVOVF9VU0VSLCBESVNBQkxFX1VTRVIsIFVQREFURV9DVVJSRU5UX1VTRVIgfSBmcm9tICcuL3VzZXJzL3VzZXJNdXRhdGlvbnMnO1xuaW1wb3J0IHtcbiAgR0VUX0NPTlRBQ1RfVEVOQU5UX1JPVVRFLFxuICBHRVRfQ1VSUkVOVF9VU0VSLFxuICBHRVRfTVlfQ09OVEFDVFMsXG4gIEdFVF9TRUFSQ0hfVVNFUlNfQ1VTVE9NRVJTLFxuICBHRVRfVVNFUlMsXG4gIEdFVF9VU0VSX0JZX0lELFxufSBmcm9tICcuL3VzZXJzL3VzZXJRdWVyaWVzJztcblxuZXhwb3J0IGNvbnN0IGNhY2hlZFF1ZXJ5TmFtZSA9IHtcbiAgY3VycmVudFVzZXI6ICdjdXJyZW50VXNlcicsXG59O1xuY29uc3QgZ3JhcGhFbmRwb2ludDogR3JhcGhFbmRwb2ludCA9IHtcbiAgY2xpZW50TmFtZTogJ3VzZXJTZXJ2aWNlJyxcbiAgZW5kcG9pbnQ6ICd1c2VyJyxcbn07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBUYVVzZXJzU2VydmljZSBleHRlbmRzIENhbUJhc2VTZXJ2aWNlIHtcbiAgcHVibGljIHVzZXJzID0gbmV3IEhhbmRsZVNpbXBsZVJlcXVlc3Q8VXNlcltdPigpO1xuICBwdWJsaWMgdXNlcnNDdXN0b21lcnMgPSBuZXcgSGFuZGxlU2ltcGxlUmVxdWVzdDxVc2VyW10+KCk7XG5cbiAgcHVibGljIHVzZXJCeUlkID0gbmV3IEhhbmRsZUNvbXBsZXhSZXF1ZXN0PFVzZXI+KCk7XG4gIHB1YmxpYyB1c2VyID0gbmV3IEhhbmRsZUNvbXBsZXhSZXF1ZXN0PFVzZXI+KCk7XG4gIHB1YmxpYyBjdXJyZW50VXNlciA9IG5ldyBIYW5kbGVTaW1wbGVSZXF1ZXN0PFVzZXI+KCk7XG4gIHB1YmxpYyBjdXJyZW50VXNlckNvbnRhY3RJZHMgPSBuZXcgSGFuZGxlU2ltcGxlUmVxdWVzdDxzdHJpbmdbXT4oKTtcblxuICBwdWJsaWMgY29udGFjdFRlbmFudFJvdXRlID0gbmV3IEhhbmRsZVNpbXBsZVJlcXVlc3Q8c3RyaW5nPigpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgc3VwZXIucmVnaXN0ZXJSb3V0ZXMoeyBncmFwaEVuZHBvaW50OiBncmFwaEVuZHBvaW50IH0pO1xuICB9XG5cbiAgcHVibGljIGZldGNoVXNlcnMkKCkge1xuICAgIHJldHVybiB0aGlzLnVzZXJzLmZldGNoKFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PFVzZXI+KFxuICAgICAgICAgIEdFVF9VU0VSUyhcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgYFxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2lkJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgndXNlck5hbWUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdmaXJzdE5hbWUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdsYXN0TmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3Bob25lTnVtYmVyJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgnZnVuY3Rpb25zJyl9IHtcbiAgICAgICAgICAgICAgICAke2Z1bmN0aW9uUHJvcHMuZ2V0KCdpZCcpfVxuICAgICAgICAgICAgICAgICR7ZnVuY3Rpb25Qcm9wcy5nZXQoJ25hbWUnKX1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2N1bHR1cmUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCd0cmlncmFtJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgncGljdHVyZScpfVxuICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGAsXG4gICAgICAgICAgICBgb3JkZXI6IHsgbGFzdE5hbWU6IEFTQyB9YFxuICAgICAgICAgICksXG4gICAgICAgICAgJ3VzZXJzJyxcbiAgICAgICAgICBncmFwaEVuZHBvaW50LmNsaWVudE5hbWVcbiAgICAgICAgKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSlcbiAgICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hDb250YWN0VGVuYW50Um91dGUkKGNvbnRhY3RJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udGFjdFRlbmFudFJvdXRlLmZldGNoKFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFF1ZXJ5PHN0cmluZz4oR0VUX0NPTlRBQ1RfVEVOQU5UX1JPVVRFKGNvbnRhY3RJZCksICdjb250YWN0VGVuYW50Um91dGUnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpXG4gICAgICAgIC5waXBlKGZpbHRlcihpc05vbk51bGxhYmxlKSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGZldGNoVXNlcnNCeUlkcyQoaWRzOiBzdHJpbmdbXSkge1xuICAgIHJldHVybiB0aGlzLnVzZXJzLmZldGNoKFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PFVzZXI+KFxuICAgICAgICAgIEdFVF9VU0VSUyhcbiAgICAgICAgICAgIGB3aGVyZTogeyBpZDogeyBpbjogWyR7aWRzLm1hcChpZCA9PiBgXCIke2lkfVwiYCkuam9pbignLCAnKX1dIH0gfWAsXG4gICAgICAgICAgICBgXG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgnaWQnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCd1c2VyTmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2ZpcnN0TmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2xhc3ROYW1lJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgncGljdHVyZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3RyaWdyYW0nKX1cbiAgICAgICAgICAgIGAsXG4gICAgICAgICAgICBgb3JkZXI6IHsgbGFzdE5hbWU6IEFTQyB9YFxuICAgICAgICAgICksXG4gICAgICAgICAgJ3VzZXJzJyxcbiAgICAgICAgICBncmFwaEVuZHBvaW50LmNsaWVudE5hbWVcbiAgICAgICAgKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSlcbiAgICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hVc2VyJChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlci5mZXRjaChcbiAgICAgIGlkLFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlLmZldGNoUXVlcnk8VXNlcj4oR0VUX1VTRVJfQllfSUQoaWQpLCAndXNlckJ5SWQnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaEN1cnJlbnRVc2VyJCgpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50VXNlci5mZXRjaChcbiAgICAgIHRoaXMuX2dyYXBoU2VydmljZS5mZXRjaFF1ZXJ5PFVzZXI+KEdFVF9DVVJSRU5UX1VTRVIoKSwgY2FjaGVkUXVlcnlOYW1lLmN1cnJlbnRVc2VyLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaEN1cnJlbnRVc2VyQ29udGFjdElkcyQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFVzZXJDb250YWN0SWRzXG4gICAgICAuZmV0Y2goXG4gICAgICAgIHRoaXMuX2dyYXBoU2VydmljZVxuICAgICAgICAgIC5mZXRjaFF1ZXJ5TGlzdDxzdHJpbmc+KEdFVF9NWV9DT05UQUNUUygpLCAnbXlDb250YWN0cycsIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSlcbiAgICAgICAgICAucGlwZShtYXAoZGF0YSA9PiBkYXRhID8/IFtdKSlcbiAgICAgIClcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX2dyYXBoU2VydmljZS5jb250YWN0c0xvYWRlZCQubmV4dCh0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hVc2Vyc0N1c3RvbWVycyQoc2VhcmNoPzogc3RyaW5nKSB7XG4gICAgaWYgKCFzZWFyY2ggfHwgc2VhcmNoLmxlbmd0aCA8IDMpIHtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9ncmFwaFNlcnZpY2VcbiAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PFVzZXI+KFxuICAgICAgICBHRVRfU0VBUkNIX1VTRVJTX0NVU1RPTUVSUyhcbiAgICAgICAgICBzZWFyY2gsXG4gICAgICAgICAgYFxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2lkJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgncGljdHVyZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3RyaWdyYW0nKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdmaXJzdE5hbWUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdsYXN0TmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3VzZXJOYW1lJyl9XG4gICAgICAgICAgICBgXG4gICAgICAgICksXG4gICAgICAgICdzZWFyY2hVc2Vyc0N1c3RvbWVycycsXG4gICAgICAgIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZVxuICAgICAgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcihpc05vbk51bGxhYmxlKSxcbiAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSksXG4gICAgICAgIHRhcChsaXN0ID0+XG4gICAgICAgICAgbGlzdC5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy51c2VyQnlJZC5hZGQoZWxlbWVudC5pZCwgZWxlbWVudCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRVc2VyJCh1c2VyQWRkZWRQYXlsb2FkOiBVc2VyQWRkZWRQYXlsb2FkKTogT2JzZXJ2YWJsZTxVc2VyW10gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZS5tdXRhdGU8VXNlcj4oQUREX1VTRVIodXNlckFkZGVkUGF5bG9hZCksICd1c2VycycsIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSkucGlwZShcbiAgICAgIGZpbHRlcihpc05vbk51bGxhYmxlKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmZldGNoVXNlcnMkKCkpLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFkZGluZyB1c2VyOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGRpc2FibGVVc2VyJCh1c2VySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9ncmFwaFNlcnZpY2UubXV0YXRlPGJvb2xlYW4+KERJU0FCTEVfVVNFUih1c2VySWQpLCAndXNlcnMnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5mZXRjaFVzZXIkKHVzZXJJZCkpLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRpc2FibGluZyB1c2VyOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGRpc2FibGVDdXJyZW50VXNlciQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZS5tdXRhdGU8Ym9vbGVhbj4oRElTQUJMRV9DVVJSRU5UX1VTRVIoKSwgJ3VzZXJzJywgZ3JhcGhFbmRwb2ludC5jbGllbnROYW1lKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZmV0Y2hDdXJyZW50VXNlciQoKSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZGlzYWJsaW5nIHVzZXI6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQ3VycmVudFVzZXIkKHVzZXI6IE1vZGlmeVVzZXJQYXlsb2FkSW5wdXQpIHtcbiAgICByZXR1cm4gdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAubXV0YXRlPEN1cnJlbnRVc2VyPihVUERBVEVfQ1VSUkVOVF9VU0VSKHVzZXIpLCAndXNlcnMnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUsIFtjYWNoZWRRdWVyeU5hbWUuY3VycmVudFVzZXJdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmZldGNoQ3VycmVudFVzZXIkKCkpLFxuICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciB1cGRhdGluZyB1c2VyOicsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG59XG4iXX0=