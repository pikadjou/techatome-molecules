import { Injectable } from '@angular/core';
import { CamBaseService, HandleComplexRequest, HandleSimpleRequest } from '@ta/server';
import { isNonNullable } from '@ta/utils';
import { catchError, filter, map, of, switchMap, tap } from 'rxjs';
import { functionProps } from './users/dto/function';
import { userProps } from './users/dto/user';
import { ADD_USER, DISABLE_CURRENT_USER, DISABLE_USER, UPDATE_CURRENT_USER } from './users/userMutations';
import { GET_CONTACT_TENANT_ROUTE, GET_CURRENT_USER, GET_MY_CONTACTS, GET_SEARCH_USERS_CUSTOMERS, GET_USERS, GET_USER_BY_ID, } from './users/userQueries';
import * as i0 from "@angular/core";
export const cachedQueryName = {
    currentUser: 'currentUser',
};
const graphEndpoint = {
    clientName: 'userService',
    endpoint: 'user',
};
export class CamUsersService extends CamBaseService {
    constructor() {
        super();
        this.users = new HandleSimpleRequest();
        this.usersCustomers = new HandleSimpleRequest();
        this.userById = new HandleComplexRequest();
        this.user = new HandleComplexRequest();
        this.currentUser = new HandleSimpleRequest();
        this.currentUserContactIds = new HandleSimpleRequest();
        this.contactTenantRoute = new HandleSimpleRequest();
        super.registerRoutes({ graphEndpoint: graphEndpoint });
    }
    fetchUsers$() {
        return this.users.fetch(this._graphService
            .fetchPagedQueryList(GET_USERS('', `
              ${userProps.get('id')}
              ${userProps.get('userName')}
              ${userProps.get('firstName')}
              ${userProps.get('lastName')}
              ${userProps.get('phoneNumber')}
              ${userProps.get('functions')} {
                ${functionProps.get('id')}
                ${functionProps.get('name')}
              }
              ${userProps.get('culture')}
              ${userProps.get('trigram')}
              ${userProps.get('picture')}
              
            `, `order: { lastName: ASC }`), 'users', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? [])));
    }
    fetchContactTenantRoute$(contactId) {
        return this.contactTenantRoute.fetch(this._graphService
            .fetchQuery(GET_CONTACT_TENANT_ROUTE(contactId), 'contactTenantRoute', graphEndpoint.clientName)
            .pipe(filter(isNonNullable)));
    }
    fetchUsersByIds$(ids) {
        return this.users.fetch(this._graphService
            .fetchPagedQueryList(GET_USERS(`where: { id: { in: [${ids.map(id => `"${id}"`).join(', ')}] } }`, `
              ${userProps.get('id')}
              ${userProps.get('userName')}
              ${userProps.get('firstName')}
              ${userProps.get('lastName')}
              ${userProps.get('picture')}
              ${userProps.get('trigram')}
            `, `order: { lastName: ASC }`), 'users', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? [])));
    }
    fetchUser$(id) {
        return this.user.fetch(id, this._graphService.fetchQuery(GET_USER_BY_ID(id), 'userById', graphEndpoint.clientName));
    }
    fetchCurrentUser$() {
        return this.currentUser.fetch(this._graphService.fetchQuery(GET_CURRENT_USER(), cachedQueryName.currentUser, graphEndpoint.clientName));
    }
    fetchCurrentUserContactIds$() {
        return this.currentUserContactIds
            .fetch(this._graphService
            .fetchQueryList(GET_MY_CONTACTS(), 'myContacts', graphEndpoint.clientName)
            .pipe(map(data => data ?? [])))
            .pipe(tap(() => {
            this._graphService.contactsLoaded$.next(true);
        }));
    }
    fetchUsersCustomers$(search) {
        if (!search || search.length < 3) {
            return of([]);
        }
        return this._graphService
            .fetchPagedQueryList(GET_SEARCH_USERS_CUSTOMERS(search, `
              ${userProps.get('id')}
              ${userProps.get('picture')}
              ${userProps.get('trigram')}
              ${userProps.get('firstName')}
              ${userProps.get('lastName')}
              ${userProps.get('userName')}
            `), 'searchUsersCustomers', graphEndpoint.clientName)
            .pipe(filter(isNonNullable), map(data => data.items ?? []), tap(list => list.forEach(element => {
            this.userById.add(element.id, element);
        })));
    }
    addUser$(userAddedPayload) {
        return this._graphService.mutate(ADD_USER(userAddedPayload), 'users', graphEndpoint.clientName).pipe(filter(isNonNullable), switchMap(() => this.fetchUsers$()), catchError(error => {
            console.error('Error adding user:', error);
            return of(null);
        }));
    }
    disableUser$(userId) {
        return this._graphService.mutate(DISABLE_USER(userId), 'users', graphEndpoint.clientName).pipe(switchMap(() => this.fetchUser$(userId)), catchError(error => {
            console.error('Error disabling user:', error);
            return of(null);
        }));
    }
    disableCurrentUser$() {
        return this._graphService.mutate(DISABLE_CURRENT_USER(), 'users', graphEndpoint.clientName).pipe(switchMap(() => this.fetchCurrentUser$()), catchError(error => {
            console.error('Error disabling user:', error);
            return of(null);
        }));
    }
    updateCurrentUser$(user) {
        return this._graphService
            .mutate(UPDATE_CURRENT_USER(user), 'users', graphEndpoint.clientName, [cachedQueryName.currentUser])
            .pipe(switchMap(() => this.fetchCurrentUser$()), catchError(error => {
            console.error('Error updating user:', error);
            return of(null);
        }));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamUsersService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamUsersService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamUsersService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlcnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy91c2VyL3NlcnZpY2VzL3VzZXJzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsY0FBYyxFQUFpQixvQkFBb0IsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0RyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzFDLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUcvRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFckQsT0FBTyxFQUFRLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRW5ELE9BQU8sRUFBRSxRQUFRLEVBQUUsb0JBQW9CLEVBQUUsWUFBWSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUcsT0FBTyxFQUNMLHdCQUF3QixFQUN4QixnQkFBZ0IsRUFDaEIsZUFBZSxFQUNmLDBCQUEwQixFQUMxQixTQUFTLEVBQ1QsY0FBYyxHQUNmLE1BQU0scUJBQXFCLENBQUM7O0FBRTdCLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRztJQUM3QixXQUFXLEVBQUUsYUFBYTtDQUMzQixDQUFDO0FBQ0YsTUFBTSxhQUFhLEdBQWtCO0lBQ25DLFVBQVUsRUFBRSxhQUFhO0lBQ3pCLFFBQVEsRUFBRSxNQUFNO0NBQ2pCLENBQUM7QUFLRixNQUFNLE9BQU8sZUFBZ0IsU0FBUSxjQUFjO0lBV2pEO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFYSCxVQUFLLEdBQUcsSUFBSSxtQkFBbUIsRUFBVSxDQUFDO1FBQzFDLG1CQUFjLEdBQUcsSUFBSSxtQkFBbUIsRUFBVSxDQUFDO1FBRW5ELGFBQVEsR0FBRyxJQUFJLG9CQUFvQixFQUFRLENBQUM7UUFDNUMsU0FBSSxHQUFHLElBQUksb0JBQW9CLEVBQVEsQ0FBQztRQUN4QyxnQkFBVyxHQUFHLElBQUksbUJBQW1CLEVBQVEsQ0FBQztRQUM5QywwQkFBcUIsR0FBRyxJQUFJLG1CQUFtQixFQUFZLENBQUM7UUFFNUQsdUJBQWtCLEdBQUcsSUFBSSxtQkFBbUIsRUFBVSxDQUFDO1FBSTVELEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU0sV0FBVztRQUNoQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUNyQixJQUFJLENBQUMsYUFBYTthQUNmLG1CQUFtQixDQUNsQixTQUFTLENBQ1AsRUFBRSxFQUNGO2dCQUNJLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNuQixTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztnQkFDekIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7Z0JBQzFCLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO2dCQUN6QixTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztnQkFDNUIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7a0JBQ3hCLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2tCQUN2QixhQUFhLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQzs7Z0JBRTNCLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO2dCQUN4QixTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztnQkFDeEIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7O2FBRTNCLEVBQ0QsMEJBQTBCLENBQzNCLEVBQ0QsT0FBTyxFQUNQLGFBQWEsQ0FBQyxVQUFVLENBQ3pCO2FBQ0EsSUFBSSxDQUNILE1BQU0sQ0FBQyxhQUFhLENBQUMsRUFDckIsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FDOUIsQ0FDSixDQUFDO0lBQ0osQ0FBQztJQUVNLHdCQUF3QixDQUFDLFNBQWlCO1FBQy9DLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FDbEMsSUFBSSxDQUFDLGFBQWE7YUFDZixVQUFVLENBQVMsd0JBQXdCLENBQUMsU0FBUyxDQUFDLEVBQUUsb0JBQW9CLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQzthQUN2RyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQy9CLENBQUM7SUFDSixDQUFDO0lBRU0sZ0JBQWdCLENBQUMsR0FBYTtRQUNuQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUNyQixJQUFJLENBQUMsYUFBYTthQUNmLG1CQUFtQixDQUNsQixTQUFTLENBQ1AsdUJBQXVCLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQ2pFO2dCQUNJLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNuQixTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztnQkFDekIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7Z0JBQzFCLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO2dCQUN6QixTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztnQkFDeEIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7YUFDM0IsRUFDRCwwQkFBMEIsQ0FDM0IsRUFDRCxPQUFPLEVBQ1AsYUFBYSxDQUFDLFVBQVUsQ0FDekI7YUFDQSxJQUFJLENBQ0gsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUNyQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUM5QixDQUNKLENBQUM7SUFDSixDQUFDO0lBRU0sVUFBVSxDQUFDLEVBQVU7UUFDMUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FDcEIsRUFBRSxFQUNGLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFPLGNBQWMsQ0FBQyxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUM5RixDQUFDO0lBQ0osQ0FBQztJQUVNLGlCQUFpQjtRQUN0QixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUMzQixJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBTyxnQkFBZ0IsRUFBRSxFQUFFLGVBQWUsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUMvRyxDQUFDO0lBQ0osQ0FBQztJQUVNLDJCQUEyQjtRQUNoQyxPQUFPLElBQUksQ0FBQyxxQkFBcUI7YUFDOUIsS0FBSyxDQUNKLElBQUksQ0FBQyxhQUFhO2FBQ2YsY0FBYyxDQUFTLGVBQWUsRUFBRSxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsVUFBVSxDQUFDO2FBQ2pGLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsQ0FDakM7YUFDQSxJQUFJLENBQ0gsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ04sQ0FBQztJQUVNLG9CQUFvQixDQUFDLE1BQWU7UUFDekMsSUFBSSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2pDLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hCLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxhQUFhO2FBQ3RCLG1CQUFtQixDQUNsQiwwQkFBMEIsQ0FDeEIsTUFBTSxFQUNOO2dCQUNNLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNuQixTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztnQkFDeEIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7Z0JBQ3hCLFNBQVMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDO2dCQUMxQixTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztnQkFDekIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7YUFDNUIsQ0FDSixFQUNELHNCQUFzQixFQUN0QixhQUFhLENBQUMsVUFBVSxDQUN6QjthQUNBLElBQUksQ0FDSCxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQ3JCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLEVBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNULElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FDSCxDQUNGLENBQUM7SUFDTixDQUFDO0lBRU0sUUFBUSxDQUFDLGdCQUFrQztRQUNoRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFPLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUN4RyxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQ3JCLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsRUFDbkMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0MsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTSxZQUFZLENBQUMsTUFBYztRQUNoQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFVLFlBQVksQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDckcsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDeEMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDOUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTSxtQkFBbUI7UUFDeEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBVSxvQkFBb0IsRUFBRSxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUN2RyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsRUFDekMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDOUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxJQUE0QjtRQUNwRCxPQUFPLElBQUksQ0FBQyxhQUFhO2FBQ3RCLE1BQU0sQ0FBYyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLFVBQVUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUNoSCxJQUFJLENBQ0gsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEVBQ3pDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDTixDQUFDOytHQXRMVSxlQUFlO21IQUFmLGVBQWUsY0FGZCxNQUFNOzs0RkFFUCxlQUFlO2tCQUgzQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgQ2FtQmFzZVNlcnZpY2UsIEdyYXBoRW5kcG9pbnQsIEhhbmRsZUNvbXBsZXhSZXF1ZXN0LCBIYW5kbGVTaW1wbGVSZXF1ZXN0IH0gZnJvbSAnQHRhL3NlcnZlcic7XG5pbXBvcnQgeyBpc05vbk51bGxhYmxlIH0gZnJvbSAnQHRhL3V0aWxzJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGNhdGNoRXJyb3IsIGZpbHRlciwgbWFwLCBvZiwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgQ3VycmVudFVzZXIgfSBmcm9tICcuL3VzZXJzL2R0by9jdXJyZW50VXNlcic7XG5pbXBvcnQgeyBmdW5jdGlvblByb3BzIH0gZnJvbSAnLi91c2Vycy9kdG8vZnVuY3Rpb24nO1xuaW1wb3J0IHsgTW9kaWZ5VXNlclBheWxvYWRJbnB1dCB9IGZyb20gJy4vdXNlcnMvZHRvL21vZGlmeVVzZXJQYXlsb2FkSW5wdXQnO1xuaW1wb3J0IHsgVXNlciwgdXNlclByb3BzIH0gZnJvbSAnLi91c2Vycy9kdG8vdXNlcic7XG5pbXBvcnQgeyBVc2VyQWRkZWRQYXlsb2FkIH0gZnJvbSAnLi91c2Vycy9kdG8vdXNlckFkZGVkUGF5bG9hZCc7XG5pbXBvcnQgeyBBRERfVVNFUiwgRElTQUJMRV9DVVJSRU5UX1VTRVIsIERJU0FCTEVfVVNFUiwgVVBEQVRFX0NVUlJFTlRfVVNFUiB9IGZyb20gJy4vdXNlcnMvdXNlck11dGF0aW9ucyc7XG5pbXBvcnQge1xuICBHRVRfQ09OVEFDVF9URU5BTlRfUk9VVEUsXG4gIEdFVF9DVVJSRU5UX1VTRVIsXG4gIEdFVF9NWV9DT05UQUNUUyxcbiAgR0VUX1NFQVJDSF9VU0VSU19DVVNUT01FUlMsXG4gIEdFVF9VU0VSUyxcbiAgR0VUX1VTRVJfQllfSUQsXG59IGZyb20gJy4vdXNlcnMvdXNlclF1ZXJpZXMnO1xuXG5leHBvcnQgY29uc3QgY2FjaGVkUXVlcnlOYW1lID0ge1xuICBjdXJyZW50VXNlcjogJ2N1cnJlbnRVc2VyJyxcbn07XG5jb25zdCBncmFwaEVuZHBvaW50OiBHcmFwaEVuZHBvaW50ID0ge1xuICBjbGllbnROYW1lOiAndXNlclNlcnZpY2UnLFxuICBlbmRwb2ludDogJ3VzZXInLFxufTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIENhbVVzZXJzU2VydmljZSBleHRlbmRzIENhbUJhc2VTZXJ2aWNlIHtcbiAgcHVibGljIHVzZXJzID0gbmV3IEhhbmRsZVNpbXBsZVJlcXVlc3Q8VXNlcltdPigpO1xuICBwdWJsaWMgdXNlcnNDdXN0b21lcnMgPSBuZXcgSGFuZGxlU2ltcGxlUmVxdWVzdDxVc2VyW10+KCk7XG5cbiAgcHVibGljIHVzZXJCeUlkID0gbmV3IEhhbmRsZUNvbXBsZXhSZXF1ZXN0PFVzZXI+KCk7XG4gIHB1YmxpYyB1c2VyID0gbmV3IEhhbmRsZUNvbXBsZXhSZXF1ZXN0PFVzZXI+KCk7XG4gIHB1YmxpYyBjdXJyZW50VXNlciA9IG5ldyBIYW5kbGVTaW1wbGVSZXF1ZXN0PFVzZXI+KCk7XG4gIHB1YmxpYyBjdXJyZW50VXNlckNvbnRhY3RJZHMgPSBuZXcgSGFuZGxlU2ltcGxlUmVxdWVzdDxzdHJpbmdbXT4oKTtcblxuICBwdWJsaWMgY29udGFjdFRlbmFudFJvdXRlID0gbmV3IEhhbmRsZVNpbXBsZVJlcXVlc3Q8c3RyaW5nPigpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgc3VwZXIucmVnaXN0ZXJSb3V0ZXMoeyBncmFwaEVuZHBvaW50OiBncmFwaEVuZHBvaW50IH0pO1xuICB9XG5cbiAgcHVibGljIGZldGNoVXNlcnMkKCkge1xuICAgIHJldHVybiB0aGlzLnVzZXJzLmZldGNoKFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PFVzZXI+KFxuICAgICAgICAgIEdFVF9VU0VSUyhcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgYFxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2lkJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgndXNlck5hbWUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdmaXJzdE5hbWUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdsYXN0TmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3Bob25lTnVtYmVyJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgnZnVuY3Rpb25zJyl9IHtcbiAgICAgICAgICAgICAgICAke2Z1bmN0aW9uUHJvcHMuZ2V0KCdpZCcpfVxuICAgICAgICAgICAgICAgICR7ZnVuY3Rpb25Qcm9wcy5nZXQoJ25hbWUnKX1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2N1bHR1cmUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCd0cmlncmFtJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgncGljdHVyZScpfVxuICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGAsXG4gICAgICAgICAgICBgb3JkZXI6IHsgbGFzdE5hbWU6IEFTQyB9YFxuICAgICAgICAgICksXG4gICAgICAgICAgJ3VzZXJzJyxcbiAgICAgICAgICBncmFwaEVuZHBvaW50LmNsaWVudE5hbWVcbiAgICAgICAgKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSlcbiAgICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hDb250YWN0VGVuYW50Um91dGUkKGNvbnRhY3RJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udGFjdFRlbmFudFJvdXRlLmZldGNoKFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFF1ZXJ5PHN0cmluZz4oR0VUX0NPTlRBQ1RfVEVOQU5UX1JPVVRFKGNvbnRhY3RJZCksICdjb250YWN0VGVuYW50Um91dGUnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpXG4gICAgICAgIC5waXBlKGZpbHRlcihpc05vbk51bGxhYmxlKSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGZldGNoVXNlcnNCeUlkcyQoaWRzOiBzdHJpbmdbXSkge1xuICAgIHJldHVybiB0aGlzLnVzZXJzLmZldGNoKFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PFVzZXI+KFxuICAgICAgICAgIEdFVF9VU0VSUyhcbiAgICAgICAgICAgIGB3aGVyZTogeyBpZDogeyBpbjogWyR7aWRzLm1hcChpZCA9PiBgXCIke2lkfVwiYCkuam9pbignLCAnKX1dIH0gfWAsXG4gICAgICAgICAgICBgXG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgnaWQnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCd1c2VyTmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2ZpcnN0TmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2xhc3ROYW1lJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgncGljdHVyZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3RyaWdyYW0nKX1cbiAgICAgICAgICAgIGAsXG4gICAgICAgICAgICBgb3JkZXI6IHsgbGFzdE5hbWU6IEFTQyB9YFxuICAgICAgICAgICksXG4gICAgICAgICAgJ3VzZXJzJyxcbiAgICAgICAgICBncmFwaEVuZHBvaW50LmNsaWVudE5hbWVcbiAgICAgICAgKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoaXNOb25OdWxsYWJsZSksXG4gICAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSlcbiAgICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hVc2VyJChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlci5mZXRjaChcbiAgICAgIGlkLFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlLmZldGNoUXVlcnk8VXNlcj4oR0VUX1VTRVJfQllfSUQoaWQpLCAndXNlckJ5SWQnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaEN1cnJlbnRVc2VyJCgpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50VXNlci5mZXRjaChcbiAgICAgIHRoaXMuX2dyYXBoU2VydmljZS5mZXRjaFF1ZXJ5PFVzZXI+KEdFVF9DVVJSRU5UX1VTRVIoKSwgY2FjaGVkUXVlcnlOYW1lLmN1cnJlbnRVc2VyLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaEN1cnJlbnRVc2VyQ29udGFjdElkcyQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFVzZXJDb250YWN0SWRzXG4gICAgICAuZmV0Y2goXG4gICAgICAgIHRoaXMuX2dyYXBoU2VydmljZVxuICAgICAgICAgIC5mZXRjaFF1ZXJ5TGlzdDxzdHJpbmc+KEdFVF9NWV9DT05UQUNUUygpLCAnbXlDb250YWN0cycsIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSlcbiAgICAgICAgICAucGlwZShtYXAoZGF0YSA9PiBkYXRhID8/IFtdKSlcbiAgICAgIClcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX2dyYXBoU2VydmljZS5jb250YWN0c0xvYWRlZCQubmV4dCh0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hVc2Vyc0N1c3RvbWVycyQoc2VhcmNoPzogc3RyaW5nKSB7XG4gICAgaWYgKCFzZWFyY2ggfHwgc2VhcmNoLmxlbmd0aCA8IDMpIHtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9ncmFwaFNlcnZpY2VcbiAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PFVzZXI+KFxuICAgICAgICBHRVRfU0VBUkNIX1VTRVJTX0NVU1RPTUVSUyhcbiAgICAgICAgICBzZWFyY2gsXG4gICAgICAgICAgYFxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ2lkJyl9XG4gICAgICAgICAgICAgICR7dXNlclByb3BzLmdldCgncGljdHVyZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3RyaWdyYW0nKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdmaXJzdE5hbWUnKX1cbiAgICAgICAgICAgICAgJHt1c2VyUHJvcHMuZ2V0KCdsYXN0TmFtZScpfVxuICAgICAgICAgICAgICAke3VzZXJQcm9wcy5nZXQoJ3VzZXJOYW1lJyl9XG4gICAgICAgICAgICBgXG4gICAgICAgICksXG4gICAgICAgICdzZWFyY2hVc2Vyc0N1c3RvbWVycycsXG4gICAgICAgIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZVxuICAgICAgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcihpc05vbk51bGxhYmxlKSxcbiAgICAgICAgbWFwKGRhdGEgPT4gZGF0YS5pdGVtcyA/PyBbXSksXG4gICAgICAgIHRhcChsaXN0ID0+XG4gICAgICAgICAgbGlzdC5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy51c2VyQnlJZC5hZGQoZWxlbWVudC5pZCwgZWxlbWVudCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRVc2VyJCh1c2VyQWRkZWRQYXlsb2FkOiBVc2VyQWRkZWRQYXlsb2FkKTogT2JzZXJ2YWJsZTxVc2VyW10gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZS5tdXRhdGU8VXNlcj4oQUREX1VTRVIodXNlckFkZGVkUGF5bG9hZCksICd1c2VycycsIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSkucGlwZShcbiAgICAgIGZpbHRlcihpc05vbk51bGxhYmxlKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmZldGNoVXNlcnMkKCkpLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFkZGluZyB1c2VyOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGRpc2FibGVVc2VyJCh1c2VySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9ncmFwaFNlcnZpY2UubXV0YXRlPGJvb2xlYW4+KERJU0FCTEVfVVNFUih1c2VySWQpLCAndXNlcnMnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5mZXRjaFVzZXIkKHVzZXJJZCkpLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRpc2FibGluZyB1c2VyOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGRpc2FibGVDdXJyZW50VXNlciQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dyYXBoU2VydmljZS5tdXRhdGU8Ym9vbGVhbj4oRElTQUJMRV9DVVJSRU5UX1VTRVIoKSwgJ3VzZXJzJywgZ3JhcGhFbmRwb2ludC5jbGllbnROYW1lKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZmV0Y2hDdXJyZW50VXNlciQoKSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZGlzYWJsaW5nIHVzZXI6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQ3VycmVudFVzZXIkKHVzZXI6IE1vZGlmeVVzZXJQYXlsb2FkSW5wdXQpIHtcbiAgICByZXR1cm4gdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAubXV0YXRlPEN1cnJlbnRVc2VyPihVUERBVEVfQ1VSUkVOVF9VU0VSKHVzZXIpLCAndXNlcnMnLCBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUsIFtjYWNoZWRRdWVyeU5hbWUuY3VycmVudFVzZXJdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmZldGNoQ3VycmVudFVzZXIkKCkpLFxuICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciB1cGRhdGluZyB1c2VyOicsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG59XG4iXX0=