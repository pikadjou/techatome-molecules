import { Component, ViewChild, input } from '@angular/core';
import { FontIconComponent } from '@ta/icons';
import { TranslatePipe } from '@ta/translation';
import { LabelComponent, TaOverlayPanelComponent } from '@ta/ui';
import { TaTranslationInput } from '../../../translation.service';
import { TaAbstractInputComponent } from '../../abstract.component';
import { InputLayoutComponent } from '../../input-layout/input-layout.component';
import * as i0 from "@angular/core";
export class DropdownComponent extends TaAbstractInputComponent {
    constructor() {
        super();
        this.space = input(true);
        this.optionsList = [];
        this.filteredOptions = [];
        TaTranslationInput.getInstance();
    }
    ngOnInit() {
        super.ngOnInit();
        this._registerSubscription(this.input.options$.subscribe(options => {
            this.optionsList = options;
            this.filteredOptions = this.optionsList;
        }));
    }
    getOptionName(id) {
        const found = this.optionsList.find(opt => opt.id === id);
        return found ? found.name : '';
    }
    onMenuSelect(selectedId) {
        if (this.input.multiple) {
            let currentValue = this.input.value || [];
            if (currentValue.includes(selectedId)) {
                currentValue = currentValue.filter((v) => v !== selectedId);
            }
            else {
                currentValue = [...currentValue, selectedId];
            }
            this.input.value = currentValue;
        }
        else {
            this.input.value = selectedId;
            this.overlayPanelRef.close();
        }
    }
    onOverlayClosed() {
        this.filteredOptions = this.optionsList;
    }
    isSelected(id) {
        const currentValue = this.input.value;
        return this.input.multiple ? Array.isArray(currentValue) && currentValue.includes(id) : currentValue === id;
    }
    selectOption(id, event) {
        this.onMenuSelect(id);
    }
    onSearchChange(event) {
        if (!this.input.withSearch)
            return;
        const target = event.target;
        const searchTerm = target.value.trim();
        this.filteredOptions =
            searchTerm.length >= 0
                ? this.optionsList.filter(opt => opt.name.toLowerCase().includes(searchTerm.toLowerCase()))
                : this.optionsList;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: DropdownComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "18.2.14", type: DropdownComponent, isStandalone: true, selector: "ta-input-dropdown", inputs: { space: { classPropertyName: "space", publicName: "space", isSignal: true, isRequired: false, transformFunction: null } }, viewQueries: [{ propertyName: "overlayPanelRef", first: true, predicate: TaOverlayPanelComponent, descendants: true }], usesInheritance: true, ngImport: i0, template: "@if (this.input) {\n  <ta-overlay-panel [panelConfig]=\"{ matchTriggerWidth: true }\" (closed)=\"this.onOverlayClosed()\">\n    <ng-template #panelTrigger>\n      <ta-input-layout [input]=\"this.input\">\n        <div #focusedElement class=\"custom-dropdown-button form-control\" [class.disabled]=\"this.input.disabled\">\n          <span class=\"selected-value align-center g-space-xs\">\n            @if (!this.input.multiple) {\n              @if (this.input.value) {\n                <span>\n                  {{ this.getOptionName(this.input.value) | translate }}\n                </span>\n              } @else {\n                {{ 'input.dropdown.novalue' | translate }}\n              }\n            } @else if (this.input.multiple) {\n              @for (value of this.input.value; track value) {\n                <ta-label size=\"sm\" class=\"d-flex\">\n                  {{ this.getOptionName(value) | translate }}\n                </ta-label>\n              }\n            }\n          </span>\n          <ta-font-icon name=\"arrow-big-bottom\" type=\"sm\"></ta-font-icon>\n        </div>\n      </ta-input-layout>\n    </ng-template>\n\n    <ng-template #panelContent>\n      <div class=\"custom-menu\">\n        @if (this.input.withSearch) {\n          <input class=\"input-search\" type=\"search\" placeholder=\"Rechercher...\" (input)=\"this.onSearchChange($event)\" />\n        }\n        @for (opt of this.filteredOptions; track opt.id) {\n          <button\n            [attr.cdkMenuItem]=\"!this.input.multiple ? '' : null\"\n            (click)=\"this.selectOption(opt.id, $event)\"\n            [class.selected]=\"this.isSelected(opt.id)\"\n            [class.disabled]=\"opt.disabled\"\n            class=\"dropdown-option space-between\"\n          >\n            {{ opt.name | translate }}\n            @if (this.isSelected(opt.id)) {\n              <ta-font-icon class=\"checkmark\" name=\"check-line\"></ta-font-icon>\n            }\n          </button>\n        }\n      </div>\n    </ng-template>\n  </ta-overlay-panel>\n}\n", styles: [".custom-dropdown-button{text-align:left;display:flex;justify-content:space-between;align-items:center}.custom-dropdown-button.disabled{border-color:var(--ta-neutral-300);pointer-events:none}button .selected-value{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.custom-menu{padding:0}.input-search{width:100%;display:flex;flex-direction:column;padding:10px;border:none;outline:none}.input-search:focus{border:none;outline:none;box-shadow:none}.dropdown-option{display:flex;align-items:center;padding:var(--ta-space-sm) var(--ta-space-md);text-align:left;border:none;background:transparent;cursor:pointer;width:100%}.dropdown-option .checkmark{margin-left:var(--ta-space-sm);color:var(--ta-border-brand)}.dropdown-option:hover{background-color:var(--ta-neutral-100)}.dropdown-option.disabled{color:var(--ta-neutral-500);cursor:not-allowed}\n"], dependencies: [{ kind: "component", type: FontIconComponent, selector: "ta-font-icon", inputs: ["name", "type"] }, { kind: "component", type: TaOverlayPanelComponent, selector: "ta-overlay-panel", inputs: ["panelConfig", "position"], outputs: ["closed"] }, { kind: "component", type: LabelComponent, selector: "ta-label", inputs: ["size", "type"] }, { kind: "pipe", type: TranslatePipe, name: "translate" }, { kind: "component", type: InputLayoutComponent, selector: "ta-input-layout", inputs: ["input", "width", "height"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: DropdownComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ta-input-dropdown', standalone: true, imports: [FontIconComponent, TaOverlayPanelComponent, LabelComponent, TranslatePipe, InputLayoutComponent], template: "@if (this.input) {\n  <ta-overlay-panel [panelConfig]=\"{ matchTriggerWidth: true }\" (closed)=\"this.onOverlayClosed()\">\n    <ng-template #panelTrigger>\n      <ta-input-layout [input]=\"this.input\">\n        <div #focusedElement class=\"custom-dropdown-button form-control\" [class.disabled]=\"this.input.disabled\">\n          <span class=\"selected-value align-center g-space-xs\">\n            @if (!this.input.multiple) {\n              @if (this.input.value) {\n                <span>\n                  {{ this.getOptionName(this.input.value) | translate }}\n                </span>\n              } @else {\n                {{ 'input.dropdown.novalue' | translate }}\n              }\n            } @else if (this.input.multiple) {\n              @for (value of this.input.value; track value) {\n                <ta-label size=\"sm\" class=\"d-flex\">\n                  {{ this.getOptionName(value) | translate }}\n                </ta-label>\n              }\n            }\n          </span>\n          <ta-font-icon name=\"arrow-big-bottom\" type=\"sm\"></ta-font-icon>\n        </div>\n      </ta-input-layout>\n    </ng-template>\n\n    <ng-template #panelContent>\n      <div class=\"custom-menu\">\n        @if (this.input.withSearch) {\n          <input class=\"input-search\" type=\"search\" placeholder=\"Rechercher...\" (input)=\"this.onSearchChange($event)\" />\n        }\n        @for (opt of this.filteredOptions; track opt.id) {\n          <button\n            [attr.cdkMenuItem]=\"!this.input.multiple ? '' : null\"\n            (click)=\"this.selectOption(opt.id, $event)\"\n            [class.selected]=\"this.isSelected(opt.id)\"\n            [class.disabled]=\"opt.disabled\"\n            class=\"dropdown-option space-between\"\n          >\n            {{ opt.name | translate }}\n            @if (this.isSelected(opt.id)) {\n              <ta-font-icon class=\"checkmark\" name=\"check-line\"></ta-font-icon>\n            }\n          </button>\n        }\n      </div>\n    </ng-template>\n  </ta-overlay-panel>\n}\n", styles: [".custom-dropdown-button{text-align:left;display:flex;justify-content:space-between;align-items:center}.custom-dropdown-button.disabled{border-color:var(--ta-neutral-300);pointer-events:none}button .selected-value{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.custom-menu{padding:0}.input-search{width:100%;display:flex;flex-direction:column;padding:10px;border:none;outline:none}.input-search:focus{border:none;outline:none;box-shadow:none}.dropdown-option{display:flex;align-items:center;padding:var(--ta-space-sm) var(--ta-space-md);text-align:left;border:none;background:transparent;cursor:pointer;width:100%}.dropdown-option .checkmark{margin-left:var(--ta-space-sm);color:var(--ta-border-brand)}.dropdown-option:hover{background-color:var(--ta-neutral-100)}.dropdown-option.disabled{color:var(--ta-neutral-500);cursor:not-allowed}\n"] }]
        }], ctorParameters: () => [], propDecorators: { overlayPanelRef: [{
                type: ViewChild,
                args: [TaOverlayPanelComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb21wb25lbnRzL2lucHV0L2Ryb3Bkb3duL2Ryb3Bkb3duLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29tcG9uZW50cy9pbnB1dC9kcm9wZG93bi9kcm9wZG93bi5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHNUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsY0FBYyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRWpFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ2xFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJDQUEyQyxDQUFDOztBQVNqRixNQUFNLE9BQU8saUJBQWtCLFNBQVEsd0JBQWlEO0lBUXRGO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFSVixVQUFLLEdBQUcsS0FBSyxDQUFVLElBQUksQ0FBQyxDQUFDO1FBSXRCLGdCQUFXLEdBQXVELEVBQUUsQ0FBQztRQUNyRSxvQkFBZSxHQUF1RCxFQUFFLENBQUM7UUFJOUUsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUNRLFFBQVE7UUFDZixLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLHFCQUFxQixDQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUM7WUFDM0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRU0sYUFBYSxDQUFDLEVBQU87UUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzFELE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVNLFlBQVksQ0FBQyxVQUFlO1FBQ2pDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN4QixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDMUMsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7Z0JBQ3RDLFlBQVksR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDLENBQUM7WUFDbkUsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLFlBQVksR0FBRyxDQUFDLEdBQUcsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQy9DLENBQUM7WUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUM7UUFDbEMsQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7WUFDOUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMvQixDQUFDO0lBQ0gsQ0FBQztJQUVNLGVBQWU7UUFDcEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzFDLENBQUM7SUFFTSxVQUFVLENBQUMsRUFBTztRQUN2QixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUN0QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksS0FBSyxFQUFFLENBQUM7SUFDOUcsQ0FBQztJQUVNLFlBQVksQ0FBQyxFQUFPLEVBQUUsS0FBaUI7UUFDNUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRU0sY0FBYyxDQUFDLEtBQVk7UUFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVTtZQUFFLE9BQU87UUFDbkMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQTBCLENBQUM7UUFDaEQsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QyxJQUFJLENBQUMsZUFBZTtZQUNsQixVQUFVLENBQUMsTUFBTSxJQUFJLENBQUM7Z0JBQ3BCLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUMzRixDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUN6QixDQUFDOytHQS9EVSxpQkFBaUI7bUdBQWpCLGlCQUFpQixrUUFHakIsdUJBQXVCLHVFQ3JCcEMsd2dFQWtEQSxtNUJEbENZLGlCQUFpQixtRkFBRSx1QkFBdUIsdUhBQUUsY0FBYywwRUFBRSxhQUFhLGtEQUFFLG9CQUFvQjs7NEZBRTlGLGlCQUFpQjtrQkFQN0IsU0FBUzsrQkFDRSxtQkFBbUIsY0FHakIsSUFBSSxXQUNQLENBQUMsaUJBQWlCLEVBQUUsdUJBQXVCLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxvQkFBb0IsQ0FBQzt3REFLdEUsZUFBZTtzQkFBbEQsU0FBUzt1QkFBQyx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIFZpZXdDaGlsZCwgaW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgSW5wdXREcm9wZG93biB9IGZyb20gJ0B0YS9mb3JtLW1vZGVsJztcbmltcG9ydCB7IEZvbnRJY29uQ29tcG9uZW50IH0gZnJvbSAnQHRhL2ljb25zJztcbmltcG9ydCB7IFRyYW5zbGF0ZVBpcGUgfSBmcm9tICdAdGEvdHJhbnNsYXRpb24nO1xuaW1wb3J0IHsgTGFiZWxDb21wb25lbnQsIFRhT3ZlcmxheVBhbmVsQ29tcG9uZW50IH0gZnJvbSAnQHRhL3VpJztcblxuaW1wb3J0IHsgVGFUcmFuc2xhdGlvbklucHV0IH0gZnJvbSAnLi4vLi4vLi4vdHJhbnNsYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBUYUFic3RyYWN0SW5wdXRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9hYnN0cmFjdC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSW5wdXRMYXlvdXRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9pbnB1dC1sYXlvdXQvaW5wdXQtbGF5b3V0LmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RhLWlucHV0LWRyb3Bkb3duJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2Ryb3Bkb3duLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZHJvcGRvd24uY29tcG9uZW50LnNjc3MnXSxcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgaW1wb3J0czogW0ZvbnRJY29uQ29tcG9uZW50LCBUYU92ZXJsYXlQYW5lbENvbXBvbmVudCwgTGFiZWxDb21wb25lbnQsIFRyYW5zbGF0ZVBpcGUsIElucHV0TGF5b3V0Q29tcG9uZW50XSxcbn0pXG5leHBvcnQgY2xhc3MgRHJvcGRvd25Db21wb25lbnQgZXh0ZW5kcyBUYUFic3RyYWN0SW5wdXRDb21wb25lbnQ8SW5wdXREcm9wZG93bjxhbnk+LCBhbnk+IHtcbiAgc3BhY2UgPSBpbnB1dDxib29sZWFuPih0cnVlKTtcblxuICBAVmlld0NoaWxkKFRhT3ZlcmxheVBhbmVsQ29tcG9uZW50KSBvdmVybGF5UGFuZWxSZWYhOiBUYU92ZXJsYXlQYW5lbENvbXBvbmVudDtcblxuICBwdWJsaWMgb3B0aW9uc0xpc3Q6IHsgaWQ6IHN0cmluZzsgbmFtZTogc3RyaW5nOyBkaXNhYmxlZD86IGJvb2xlYW4gfVtdID0gW107XG4gIHB1YmxpYyBmaWx0ZXJlZE9wdGlvbnM6IHsgaWQ6IHN0cmluZzsgbmFtZTogc3RyaW5nOyBkaXNhYmxlZD86IGJvb2xlYW4gfVtdID0gW107XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICBUYVRyYW5zbGF0aW9uSW5wdXQuZ2V0SW5zdGFuY2UoKTtcbiAgfVxuICBvdmVycmlkZSBuZ09uSW5pdCgpIHtcbiAgICBzdXBlci5uZ09uSW5pdCgpO1xuICAgIHRoaXMuX3JlZ2lzdGVyU3Vic2NyaXB0aW9uKFxuICAgICAgdGhpcy5pbnB1dC5vcHRpb25zJC5zdWJzY3JpYmUob3B0aW9ucyA9PiB7XG4gICAgICAgIHRoaXMub3B0aW9uc0xpc3QgPSBvcHRpb25zO1xuICAgICAgICB0aGlzLmZpbHRlcmVkT3B0aW9ucyA9IHRoaXMub3B0aW9uc0xpc3Q7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0T3B0aW9uTmFtZShpZDogYW55KTogc3RyaW5nIHtcbiAgICBjb25zdCBmb3VuZCA9IHRoaXMub3B0aW9uc0xpc3QuZmluZChvcHQgPT4gb3B0LmlkID09PSBpZCk7XG4gICAgcmV0dXJuIGZvdW5kID8gZm91bmQubmFtZSA6ICcnO1xuICB9XG5cbiAgcHVibGljIG9uTWVudVNlbGVjdChzZWxlY3RlZElkOiBhbnkpIHtcbiAgICBpZiAodGhpcy5pbnB1dC5tdWx0aXBsZSkge1xuICAgICAgbGV0IGN1cnJlbnRWYWx1ZSA9IHRoaXMuaW5wdXQudmFsdWUgfHwgW107XG4gICAgICBpZiAoY3VycmVudFZhbHVlLmluY2x1ZGVzKHNlbGVjdGVkSWQpKSB7XG4gICAgICAgIGN1cnJlbnRWYWx1ZSA9IGN1cnJlbnRWYWx1ZS5maWx0ZXIoKHY6IGFueSkgPT4gdiAhPT0gc2VsZWN0ZWRJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdXJyZW50VmFsdWUgPSBbLi4uY3VycmVudFZhbHVlLCBzZWxlY3RlZElkXTtcbiAgICAgIH1cbiAgICAgIHRoaXMuaW5wdXQudmFsdWUgPSBjdXJyZW50VmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaW5wdXQudmFsdWUgPSBzZWxlY3RlZElkO1xuICAgICAgdGhpcy5vdmVybGF5UGFuZWxSZWYuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25PdmVybGF5Q2xvc2VkKCk6IHZvaWQge1xuICAgIHRoaXMuZmlsdGVyZWRPcHRpb25zID0gdGhpcy5vcHRpb25zTGlzdDtcbiAgfVxuXG4gIHB1YmxpYyBpc1NlbGVjdGVkKGlkOiBhbnkpOiBib29sZWFuIHtcbiAgICBjb25zdCBjdXJyZW50VmFsdWUgPSB0aGlzLmlucHV0LnZhbHVlO1xuICAgIHJldHVybiB0aGlzLmlucHV0Lm11bHRpcGxlID8gQXJyYXkuaXNBcnJheShjdXJyZW50VmFsdWUpICYmIGN1cnJlbnRWYWx1ZS5pbmNsdWRlcyhpZCkgOiBjdXJyZW50VmFsdWUgPT09IGlkO1xuICB9XG5cbiAgcHVibGljIHNlbGVjdE9wdGlvbihpZDogYW55LCBldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgIHRoaXMub25NZW51U2VsZWN0KGlkKTtcbiAgfVxuXG4gIHB1YmxpYyBvblNlYXJjaENoYW5nZShldmVudDogRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaW5wdXQud2l0aFNlYXJjaCkgcmV0dXJuO1xuICAgIGNvbnN0IHRhcmdldCA9IGV2ZW50LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgIGNvbnN0IHNlYXJjaFRlcm0gPSB0YXJnZXQudmFsdWUudHJpbSgpO1xuICAgIHRoaXMuZmlsdGVyZWRPcHRpb25zID1cbiAgICAgIHNlYXJjaFRlcm0ubGVuZ3RoID49IDBcbiAgICAgICAgPyB0aGlzLm9wdGlvbnNMaXN0LmZpbHRlcihvcHQgPT4gb3B0Lm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2hUZXJtLnRvTG93ZXJDYXNlKCkpKVxuICAgICAgICA6IHRoaXMub3B0aW9uc0xpc3Q7XG4gIH1cbn1cbiIsIkBpZiAodGhpcy5pbnB1dCkge1xuICA8dGEtb3ZlcmxheS1wYW5lbCBbcGFuZWxDb25maWddPVwieyBtYXRjaFRyaWdnZXJXaWR0aDogdHJ1ZSB9XCIgKGNsb3NlZCk9XCJ0aGlzLm9uT3ZlcmxheUNsb3NlZCgpXCI+XG4gICAgPG5nLXRlbXBsYXRlICNwYW5lbFRyaWdnZXI+XG4gICAgICA8dGEtaW5wdXQtbGF5b3V0IFtpbnB1dF09XCJ0aGlzLmlucHV0XCI+XG4gICAgICAgIDxkaXYgI2ZvY3VzZWRFbGVtZW50IGNsYXNzPVwiY3VzdG9tLWRyb3Bkb3duLWJ1dHRvbiBmb3JtLWNvbnRyb2xcIiBbY2xhc3MuZGlzYWJsZWRdPVwidGhpcy5pbnB1dC5kaXNhYmxlZFwiPlxuICAgICAgICAgIDxzcGFuIGNsYXNzPVwic2VsZWN0ZWQtdmFsdWUgYWxpZ24tY2VudGVyIGctc3BhY2UteHNcIj5cbiAgICAgICAgICAgIEBpZiAoIXRoaXMuaW5wdXQubXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgQGlmICh0aGlzLmlucHV0LnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgPHNwYW4+XG4gICAgICAgICAgICAgICAgICB7eyB0aGlzLmdldE9wdGlvbk5hbWUodGhpcy5pbnB1dC52YWx1ZSkgfCB0cmFuc2xhdGUgfX1cbiAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgIH0gQGVsc2Uge1xuICAgICAgICAgICAgICAgIHt7ICdpbnB1dC5kcm9wZG93bi5ub3ZhbHVlJyB8IHRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IEBlbHNlIGlmICh0aGlzLmlucHV0Lm11bHRpcGxlKSB7XG4gICAgICAgICAgICAgIEBmb3IgKHZhbHVlIG9mIHRoaXMuaW5wdXQudmFsdWU7IHRyYWNrIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgPHRhLWxhYmVsIHNpemU9XCJzbVwiIGNsYXNzPVwiZC1mbGV4XCI+XG4gICAgICAgICAgICAgICAgICB7eyB0aGlzLmdldE9wdGlvbk5hbWUodmFsdWUpIHwgdHJhbnNsYXRlIH19XG4gICAgICAgICAgICAgICAgPC90YS1sYWJlbD5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICA8dGEtZm9udC1pY29uIG5hbWU9XCJhcnJvdy1iaWctYm90dG9tXCIgdHlwZT1cInNtXCI+PC90YS1mb250LWljb24+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC90YS1pbnB1dC1sYXlvdXQ+XG4gICAgPC9uZy10ZW1wbGF0ZT5cblxuICAgIDxuZy10ZW1wbGF0ZSAjcGFuZWxDb250ZW50PlxuICAgICAgPGRpdiBjbGFzcz1cImN1c3RvbS1tZW51XCI+XG4gICAgICAgIEBpZiAodGhpcy5pbnB1dC53aXRoU2VhcmNoKSB7XG4gICAgICAgICAgPGlucHV0IGNsYXNzPVwiaW5wdXQtc2VhcmNoXCIgdHlwZT1cInNlYXJjaFwiIHBsYWNlaG9sZGVyPVwiUmVjaGVyY2hlci4uLlwiIChpbnB1dCk9XCJ0aGlzLm9uU2VhcmNoQ2hhbmdlKCRldmVudClcIiAvPlxuICAgICAgICB9XG4gICAgICAgIEBmb3IgKG9wdCBvZiB0aGlzLmZpbHRlcmVkT3B0aW9uczsgdHJhY2sgb3B0LmlkKSB7XG4gICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgW2F0dHIuY2RrTWVudUl0ZW1dPVwiIXRoaXMuaW5wdXQubXVsdGlwbGUgPyAnJyA6IG51bGxcIlxuICAgICAgICAgICAgKGNsaWNrKT1cInRoaXMuc2VsZWN0T3B0aW9uKG9wdC5pZCwgJGV2ZW50KVwiXG4gICAgICAgICAgICBbY2xhc3Muc2VsZWN0ZWRdPVwidGhpcy5pc1NlbGVjdGVkKG9wdC5pZClcIlxuICAgICAgICAgICAgW2NsYXNzLmRpc2FibGVkXT1cIm9wdC5kaXNhYmxlZFwiXG4gICAgICAgICAgICBjbGFzcz1cImRyb3Bkb3duLW9wdGlvbiBzcGFjZS1iZXR3ZWVuXCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICB7eyBvcHQubmFtZSB8IHRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgQGlmICh0aGlzLmlzU2VsZWN0ZWQob3B0LmlkKSkge1xuICAgICAgICAgICAgICA8dGEtZm9udC1pY29uIGNsYXNzPVwiY2hlY2ttYXJrXCIgbmFtZT1cImNoZWNrLWxpbmVcIj48L3RhLWZvbnQtaWNvbj5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgfVxuICAgICAgPC9kaXY+XG4gICAgPC9uZy10ZW1wbGF0ZT5cbiAgPC90YS1vdmVybGF5LXBhbmVsPlxufVxuIl19