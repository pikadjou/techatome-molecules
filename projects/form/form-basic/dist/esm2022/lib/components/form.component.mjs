import { AsyncPipe } from "@angular/common";
import { Component, EventEmitter, input, Output, } from "@angular/core";
import { FormGroup, ReactiveFormsModule } from "@angular/forms";
import deepEqual from "fast-deep-equal";
import { distinctUntilChanged } from "rxjs";
import { ENotificationCode, NotificationInlineComponent, } from "@ta/notification";
import { TranslatePipe } from "@ta/translation";
import { ButtonComponent, LoaderComponent } from "@ta/ui";
import { TaBaseComponent } from "@ta/utils";
import { InputsComponent } from "./inputs/inputs.component";
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
export class FormComponent extends TaBaseComponent {
    constructor() {
        super();
        this.inputs = input.required();
        this.askValidation$ = input();
        this.askOnDestroy = input();
        this.loader = input(false);
        this.error = input({ status: ENotificationCode.none, message: "" });
        this.border = input(true);
        this.canDisplayButton = input(true);
        this.buttonTitle = input("form.save");
        this.onLive = input(false);
        this.valid = new EventEmitter();
        this.isFormValid = new EventEmitter();
    }
    ngOnInit() {
        this.form = this.toFormGroup(this.inputs());
        this._registerSubscription(this.form.statusChanges.subscribe(() => this.isFormValid.emit(this.isValid())));
        if (this.onLive()) {
            this._registerSubscription(this.form.valueChanges
                .pipe(distinctUntilChanged((prev, curr) => deepEqual(prev, curr)))
                .subscribe(() => this.onSubmit()));
        }
        const askValidation = this.askValidation$();
        if (askValidation) {
            this._registerSubscription(askValidation.subscribe((_) => this.onSubmit()));
        }
    }
    ngOnChanges(simpleChanges) {
        if (simpleChanges["inputs"] && !simpleChanges["inputs"].firstChange) {
            this.form = this.toFormGroup(this.inputs());
        }
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        this.inputs().forEach((inputItem) => {
            inputItem.destroy();
        });
        if (this.askOnDestroy()) {
            this.onSubmit();
        }
    }
    onSubmit() {
        if (!this.isValid()) {
            return;
        }
        this.valid.emit(this.form.value);
    }
    isValid() {
        return this.form.valid && !this.loader();
    }
    toFormGroup(inputs) {
        const group = new FormGroup({});
        if (inputs === null || inputs.length === 0) {
            return group;
        }
        inputs.forEach((input) => {
            input.createFormControl(group);
        });
        return group;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: FormComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "18.2.14", type: FormComponent, isStandalone: true, selector: "ta-form", inputs: { inputs: { classPropertyName: "inputs", publicName: "inputs", isSignal: true, isRequired: true, transformFunction: null }, askValidation$: { classPropertyName: "askValidation$", publicName: "askValidation$", isSignal: true, isRequired: false, transformFunction: null }, askOnDestroy: { classPropertyName: "askOnDestroy", publicName: "askOnDestroy", isSignal: true, isRequired: false, transformFunction: null }, loader: { classPropertyName: "loader", publicName: "loader", isSignal: true, isRequired: false, transformFunction: null }, error: { classPropertyName: "error", publicName: "error", isSignal: true, isRequired: false, transformFunction: null }, border: { classPropertyName: "border", publicName: "border", isSignal: true, isRequired: false, transformFunction: null }, canDisplayButton: { classPropertyName: "canDisplayButton", publicName: "canDisplayButton", isSignal: true, isRequired: false, transformFunction: null }, buttonTitle: { classPropertyName: "buttonTitle", publicName: "buttonTitle", isSignal: true, isRequired: false, transformFunction: null }, onLive: { classPropertyName: "onLive", publicName: "onLive", isSignal: true, isRequired: false, transformFunction: null } }, outputs: { valid: "valid", isFormValid: "isFormValid" }, usesInheritance: true, usesOnChanges: true, ngImport: i0, template: "<div class=\"form-container\">\n  <form (ngSubmit)=\"onSubmit()\" [formGroup]=\"this.form\">\n    @for (input of this.inputs(); track trackByKey($index, input)) {\n    <div>\n      @if (input.visible$ | async) {\n      <ta-inputs [input]=\"input\"></ta-inputs>\n      }\n    </div>\n    }\n    <div>\n      <ta-notification-inline\n        [message]=\"this.error().message\"\n        [code]=\"this.error().status\"\n        class=\"my-space-sm\"\n      >\n        <div class=\"justify-end\">\n          <ta-loader [isLoading]=\"this.loader()\">\n            @if (this.canDisplayButton() && this.buttonTitle()) {\n            <ta-button\n              (action)=\"this.onSubmit()\"\n              [state]=\"!this.isValid() ? 'disabled' : 'classic'\"\n              icon=\"check-line\"\n            >\n              {{ this.buttonTitle() | translate }}\n            </ta-button>\n            }\n          </ta-loader>\n        </div>\n      </ta-notification-inline>\n    </div>\n  </form>\n</div>\n", styles: [""], dependencies: [{ kind: "pipe", type: AsyncPipe, name: "async" }, { kind: "ngmodule", type: ReactiveFormsModule }, { kind: "directive", type: i1.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i1.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i1.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "component", type: NotificationInlineComponent, selector: "ta-notification-inline", inputs: ["message", "code", "showClose"], outputs: ["askClose"] }, { kind: "component", type: LoaderComponent, selector: "ta-loader", inputs: ["isLoading", "skeleton", "size", "text"] }, { kind: "component", type: ButtonComponent, selector: "ta-button", inputs: ["state", "type", "size", "icon", "options", "stopPropagationActivation"], outputs: ["action"] }, { kind: "pipe", type: TranslatePipe, name: "translate" }, { kind: "component", type: InputsComponent, selector: "ta-inputs", inputs: ["input", "standalone", "onFocus", "space"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: FormComponent, decorators: [{
            type: Component,
            args: [{ selector: "ta-form", standalone: true, imports: [
                        AsyncPipe,
                        ReactiveFormsModule,
                        NotificationInlineComponent,
                        LoaderComponent,
                        ButtonComponent,
                        TranslatePipe,
                        InputsComponent,
                    ], template: "<div class=\"form-container\">\n  <form (ngSubmit)=\"onSubmit()\" [formGroup]=\"this.form\">\n    @for (input of this.inputs(); track trackByKey($index, input)) {\n    <div>\n      @if (input.visible$ | async) {\n      <ta-inputs [input]=\"input\"></ta-inputs>\n      }\n    </div>\n    }\n    <div>\n      <ta-notification-inline\n        [message]=\"this.error().message\"\n        [code]=\"this.error().status\"\n        class=\"my-space-sm\"\n      >\n        <div class=\"justify-end\">\n          <ta-loader [isLoading]=\"this.loader()\">\n            @if (this.canDisplayButton() && this.buttonTitle()) {\n            <ta-button\n              (action)=\"this.onSubmit()\"\n              [state]=\"!this.isValid() ? 'disabled' : 'classic'\"\n              icon=\"check-line\"\n            >\n              {{ this.buttonTitle() | translate }}\n            </ta-button>\n            }\n          </ta-loader>\n        </div>\n      </ta-notification-inline>\n    </div>\n  </form>\n</div>\n" }]
        }], ctorParameters: () => [], propDecorators: { valid: [{
                type: Output
            }], isFormValid: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvbXBvbmVudHMvZm9ybS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9zcmMvbGliL2NvbXBvbmVudHMvZm9ybS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUlMLE1BQU0sR0FFUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEUsT0FBTyxTQUFTLE1BQU0saUJBQWlCLENBQUM7QUFDeEMsT0FBTyxFQUFjLG9CQUFvQixFQUFFLE1BQU0sTUFBTSxDQUFDO0FBR3hELE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsMkJBQTJCLEdBQzVCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFNUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDJCQUEyQixDQUFDOzs7QUFpQjVELE1BQU0sT0FBTyxhQUNYLFNBQVEsZUFBZTtJQTBCdkI7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQXhCVixXQUFNLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBb0IsQ0FBQztRQUU1QyxtQkFBYyxHQUFHLEtBQUssRUFBb0IsQ0FBQztRQUUzQyxpQkFBWSxHQUFHLEtBQUssRUFBVyxDQUFDO1FBRWhDLFdBQU0sR0FBRyxLQUFLLENBQVUsS0FBSyxDQUFDLENBQUM7UUFDL0IsVUFBSyxHQUFH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QUUsQ0FBQyxDQUFDO1FBQ2hDLElBQUksTUFBTSxLQUFLLElBQUksSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzNDLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUNELE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUN2QixLQUFLLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7K0dBNUZVLGFBQWE7bUdBQWIsYUFBYSwwMUNDMUMxQixzK0JBZ0NBLHFERENJLFNBQVMsNkNBQ1QsbUJBQW1CLHFiQUNuQiwyQkFBMkIsb0lBQzNCLGVBQWUseUdBQ2YsZUFBZSx5SkFDZixhQUFhLGtEQUNiLGVBQWU7OzRGQUdOLGFBQWE7a0JBZnpCLFNBQVM7K0JBQ0UsU0FBUyxjQUdQLElBQUksV0FDUDt3QkFDUCxTQUFTO3dCQUNULG1CQUFtQjt3QkFDbkIsMkJBQTJCO3dCQUMzQixlQUFlO3dCQUNmLGVBQWU7d0JBQ2YsYUFBYTt3QkFDYixlQUFlO3FCQUNoQjt3REFzQkQsS0FBSztzQkFESixNQUFNO2dCQUlQLFdBQVc7c0JBRFYsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzeW5jUGlwZSB9IGZyb20gXCJAYW5ndWxhci9jb21tb25cIjtcbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRXZlbnRFbWl0dGVyLFxuICBpbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBSZWFjdGl2ZUZvcm1zTW9kdWxlIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5cbmltcG9ydCBkZWVwRXF1YWwgZnJvbSBcImZhc3QtZGVlcC1lcXVhbFwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZGlzdGluY3RVbnRpbENoYW5nZWQgfSBmcm9tIFwicnhqc1wiO1xuXG5pbXBvcnQgeyBJSW5wdXRzRXJyb3IsIElucHV0QmFzZSB9IGZyb20gXCJAdGEvZm9ybS1tb2RlbFwiO1xuaW1wb3J0IHtcbiAgRU5vdGlmaWNhdGlvbkNvZGUsXG4gIE5vdGlmaWNhdGlvbklubGluZUNvbXBvbmVudCxcbn0gZnJvbSBcIkB0YS9ub3RpZmljYXRpb25cIjtcbmltcG9ydCB7IFRyYW5zbGF0ZVBpcGUgfSBmcm9tIFwiQHRhL3RyYW5zbGF0aW9uXCI7XG5pbXBvcnQgeyBCdXR0b25Db21wb25lbnQsIExvYWRlckNvbXBvbmVudCB9IGZyb20gXCJAdGEvdWlcIjtcbmltcG9ydCB7IFRhQmFzZUNvbXBvbmVudCB9IGZyb20gXCJAdGEvdXRpbHNcIjtcblxuaW1wb3J0IHsgSW5wdXRzQ29tcG9uZW50IH0gZnJvbSBcIi4vaW5wdXRzL2lucHV0cy5jb21wb25lbnRcIjtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiBcInRhLWZvcm1cIixcbiAgdGVtcGxhdGVVcmw6IFwiLi9mb3JtLmNvbXBvbmVudC5odG1sXCIsXG4gIHN0eWxlVXJsczogW1wiLi9mb3JtLmNvbXBvbmVudC5zY3NzXCJdLFxuICBzdGFuZGFsb25lOiB0cnVlLFxuICBpbXBvcnRzOiBbXG4gICAgQXN5bmNQaXBlLFxuICAgIFJlYWN0aXZlRm9ybXNNb2R1bGUsXG4gICAgTm90aWZpY2F0aW9uSW5saW5lQ29tcG9uZW50LFxuICAgIExvYWRlckNvbXBvbmVudCxcbiAgICBCdXR0b25Db21wb25lbnQsXG4gICAgVHJhbnNsYXRlUGlwZSxcbiAgICBJbnB1dHNDb21wb25lbnQsXG4gIF0sXG59KVxuZXhwb3J0IGNsYXNzIEZvcm1Db21wb25lbnRcbiAgZXh0ZW5kcyBUYUJhc2VDb21wb25lbnRcbiAgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95XG57XG4gIGlucHV0cyA9IGlucHV0LnJlcXVpcmVkPElucHV0QmFzZTxhbnk+W10+KCk7XG5cbiAgYXNrVmFsaWRhdGlvbiQgPSBpbnB1dDxPYnNlcnZhYmxlPG51bGw+PigpO1xuXG4gIGFza09uRGVzdHJveSA9IGlucHV0PGJvb2xlYW4+KCk7XG5cbiAgbG9hZGVyID0gaW5wdXQ8Ym9vbGVhbj4oZmFsc2UpO1xuICBlcnJvciA9IGlucHV0PElJbnB1dHNFcnJvcj4oeyBzdGF0dXM6IEVOb3RpZmljYXRpb25Db2RlLm5vbmUsIG1lc3NhZ2U6IFwiXCIgfSk7XG5cbiAgYm9yZGVyID0gaW5wdXQ8Ym9vbGVhbj4odHJ1ZSk7XG5cbiAgY2FuRGlzcGxheUJ1dHRvbiA9IGlucHV0PGJvb2xlYW4+KHRydWUpO1xuICBidXR0b25UaXRsZSA9IGlucHV0PHN0cmluZz4oXCJmb3JtLnNhdmVcIik7XG4gIG9uTGl2ZSA9IGlucHV0PGJvb2xlYW4+KGZhbHNlKTtcblxuICBAT3V0cHV0KClcbiAgdmFsaWQ6IEV2ZW50RW1pdHRlcjx7fT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgQE91dHB1dCgpXG4gIGlzRm9ybVZhbGlkID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuXG4gIHB1YmxpYyBmb3JtITogRm9ybUdyb3VwO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmZvcm0gPSB0aGlzLnRvRm9ybUdyb3VwKHRoaXMuaW5wdXRzKCkpO1xuXG4gICAgdGhpcy5fcmVnaXN0ZXJTdWJzY3JpcHRpb24oXG4gICAgICB0aGlzLmZvcm0uc3RhdHVzQ2hhbmdlcy5zdWJzY3JpYmUoKCkgPT5cbiAgICAgICAgdGhpcy5pc0Zvcm1WYWxpZC5lbWl0KHRoaXMuaXNWYWxpZCgpKVxuICAgICAgKVxuICAgICk7XG5cbiAgICBpZiAodGhpcy5vbkxpdmUoKSkge1xuICAgICAgdGhpcy5fcmVnaXN0ZXJTdWJzY3JpcHRpb24oXG4gICAgICAgIHRoaXMuZm9ybS52YWx1ZUNoYW5nZXNcbiAgICAgICAgICAucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgocHJldiwgY3VycikgPT4gZGVlcEVxdWFsKHByZXYsIGN1cnIpKSlcbiAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMub25TdWJtaXQoKSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgYXNrVmFsaWRhdGlvbiA9IHRoaXMuYXNrVmFsaWRhdGlvbiQoKTtcbiAgICBpZiAoYXNrVmFsaWRhdGlvbikge1xuICAgICAgdGhpcy5fcmVnaXN0ZXJTdWJzY3JpcHRpb24oXG4gICAgICAgIGFza1ZhbGlkYXRpb24uc3Vic2NyaWJlKChfKSA9PiB0aGlzLm9uU3VibWl0KCkpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG5nT25DaGFuZ2VzKHNpbXBsZUNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoc2ltcGxlQ2hhbmdlc1tcImlucHV0c1wiXSAmJiAhc2ltcGxlQ2hhbmdlc1tcImlucHV0c1wiXS5maXJzdENoYW5nZSkge1xuICAgICAgdGhpcy5mb3JtID0gdGhpcy50b0Zvcm1Hcm91cCh0aGlzLmlucHV0cygpKTtcbiAgICB9XG4gIH1cblxuICBvdmVycmlkZSBuZ09uRGVzdHJveSgpIHtcbiAgICBzdXBlci5uZ09uRGVzdHJveSgpO1xuICAgIHRoaXMuaW5wdXRzKCkuZm9yRWFjaCgoaW5wdXRJdGVtKSA9PiB7XG4gICAgICBpbnB1dEl0ZW0uZGVzdHJveSgpO1xuICAgIH0pO1xuICAgIGlmICh0aGlzLmFza09uRGVzdHJveSgpKSB7XG4gICAgICB0aGlzLm9uU3VibWl0KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG9uU3VibWl0KCkge1xuICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy52YWxpZC5lbWl0KHRoaXMuZm9ybS52YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgaXNWYWxpZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtLnZhbGlkICYmICF0aGlzLmxvYWRlcigpO1xuICB9XG5cbiAgcHVibGljIHRvRm9ybUdyb3VwKGlucHV0czogSW5wdXRCYXNlPGFueT5bXSk6IEZvcm1Hcm91cCB7XG4gICAgY29uc3QgZ3JvdXAgPSBuZXcgRm9ybUdyb3VwKHt9KTtcbiAgICBpZiAoaW5wdXRzID09PSBudWxsIHx8IGlucHV0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBncm91cDtcbiAgICB9XG4gICAgaW5wdXRzLmZvckVhY2goKGlucHV0KSA9PiB7XG4gICAgICBpbnB1dC5jcmVhdGVGb3JtQ29udHJvbChncm91cCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGdyb3VwO1xuICB9XG59XG4iLCI8ZGl2IGNsYXNzPVwiZm9ybS1jb250YWluZXJcIj5cbiAgPGZvcm0gKG5nU3VibWl0KT1cIm9uU3VibWl0KClcIiBbZm9ybUdyb3VwXT1cInRoaXMuZm9ybVwiPlxuICAgIEBmb3IgKGlucHV0IG9mIHRoaXMuaW5wdXRzKCk7IHRyYWNrIHRyYWNrQnlLZXkoJGluZGV4LCBpbnB1dCkpIHtcbiAgICA8ZGl2PlxuICAgICAgQGlmIChpbnB1dC52aXNpYmxlJCB8IGFzeW5jKSB7XG4gICAgICA8dGEtaW5wdXRzIFtpbnB1dF09XCJpbnB1dFwiPjwvdGEtaW5wdXRzPlxuICAgICAgfVxuICAgIDwvZGl2PlxuICAgIH1cbiAgICA8ZGl2PlxuICAgICAgPHRhLW5vdGlmaWNhdGlvbi1pbmxpbmVcbiAgICAgICAgW21lc3NhZ2VdPVwidGhpcy5lcnJvcigpLm1lc3NhZ2VcIlxuICAgICAgICBbY29kZV09XCJ0aGlzLmVycm9yKCkuc3RhdHVzXCJcbiAgICAgICAgY2xhc3M9XCJteS1zcGFjZS1zbVwiXG4gICAgICA+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJqdXN0aWZ5LWVuZFwiPlxuICAgICAgICAgIDx0YS1sb2FkZXIgW2lzTG9hZGluZ109XCJ0aGlzLmxvYWRlcigpXCI+XG4gICAgICAgICAgICBAaWYgKHRoaXMuY2FuRGlzcGxheUJ1dHRvbigpICYmIHRoaXMuYnV0dG9uVGl0bGUoKSkge1xuICAgICAgICAgICAgPHRhLWJ1dHRvblxuICAgICAgICAgICAgICAoYWN0aW9uKT1cInRoaXMub25TdWJtaXQoKVwiXG4gICAgICAgICAgICAgIFtzdGF0ZV09XCIhdGhpcy5pc1ZhbGlkKCkgPyAnZGlzYWJsZWQnIDogJ2NsYXNzaWMnXCJcbiAgICAgICAgICAgICAgaWNvbj1cImNoZWNrLWxpbmVcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICB7eyB0aGlzLmJ1dHRvblRpdGxlKCkgfCB0cmFuc2xhdGUgfX1cbiAgICAgICAgICAgIDwvdGEtYnV0dG9uPlxuICAgICAgICAgICAgfVxuICAgICAgICAgIDwvdGEtbG9hZGVyPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvdGEtbm90aWZpY2F0aW9uLWlubGluZT5cbiAgICA8L2Rpdj5cbiAgPC9mb3JtPlxuPC9kaXY+XG4iXX0=