import { signal } from '@angular/core';
import { BehaviorSubject, Subject, firstValueFrom } from 'rxjs';
import { TabulatorFull as Tabulator } from 'tabulator-tables';
import { BaseCol } from './cols/base-col';
import { BoolCol } from './cols/bool-col';
import { DateCol } from './cols/date-col';
import { EnumCol } from './cols/enum-col';
import { NumberCol } from './cols/number-col';
import { RelationCol } from './cols/relation-col';
import { StringCol } from './cols/string-col';
import { TaGridFilters } from './grid-filters';
import { ParameterType } from './types';
import { groupBy } from './utils';
export class TaGridData {
    get data() {
        return this.table?.getData() ?? [];
    }
    get dataByGroup() {
        return groupBy(this.groupBy, this.data);
    }
    get isGroup() {
        return this.groupBy !== null;
    }
    constructor(scope) {
        this.scope = scope;
        this.rowClicked$ = new Subject();
        this.table = null;
        this.cols = {};
        this.filters = null;
        this.isReady$ = new BehaviorSubject(false);
        this.isDataReady$ = new BehaviorSubject(false);
        this.tableHtml = null;
        this.displayType = signal('card');
        this.groupBy = null;
        this.totalItems = signal(0);
    }
    init(params) {
        this.table = new Tabulator(params.elementRef.nativeElement, this._getOptions(params));
        this.table.on('tableBuilt', () => {
            this.tableHtml = params.elementRef;
            this.filters = new TaGridFilters(this.scope, this.table, params.preset);
            this.isReady$.next(true);
        });
        this.table.on('rowClick', (_e, row) => {
            this.rowClicked$.next(row.getData());
        });
    }
    destroy() {
        this.table?.destroy();
    }
    setGroupBy(field) {
        this.groupBy = field;
        this.table?.setGroupBy(field);
        this.table?.setData();
    }
    clearGroupBy() {
        this.groupBy = null;
        this.table?.setGroupBy([]);
        this.table?.setData();
    }
    switchView(type) {
        this.displayType.set(type);
    }
    _getOptions(params) {
        const baseOptions = {
            height: '500px',
            layout: 'fitColumns',
            initialFilter: params.initialFilter,
            columns: this._getColumns(params.colsMetaData),
        };
        const serviceOptions = params.services
            ? {
                paginationMode: 'remote',
                pagination: true,
                paginationSize: 20,
                paginationInitialPage: 1,
                ajaxFiltering: true,
                filterMode: 'remote',
                ajaxSorting: true,
                sortMode: 'remote',
                ajaxURL: 'dummy',
                ajaxRequestFunc: (url, config, ajaxParams) => {
                    return firstValueFrom(params.services.getData$({
                        ...ajaxParams,
                        groupBy: this.groupBy,
                        colsMetaData: params.colsMetaData,
                    }));
                },
                ajaxResponse: (_, __, response) => {
                    this.isDataReady$.next(true);
                    this.totalItems.set(response.total);
                    return response;
                },
            }
            : {};
        const dataOptions = params.data
            ? {
                data: params.data,
            }
            : {};
        return { ...baseOptions, ...serviceOptions, ...dataOptions };
    }
    _getColumns(colsMetaData) {
        this.cols = Object.fromEntries(colsMetaData.map(meta => {
            const field = this._factoryCols(meta);
            return [field.key, field];
        }));
        return Object.keys(this.cols)
            .filter(key => !key.startsWith('_'))
            .map(key => ({ ...this.cols[key].getColDef() }));
    }
    _factoryCols(col) {
        switch (col.type) {
            case ParameterType.String:
                return new StringCol({ scope: this.scope, col: col }, this);
            case ParameterType.Enum:
                return new EnumCol({ scope: this.scope, col: col }, this);
            case ParameterType.Number:
                return new NumberCol({ scope: this.scope, col: col }, this);
            case ParameterType.DateTime:
                return new DateCol({ scope: this.scope, col: col }, this);
            case ParameterType.Boolean:
                return new BoolCol({ scope: this.scope, col: col }, this);
            case ParameterType.Relation:
                return new RelationCol({ scope: this.scope, col: col }, this);
            default:
                return new BaseCol({ scope: this.scope, col: col }, this);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1kYXRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9mZWF0dXJlcy9ncmlkL21vZGVscy9ncmlkLWRhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRCxPQUFPLEVBQUUsZUFBZSxFQUFjLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUUsT0FBTyxFQUE2QixhQUFhLElBQUksU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFekYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvQyxPQUFPLEVBQXVCLGFBQWEsRUFBeUQsTUFBTSxTQUFTLENBQUM7QUFDcEgsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQU1sQyxNQUFNLE9BQU8sVUFBVTtJQUNyQixJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFDRCxJQUFJLFdBQVc7UUFDYixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJ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QUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzVELEtBQUssYUFBYSxDQUFDLE9BQU87Z0JBQ3hCLE9BQU8sSUFBSSxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDNUQsS0FBSyxhQUFhLENBQUMsUUFBUTtnQkFDekIsT0FBTyxJQUFJLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNoRTtnQkFDRSxPQUFPLElBQUksT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzlELENBQUM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbGVtZW50UmVmLCBzaWduYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgZmlyc3RWYWx1ZUZyb20gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgQ29sdW1uRGVmaW5pdGlvbiwgT3B0aW9ucywgVGFidWxhdG9yRnVsbCBhcyBUYWJ1bGF0b3IgfSBmcm9tICd0YWJ1bGF0b3ItdGFibGVzJztcclxuXHJcbmltcG9ydCB7IEJhc2VDb2wgfSBmcm9tICcuL2NvbHMvYmFzZS1jb2wnO1xyXG5pbXBvcnQgeyBCb29sQ29sIH0gZnJvbSAnLi9jb2xzL2Jvb2wtY29sJztcclxuaW1wb3J0IHsgRGF0ZUNvbCB9IGZyb20gJy4vY29scy9kYXRlLWNvbCc7XHJcbmltcG9ydCB7IEVudW1Db2wgfSBmcm9tICcuL2NvbHMvZW51bS1jb2wnO1xyXG5pbXBvcnQgeyBOdW1iZXJDb2wgfSBmcm9tICcuL2NvbHMvbnVtYmVyLWNvbCc7XHJcbmltcG9ydCB7IFJlbGF0aW9uQ29sIH0gZnJvbSAnLi9jb2xzL3JlbGF0aW9uLWNvbCc7XHJcbmltcG9ydCB7IFN0cmluZ0NvbCB9IGZyb20gJy4vY29scy9zdHJpbmctY29sJztcclxuaW1wb3J0IHsgVGFHcmlkRmlsdGVycyB9IGZyb20gJy4vZ3JpZC1maWx0ZXJzJztcclxuaW1wb3J0IHsgQ29sTWV0YURhdGEsIEZpbHRlciwgUGFyYW1ldGVyVHlwZSwgUHJlc2V0LCBWaWV3VHlwZSwgYWpheFJlcXVlc3RGdW5jUGFyYW1zLCBhamF4UmVzcG9uc2UgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgZ3JvdXBCeSB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJRGF0YVNlcnZpY2U8VD4ge1xyXG4gIGdldERhdGEkOiAocGFyYW1zOiBhamF4UmVxdWVzdEZ1bmNQYXJhbXMpID0+IE9ic2VydmFibGU8YWpheFJlc3BvbnNlPFQ+PjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFRhR3JpZERhdGE8VD4ge1xyXG4gIGdldCBkYXRhKCk6IFRbXSB7XHJcbiAgICByZXR1cm4gdGhpcy50YWJsZT8uZ2V0RGF0YSgpID8/IFtdO1xyXG4gIH1cclxuICBnZXQgZGF0YUJ5R3JvdXAoKSB7XHJcbiAgICByZXR1cm4gZ3JvdXBCeSh0aGlzLmdyb3VwQnksIHRoaXMuZGF0YSk7XHJcbiAgfVxyXG4gIGdldCBpc0dyb3VwKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JvdXBCeSAhPT0gbnVsbDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSByb3dDbGlja2VkJCA9IG5ldyBTdWJqZWN0PFQ+KCk7XHJcbiAgcHVibGljIHRhYmxlOiBUYWJ1bGF0b3IgfCBudWxsID0gbnVsbDtcclxuICBwdWJsaWMgY29sczogeyBbaW5kZXg6IHN0cmluZ106IEJhc2VDb2w8YW55PiB9ID0ge307XHJcbiAgcHVibGljIGZpbHRlcnM6IFRhR3JpZEZpbHRlcnMgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGlzUmVhZHkkID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XHJcbiAgcHVibGljIHJlYWRvbmx5IGlzRGF0YVJlYWR5JCA9IG5ldyBCZWhhdmlvclN1YmplY3QoZmFsc2UpO1xyXG5cclxuICBwdWJsaWMgdGFibGVIdG1sOiBFbGVtZW50UmVmIHwgbnVsbCA9IG51bGw7XHJcbiAgcHVibGljIHJlYWRvbmx5IGRpc3BsYXlUeXBlID0gc2lnbmFsPFZpZXdUeXBlPignY2FyZCcpO1xyXG5cclxuICBwdWJsaWMgZ3JvdXBCeToga2V5b2YgVCB8IG51bGwgPSBudWxsO1xyXG4gIHB1YmxpYyByZWFkb25seSB0b3RhbEl0ZW1zID0gc2lnbmFsKDApO1xyXG5cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgc2NvcGU6IHN0cmluZykge31cclxuXHJcbiAgcHVibGljIGluaXQocGFyYW1zOiB7XHJcbiAgICBlbGVtZW50UmVmOiBFbGVtZW50UmVmO1xyXG4gICAgY29sc01ldGFEYXRhOiBDb2xNZXRhRGF0YVtdO1xyXG4gICAgZGF0YT86IFRbXTtcclxuICAgIHNlcnZpY2VzPzogSURhdGFTZXJ2aWNlPFQ+O1xyXG4gICAgaW5pdGlhbEZpbHRlcj86IEZpbHRlcltdO1xyXG4gICAgcHJlc2V0PzogUHJlc2V0W107XHJcbiAgfSkge1xyXG4gICAgdGhpcy50YWJsZSA9IG5ldyBUYWJ1bGF0b3IocGFyYW1zLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgdGhpcy5fZ2V0T3B0aW9ucyhwYXJhbXMpKTtcclxuXHJcbiAgICB0aGlzLnRhYmxlLm9uKCd0YWJsZUJ1aWx0JywgKCkgPT4ge1xyXG4gICAgICB0aGlzLnRhYmxlSHRtbCA9IHBhcmFtcy5lbGVtZW50UmVmO1xyXG4gICAgICB0aGlzLmZpbHRlcnMgPSBuZXcgVGFHcmlkRmlsdGVycyh0aGlzLnNjb3BlLCB0aGlzLnRhYmxlISwgcGFyYW1zLnByZXNldCk7XHJcbiAgICAgIHRoaXMuaXNSZWFkeSQubmV4dCh0cnVlKTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy50YWJsZS5vbigncm93Q2xpY2snLCAoX2UsIHJvdykgPT4ge1xyXG4gICAgICB0aGlzLnJvd0NsaWNrZWQkLm5leHQoPFQ+cm93LmdldERhdGEoKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkZXN0cm95KCkge1xyXG4gICAgdGhpcy50YWJsZT8uZGVzdHJveSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldEdyb3VwQnkoZmllbGQ6IHN0cmluZykge1xyXG4gICAgdGhpcy5ncm91cEJ5ID0gZmllbGQgYXMga2V5b2YgVDtcclxuICAgIHRoaXMudGFibGU/LnNldEdyb3VwQnkoZmllbGQpO1xyXG4gICAgdGhpcy50YWJsZT8uc2V0RGF0YSgpO1xyXG4gIH1cclxuICBwdWJsaWMgY2xlYXJHcm91cEJ5KCkge1xyXG4gICAgdGhpcy5ncm91cEJ5ID0gbnVsbDtcclxuICAgIHRoaXMudGFibGU/LnNldEdyb3VwQnkoW10pO1xyXG4gICAgdGhpcy50YWJsZT8uc2V0RGF0YSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN3aXRjaFZpZXcodHlwZTogVmlld1R5cGUpIHtcclxuICAgIHRoaXMuZGlzcGxheVR5cGUuc2V0KHR5cGUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZ2V0T3B0aW9ucyhwYXJhbXM6IHtcclxuICAgIGNvbHNNZXRhRGF0YTogQ29sTWV0YURhdGFbXTtcclxuICAgIGRhdGE/OiBUW107XHJcbiAgICBzZXJ2aWNlcz86IElEYXRhU2VydmljZTxUPjtcclxuICAgIGluaXRpYWxGaWx0ZXI/OiBGaWx0ZXJbXTtcclxuICB9KTogT3B0aW9ucyB7XHJcbiAgICBjb25zdCBiYXNlT3B0aW9uczogT3B0aW9ucyA9IHtcclxuICAgICAgaGVpZ2h0OiAnNTAwcHgnLFxyXG4gICAgICBsYXlvdXQ6ICdmaXRDb2x1bW5zJyxcclxuICAgICAgaW5pdGlhbEZpbHRlcjogcGFyYW1zLmluaXRpYWxGaWx0ZXIsXHJcbiAgICAgIGNvbHVtbnM6IHRoaXMuX2dldENvbHVtbnMocGFyYW1zLmNvbHNNZXRhRGF0YSksXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHNlcnZpY2VPcHRpb25zOiBPcHRpb25zID0gcGFyYW1zLnNlcnZpY2VzXHJcbiAgICAgID8ge1xyXG4gICAgICAgICAgcGFnaW5hdGlvbk1vZGU6ICdyZW1vdGUnLFxyXG4gICAgICAgICAgcGFnaW5hdGlvbjogdHJ1ZSxcclxuICAgICAgICAgIHBhZ2luYXRpb25TaXplOiAyMCxcclxuICAgICAgICAgIHBhZ2luYXRpb25Jbml0aWFsUGFnZTogMSxcclxuICAgICAgICAgIGFqYXhGaWx0ZXJpbmc6IHRydWUsXHJcbiAgICAgICAgICBmaWx0ZXJNb2RlOiAncmVtb3RlJyxcclxuICAgICAgICAgIGFqYXhTb3J0aW5nOiB0cnVlLFxyXG4gICAgICAgICAgc29ydE1vZGU6ICdyZW1vdGUnLFxyXG4gICAgICAgICAgYWpheFVSTDogJ2R1bW15JyxcclxuICAgICAgICAgIGFqYXhSZXF1ZXN0RnVuYzogKHVybDogc3RyaW5nLCBjb25maWc6IGFueSwgYWpheFBhcmFtczogYWpheFJlcXVlc3RGdW5jUGFyYW1zKTogUHJvbWlzZTxhamF4UmVzcG9uc2U8VD4+ID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGZpcnN0VmFsdWVGcm9tKFxyXG4gICAgICAgICAgICAgIHBhcmFtcy5zZXJ2aWNlcyEuZ2V0RGF0YSQoe1xyXG4gICAgICAgICAgICAgICAgLi4uYWpheFBhcmFtcyxcclxuICAgICAgICAgICAgICAgIGdyb3VwQnk6IHRoaXMuZ3JvdXBCeSBhcyBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgICBjb2xzTWV0YURhdGE6IHBhcmFtcy5jb2xzTWV0YURhdGEsXHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBhamF4UmVzcG9uc2U6IChfOiBhbnksIF9fOiBhbnksIHJlc3BvbnNlOiBhamF4UmVzcG9uc2U8VD4pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5pc0RhdGFSZWFkeSQubmV4dCh0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy50b3RhbEl0ZW1zLnNldChyZXNwb25zZS50b3RhbCk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfVxyXG4gICAgICA6IHt9O1xyXG5cclxuICAgIGNvbnN0IGRhdGFPcHRpb25zOiBPcHRpb25zID0gcGFyYW1zLmRhdGFcclxuICAgICAgPyB7XHJcbiAgICAgICAgICBkYXRhOiBwYXJhbXMuZGF0YSxcclxuICAgICAgICB9XHJcbiAgICAgIDoge307XHJcbiAgICByZXR1cm4geyAuLi5iYXNlT3B0aW9ucywgLi4uc2VydmljZU9wdGlvbnMsIC4uLmRhdGFPcHRpb25zIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9nZXRDb2x1bW5zKGNvbHNNZXRhRGF0YTogQ29sTWV0YURhdGFbXSk6IENvbHVtbkRlZmluaXRpb25bXSB7XHJcbiAgICB0aGlzLmNvbHMgPSBPYmplY3QuZnJvbUVudHJpZXMoXHJcbiAgICAgIGNvbHNNZXRhRGF0YS5tYXAobWV0YSA9PiB7XHJcbiAgICAgICAgY29uc3QgZmllbGQgPSB0aGlzLl9mYWN0b3J5Q29scyhtZXRhKTtcclxuICAgICAgICByZXR1cm4gW2ZpZWxkLmtleSwgZmllbGRdO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5jb2xzKVxyXG4gICAgICAuZmlsdGVyKGtleSA9PiAha2V5LnN0YXJ0c1dpdGgoJ18nKSlcclxuICAgICAgLm1hcChrZXkgPT4gKHsgLi4udGhpcy5jb2xzW2tleV0uZ2V0Q29sRGVmKCkgfSkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZmFjdG9yeUNvbHMoY29sOiBDb2xNZXRhRGF0YSk6IEJhc2VDb2w8YW55PiB7XHJcbiAgICBzd2l0Y2ggKGNvbC50eXBlKSB7XHJcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5TdHJpbmc6XHJcbiAgICAgICAgcmV0dXJuIG5ldyBTdHJpbmdDb2woeyBzY29wZTogdGhpcy5zY29wZSwgY29sOiBjb2wgfSwgdGhpcyk7XHJcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5FbnVtOlxyXG4gICAgICAgIHJldHVybiBuZXcgRW51bUNvbCh7IHNjb3BlOiB0aGlzLnNjb3BlLCBjb2w6IGNvbCB9LCB0aGlzKTtcclxuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLk51bWJlcjpcclxuICAgICAgICByZXR1cm4gbmV3IE51bWJlckNvbCh7IHNjb3BlOiB0aGlzLnNjb3BlLCBjb2w6IGNvbCB9LCB0aGlzKTtcclxuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkRhdGVUaW1lOlxyXG4gICAgICAgIHJldHVybiBuZXcgRGF0ZUNvbCh7IHNjb3BlOiB0aGlzLnNjb3BlLCBjb2w6IGNvbCB9LCB0aGlzKTtcclxuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkJvb2xlYW46XHJcbiAgICAgICAgcmV0dXJuIG5ldyBCb29sQ29sKHsgc2NvcGU6IHRoaXMuc2NvcGUsIGNvbDogY29sIH0sIHRoaXMpO1xyXG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuUmVsYXRpb246XHJcbiAgICAgICAgcmV0dXJuIG5ldyBSZWxhdGlvbkNvbCh7IHNjb3BlOiB0aGlzLnNjb3BlLCBjb2w6IGNvbCB9LCB0aGlzKTtcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZXR1cm4gbmV3IEJhc2VDb2woeyBzY29wZTogdGhpcy5zY29wZSwgY29sOiBjb2wgfSwgdGhpcyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==