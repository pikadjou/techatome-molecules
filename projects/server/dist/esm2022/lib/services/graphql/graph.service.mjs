import { Inject, Injectable, Optional, inject } from "@angular/core";
import { ApolloClient, ApolloLink, InMemoryCache, } from "@apollo/client/core";
import { BehaviorSubject, catchError, filter, map, switchMap, take, tap, throwError, } from "rxjs";
import { isURL } from "@ta/utils";
import { TaServerErrorService } from "../error.service";
import { Logger } from "../logger";
import { GRAPHQL_SERVER_CONFIG, } from "./public-api";
import * as i0 from "@angular/core";
import * as i1 from "apollo-angular/http";
import * as i2 from "apollo-angular";
export class TaGraphService {
    constructor(_graphConfig, httpLink, apollo) {
        this._graphConfig = _graphConfig;
        this.httpLink = httpLink;
        this.apollo = apollo;
        this.isReady$ = new BehaviorSubject(true);
        this._errorServices = inject(TaServerErrorService);
        this._defaultEndpoint = new ApolloLink((operation, forward) => {
            return forward(operation);
        });
        this._cache = new InMemoryCache();
        this.apollo.client = new ApolloClient({
            cache: this._cache,
            link: this._defaultEndpoint,
        });
    }
    clearCache(key) {
        this._cache.evict({
            fieldName: key,
        });
    }
    fetchQueryList(payload, node, context) {
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo("[GraphQL] [Query] fetchQueryList:", {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo
            .query(this._setupData(payload, context))
            .pipe(tap((data) => Logger.LogInfo("[GraphQL] [Response] fetchQueryList:", {
            data,
            node,
            context,
        })), filter((response) => !!response.data), map((response) => response.data[node]), catchError((err) => {
            Logger.LogError("[GraphQL] [Error] fetchQueryList:", {
                payload,
                node,
                context,
                message: err.message,
            });
            //this._errorServices.addError(err);
            return throwError(() => err);
        }), catchError((err) => {
            Logger.LogError("[GraphQL] [Error] fetchPagedQueryList:", {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchPagedQueryList(payload, node, context) {
        Logger.LogInfo("[GraphQL] [Prepare] fetchPagedQueryList:", {
            payload,
            node,
            context,
        });
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo("[GraphQL] [Query] fetchPagedQueryList:", {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo
            .query(this._setupData(payload, context))
            .pipe(tap((data) => Logger.LogInfo("[GraphQL] [Response] fetchPagedQueryList:", {
            data,
            node,
            context,
        })), filter((response) => !!response.data), map((response) => response.data[node]), catchError((err) => {
            Logger.LogError("[GraphQL] [Error] fetchPagedQueryList:", {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchQuery(payload, node, context) {
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo("[GraphQL] [Query] fetchQuery:", {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo
            .query(this._setupData(payload, context))
            .pipe(tap((data) => Logger.LogInfo("[GraphQL] [Response] fetchQuery:", {
            data,
            node,
            context,
        })), filter((response) => !!response.data), map((data) => data.data[node]), catchError((err) => {
            Logger.LogError("[GraphQL] [Error] fetchPagedQueryList:", {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    mutate(payload, mutationName, context, clearCache) {
        Logger.LogInfo("[GraphQL]  [Prepare] mutate", payload, mutationName);
        return this.apollo
            .mutate(this._setupData(payload, context))
            .pipe(tap((data) => Logger.LogInfo("[GraphQL] [Reponse] mutate", data)), filter((response) => !!response.data), tap(() => clearCache?.forEach((cacheKey) => this.clearCache(cacheKey))), map((response) => {
            return response.data[mutationName];
        }), catchError((err) => {
            Logger.LogError("[GraphQL] [Error] fetchPagedQueryList:", {
                payload,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }));
    }
    registerGraphEndpoint(graphEndpoint, options) {
        const url = options?.visitor === true && this._graphConfig?.visitor
            ? this._graphConfig?.visitor
            : this._graphConfig?.url;
        let uri = isURL(graphEndpoint.endpoint)
            ? graphEndpoint.endpoint
            : url + graphEndpoint.endpoint;
        const newHttpLink = this.httpLink.create({
            headers: graphEndpoint.headers,
            uri: uri,
        });
        this.apollo.client.setLink(this.apollo.client.link.concat(ApolloLink.split((operation) => operation.getContext()["clientName"] === graphEndpoint.clientName, newHttpLink)));
    }
    _setupData(payload, context) {
        return { ...payload, ...{ context: { clientName: context } } };
    }
    _getWrapper(data) {
        return this.isReady$;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaGraphService, deps: [{ token: GRAPHQL_SERVER_CONFIG, optional: true }, { token: i1.HttpLink }, { token: i2.Apollo }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaGraphService, providedIn: "root" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaGraphService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [GRAPHQL_SERVER_CONFIG]
                }] }, { type: i1.HttpLink }, { type: i2.Apollo }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvc2VydmljZXMvZ3JhcGhxbC9ncmFwaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckUsT0FBTyxFQUNMLFlBQVksRUFFWixVQUFVLEVBQ1YsYUFBYSxHQUNkLE1BQU0scUJBQXFCLENBQUM7QUFHN0IsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YsTUFBTSxFQUNOLEdBQUcsRUFDSCxTQUFTLEVBQ1QsSUFBSSxFQUNKLEdBQUcsRUFDSCxVQUFVLEdBQ1gsTUFBTSxNQUFNLENBQUM7QUFFZCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRWxDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFLbkMsT0FBTyxFQUNMLHFCQUFxQixHQUd0QixNQUFNLGNBQWMsQ0FBQzs7OztBQVd0QixNQUFNLE9BQU8sY0FBYztJQU96QixZQUdVLFlBQTBCLEVBQzFCLFFBQWtCLEVBQ2xCLE1BQWM7UUFGZCxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFYakIsYUFBUSxHQUFHLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxDQUFDO1FBRTdDLG1CQUFjLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFXcEQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQzVELE9BQU8sT0FBTyxDQUFDLFNBQVMsQ0FBQyxD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O1FBRTdCLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDO1lBQ3JDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUTtZQUN4QixDQUFDLENBQUMsR0FBRyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7UUFFakMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDdkMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPO1lBQzlCLEdBQUcsRUFBRSxHQUFHO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUN4QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUM1QixVQUFVLENBQUMsS0FBSyxDQUNkLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FDWixTQUFTLENBQUMsVUFBVSxFQUFFLENBQUMsWUFBWSxDQUFDLEtBQUssYUFBYSxDQUFDLFVBQVUsRUFDbkUsV0FBVyxDQUNaLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVPLFVBQVUsQ0FBSSxPQUFVLEVBQUUsT0FBZTtRQUMvQyxPQUFPLEVBQUUsR0FBRyxPQUFPLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDakUsQ0FBQztJQUVPLFdBQVcsQ0FBQyxJQUFrQjtRQUNwQyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQzsrR0FoUFUsY0FBYyxrQkFTZixxQkFBcUI7bUhBVHBCLGNBQWMsY0FGYixNQUFNOzs0RkFFUCxjQUFjO2tCQUgxQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBU0ksUUFBUTs7MEJBQ1IsTUFBTTsyQkFBQyxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsLCBpbmplY3QgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG5pbXBvcnQge1xuICBBcG9sbG9DbGllbnQsXG4gIEFwb2xsb0Vycm9yLFxuICBBcG9sbG9MaW5rLFxuICBJbk1lbW9yeUNhY2hlLFxufSBmcm9tIFwiQGFwb2xsby9jbGllbnQvY29yZVwiO1xuaW1wb3J0IHsgQXBvbGxvIH0gZnJvbSBcImFwb2xsby1hbmd1bGFyXCI7XG5pbXBvcnQgeyBIdHRwTGluayB9IGZyb20gXCJhcG9sbG8tYW5ndWxhci9odHRwXCI7XG5pbXBvcnQge1xuICBCZWhhdmlvclN1YmplY3QsXG4gIGNhdGNoRXJyb3IsXG4gIGZpbHRlcixcbiAgbWFwLFxuICBzd2l0Y2hNYXAsXG4gIHRha2UsXG4gIHRhcCxcbiAgdGhyb3dFcnJvcixcbn0gZnJvbSBcInJ4anNcIjtcblxuaW1wb3J0IHsgaXNVUkwgfSBmcm9tIFwiQHRhL3V0aWxzXCI7XG5cbmltcG9ydCB7IFRhU2VydmVyRXJyb3JTZXJ2aWNlIH0gZnJvbSBcIi4uL2Vycm9yLnNlcnZpY2VcIjtcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gXCIuLi9sb2dnZXJcIjtcbmltcG9ydCB7IEdyYXBoTXV0YXRpb25QYXlsb2FkLCBHcmFwaFF1ZXJ5UGF5bG9hZCB9IGZyb20gXCIuL21vZGVscy9ncmFwaFBheWxvYWRcIjtcbmltcG9ydCB7IEdyYXBoUmVwb25zZURhdGEgfSBmcm9tIFwiLi9tb2RlbHMvZ3JhcGhSZXNwb25zZURhdGFcIjtcbmltcG9ydCB7IEdyYXBoUmVwb25zZVBhZ2VkRGF0YSB9IGZyb20gXCIuL21vZGVscy9ncmFwaFJlc3BvbnNlUGFnZWREYXRhXCI7XG5pbXBvcnQgeyBSZXBvbnNlTXV0YXRpb25EYXRhIH0gZnJvbSBcIi4vbW9kZWxzL3Jlc3BvbnNlRGF0YVwiO1xuaW1wb3J0IHtcbiAgR1JBUEhRTF9TRVJWRVJfQ09ORklHLFxuICBHcmFwaEVuZHBvaW50LFxuICBJR3JhcGhDb25maWcsXG59IGZyb20gXCIuL3B1YmxpYy1hcGlcIjtcblxuZXhwb3J0IHR5cGUgR3JhcGhPcHRpb25zID0ge1xuICB2aXNpdG9yOiBib29sZWFuO1xufTtcbnR5cGUgV3JhcHBlckRhdGEgPSB7XG4gIGNvbnRleHQ/OiBzdHJpbmc7XG59O1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiBcInJvb3RcIixcbn0pXG5leHBvcnQgY2xhc3MgVGFHcmFwaFNlcnZpY2Uge1xuICBwdWJsaWMgaXNSZWFkeSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuXG4gIHByaXZhdGUgX2Vycm9yU2VydmljZXMgPSBpbmplY3QoVGFTZXJ2ZXJFcnJvclNlcnZpY2UpO1xuXG4gIHByaXZhdGUgX2RlZmF1bHRFbmRwb2ludDtcbiAgcHJpdmF0ZSBfY2FjaGU7XG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChHUkFQSFFMX1NFUlZFUl9DT05GSUcpXG4gICAgcHJpdmF0ZSBfZ3JhcGhDb25maWc6IElHcmFwaENvbmZpZyxcbiAgICBwcml2YXRlIGh0dHBMaW5rOiBIdHRwTGluayxcbiAgICBwcml2YXRlIGFwb2xsbzogQXBvbGxvXG4gICkge1xuICAgIHRoaXMuX2RlZmF1bHRFbmRwb2ludCA9IG5ldyBBcG9sbG9MaW5rKChvcGVyYXRpb24sIGZvcndhcmQpID0+IHtcbiAgICAgIHJldHVybiBmb3J3YXJkKG9wZXJhdGlvbik7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9jYWNoZSA9IG5ldyBJbk1lbW9yeUNhY2hlKCk7XG5cbiAgICB0aGlzLmFwb2xsby5jbGllbnQgPSBuZXcgQXBvbGxvQ2xpZW50KHtcbiAgICAgIGNhY2hlOiB0aGlzLl9jYWNoZSxcbiAgICAgIGxpbms6IHRoaXMuX2RlZmF1bHRFbmRwb2ludCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhckNhY2hlKGtleTogc3RyaW5nKSB7XG4gICAgdGhpcy5fY2FjaGUuZXZpY3Qoe1xuICAgICAgZmllbGROYW1lOiBrZXksXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hRdWVyeUxpc3Q8VD4oXG4gICAgcGF5bG9hZDogR3JhcGhRdWVyeVBheWxvYWQsXG4gICAgbm9kZTogc3RyaW5nLFxuICAgIGNvbnRleHQ6IHN0cmluZ1xuICApIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0V3JhcHBlcih7IGNvbnRleHQgfSkucGlwZShcbiAgICAgIHRhcCgoKSA9PlxuICAgICAgICBMb2dnZXIuTG9nSW5mbyhcIltHcmFwaFFMXSBbUXVlcnldIGZldGNoUXVlcnlMaXN0OlwiLCB7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHRoaXMuYXBvbGxvXG4gICAgICAgICAgLnF1ZXJ5PEdyYXBoUmVwb25zZURhdGE8VFtdPj4odGhpcy5fc2V0dXBEYXRhKHBheWxvYWQsIGNvbnRleHQpKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgdGFwKChkYXRhKSA9PlxuICAgICAgICAgICAgICBMb2dnZXIuTG9nSW5mbyhcIltHcmFwaFFMXSBbUmVzcG9uc2VdIGZldGNoUXVlcnlMaXN0OlwiLCB7XG4gICAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgZmlsdGVyKChyZXNwb25zZSkgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgICAgICAgIG1hcCgocmVzcG9uc2UpID0+IHJlc3BvbnNlLmRhdGFbbm9kZV0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICAgICAgICBMb2dnZXIuTG9nRXJyb3IoXCJbR3JhcGhRTF0gW0Vycm9yXSBmZXRjaFF1ZXJ5TGlzdDpcIiwge1xuICAgICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgLy90aGlzLl9lcnJvclNlcnZpY2VzLmFkZEVycm9yKGVycik7XG4gICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogQXBvbGxvRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKFwiW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDpcIiwge1xuICAgICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICB0aGlzLl9lcnJvclNlcnZpY2VzLmFkZEVycm9yKHBheWxvYWQsIGVycik7XG4gICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICksXG4gICAgICB0YWtlKDEpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaFBhZ2VkUXVlcnlMaXN0PFQ+KFxuICAgIHBheWxvYWQ6IEdyYXBoUXVlcnlQYXlsb2FkLFxuICAgIG5vZGU6IHN0cmluZyxcbiAgICBjb250ZXh0OiBzdHJpbmdcbiAgKSB7XG4gICAgTG9nZ2VyLkxvZ0luZm8oXCJbR3JhcGhRTF0gW1ByZXBhcmVdIGZldGNoUGFnZWRRdWVyeUxpc3Q6XCIsIHtcbiAgICAgIHBheWxvYWQsXG4gICAgICBub2RlLFxuICAgICAgY29udGV4dCxcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5fZ2V0V3JhcHBlcih7IGNvbnRleHQgfSkucGlwZShcbiAgICAgIHRhcCgoKSA9PlxuICAgICAgICBMb2dnZXIuTG9nSW5mbyhcIltHcmFwaFFMXSBbUXVlcnldIGZldGNoUGFnZWRRdWVyeUxpc3Q6XCIsIHtcbiAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgdGhpcy5hcG9sbG9cbiAgICAgICAgICAucXVlcnk8R3JhcGhSZXBvbnNlUGFnZWREYXRhPFQ+Pih0aGlzLl9zZXR1cERhdGEocGF5bG9hZCwgY29udGV4dCkpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICB0YXAoKGRhdGEpID0+XG4gICAgICAgICAgICAgIExvZ2dlci5Mb2dJbmZvKFwiW0dyYXBoUUxdIFtSZXNwb25zZV0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDpcIiwge1xuICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGZpbHRlcigocmVzcG9uc2UpID0+ICEhcmVzcG9uc2UuZGF0YSksXG4gICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiByZXNwb25zZS5kYXRhW25vZGVdKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogQXBvbGxvRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKFwiW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDpcIiwge1xuICAgICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICB0aGlzLl9lcnJvclNlcnZpY2VzLmFkZEVycm9yKHBheWxvYWQsIGVycik7XG4gICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICksXG4gICAgICB0YWtlKDEpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaFF1ZXJ5PFQ+KFxuICAgIHBheWxvYWQ6IEdyYXBoUXVlcnlQYXlsb2FkLFxuICAgIG5vZGU6IHN0cmluZyxcbiAgICBjb250ZXh0OiBzdHJpbmdcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldFdyYXBwZXIoeyBjb250ZXh0IH0pLnBpcGUoXG4gICAgICB0YXAoKCkgPT5cbiAgICAgICAgTG9nZ2VyLkxvZ0luZm8oXCJbR3JhcGhRTF0gW1F1ZXJ5XSBmZXRjaFF1ZXJ5OlwiLCB7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHRoaXMuYXBvbGxvXG4gICAgICAgICAgLnF1ZXJ5PEdyYXBoUmVwb25zZURhdGE8VD4+KHRoaXMuX3NldHVwRGF0YShwYXlsb2FkLCBjb250ZXh0KSlcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHRhcCgoZGF0YSkgPT5cbiAgICAgICAgICAgICAgTG9nZ2VyLkxvZ0luZm8oXCJbR3JhcGhRTF0gW1Jlc3BvbnNlXSBmZXRjaFF1ZXJ5OlwiLCB7XG4gICAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgZmlsdGVyKChyZXNwb25zZSkgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgICAgICAgIG1hcCgoZGF0YSkgPT4gZGF0YS5kYXRhW25vZGVdKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogQXBvbGxvRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKFwiW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDpcIiwge1xuICAgICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICB0aGlzLl9lcnJvclNlcnZpY2VzLmFkZEVycm9yKHBheWxvYWQsIGVycik7XG4gICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICksXG4gICAgICB0YWtlKDEpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBtdXRhdGU8VD4oXG4gICAgcGF5bG9hZDogR3JhcGhNdXRhdGlvblBheWxvYWQsXG4gICAgbXV0YXRpb25OYW1lOiBzdHJpbmcsXG4gICAgY29udGV4dDogc3RyaW5nLFxuICAgIGNsZWFyQ2FjaGU/OiBzdHJpbmdbXVxuICApIHtcbiAgICBMb2dnZXIuTG9nSW5mbyhcIltHcmFwaFFMXSAgW1ByZXBhcmVdIG11dGF0ZVwiLCBwYXlsb2FkLCBtdXRhdGlvbk5hbWUpO1xuICAgIHJldHVybiB0aGlzLmFwb2xsb1xuICAgICAgLm11dGF0ZTxSZXBvbnNlTXV0YXRpb25EYXRhPFQ+Pih0aGlzLl9zZXR1cERhdGEocGF5bG9hZCwgY29udGV4dCkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKChkYXRhKSA9PiBMb2dnZXIuTG9nSW5mbyhcIltHcmFwaFFMXSBbUmVwb25zZV0gbXV0YXRlXCIsIGRhdGEpKSxcbiAgICAgICAgZmlsdGVyKChyZXNwb25zZSkgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgICAgdGFwKCgpID0+IGNsZWFyQ2FjaGU/LmZvckVhY2goKGNhY2hlS2V5KSA9PiB0aGlzLmNsZWFyQ2FjaGUoY2FjaGVLZXkpKSksXG4gICAgICAgIG1hcCgocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2UhLmRhdGEhW211dGF0aW9uTmFtZV07XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKChlcnI6IEFwb2xsb0Vycm9yKSA9PiB7XG4gICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKFwiW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDpcIiwge1xuICAgICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHRoaXMuX2Vycm9yU2VydmljZXMuYWRkRXJyb3IocGF5bG9hZCwgZXJyKTtcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnIpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHB1YmxpYyByZWdpc3RlckdyYXBoRW5kcG9pbnQoXG4gICAgZ3JhcGhFbmRwb2ludDogR3JhcGhFbmRwb2ludCxcbiAgICBvcHRpb25zPzogR3JhcGhPcHRpb25zXG4gICkge1xuICAgIGNvbnN0IHVybCA9XG4gICAgICBvcHRpb25zPy52aXNpdG9yID09PSB0cnVlICYmIHRoaXMuX2dyYXBoQ29uZmlnPy52aXNpdG9yXG4gICAgICAgID8gdGhpcy5fZ3JhcGhDb25maWc/LnZpc2l0b3JcbiAgICAgICAgOiB0aGlzLl9ncmFwaENvbmZpZz8udXJsO1xuXG4gICAgbGV0IHVyaSA9IGlzVVJMKGdyYXBoRW5kcG9pbnQuZW5kcG9pbnQpXG4gICAgICA/IGdyYXBoRW5kcG9pbnQuZW5kcG9pbnRcbiAgICAgIDogdXJsICsgZ3JhcGhFbmRwb2ludC5lbmRwb2ludDtcblxuICAgIGNvbnN0IG5ld0h0dHBMaW5rID0gdGhpcy5odHRwTGluay5jcmVhdGUoe1xuICAgICAgaGVhZGVyczogZ3JhcGhFbmRwb2ludC5oZWFkZXJzLFxuICAgICAgdXJpOiB1cmksXG4gICAgfSk7XG5cbiAgICB0aGlzLmFwb2xsby5jbGllbnQuc2V0TGluayhcbiAgICAgIHRoaXMuYXBvbGxvLmNsaWVudC5saW5rLmNvbmNhdChcbiAgICAgICAgQXBvbGxvTGluay5zcGxpdChcbiAgICAgICAgICAob3BlcmF0aW9uKSA9PlxuICAgICAgICAgICAgb3BlcmF0aW9uLmdldENvbnRleHQoKVtcImNsaWVudE5hbWVcIl0gPT09IGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSxcbiAgICAgICAgICBuZXdIdHRwTGlua1xuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldHVwRGF0YTxUPihwYXlsb2FkOiBULCBjb250ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4geyAuLi5wYXlsb2FkLCAuLi57IGNvbnRleHQ6IHsgY2xpZW50TmFtZTogY29udGV4dCB9IH0gfTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFdyYXBwZXIoZGF0YT86IFdyYXBwZXJEYXRhKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNSZWFkeSQ7XG4gIH1cbn1cbiJdfQ==