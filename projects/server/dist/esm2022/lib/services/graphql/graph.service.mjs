import { Inject, Injectable, Optional, inject } from '@angular/core';
import { ApolloClient, ApolloLink, InMemoryCache } from '@apollo/client/core';
import { BehaviorSubject, catchError, filter, map, switchMap, take, tap, throwError } from 'rxjs';
import { isURL } from '@ta/utils';
import { TaServerErrorService } from '../error.service';
import { Logger } from '../logger';
import { GRAPHQL_SERVER_CONFIG } from './public-api';
import * as i0 from "@angular/core";
import * as i1 from "apollo-angular/http";
import * as i2 from "apollo-angular";
export class TaGraphService {
    constructor(_graphConfig, httpLink, apollo) {
        this._graphConfig = _graphConfig;
        this.httpLink = httpLink;
        this.apollo = apollo;
        this.isReady$ = new BehaviorSubject(true);
        this._errorServices = inject(TaServerErrorService);
        this._defaultEndpoint = new ApolloLink((operation, forward) => {
            return forward(operation);
        });
        this._cache = new InMemoryCache();
        this.apollo.client = new ApolloClient({
            cache: this._cache,
            link: this._defaultEndpoint,
        });
    }
    clearCache(key) {
        this._cache.evict({
            fieldName: key,
        });
    }
    fetchQueryList(payload, node, context) {
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchQueryList:', {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchQueryList:', {
            data,
            node,
            context,
        })), filter(response => !!response.data), map(response => response.data[node]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            //this._errorServices.addError(err);
            return throwError(() => err);
        }), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchPagedQueryList(payload, node, context) {
        Logger.LogInfo('[GraphQL] [Prepare] fetchPagedQueryList:', {
            payload,
            node,
            context,
        });
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchPagedQueryList:', {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchPagedQueryList:', {
            data,
            node,
            context,
        })), filter(response => !!response.data), map(response => response.data[node]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchQueryBuilder(payload, context) {
        Logger.LogInfo('[GraphQL] [Prepare] fetchQueryBuilder:', {
            payload,
            context,
        });
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchQueryBuilder:', {
            payload,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchQueryBuilder:', {
            data,
            context,
        })), filter(response => !!response.data), map(response => response.data[payload.name]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchQueryBuilder:', {
                payload,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchQuery(payload, node, context) {
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchQuery:', {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchQuery:', {
            data,
            node,
            context,
        })), filter(response => !!response.data), map(data => data.data[node]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    mutate(payload, mutationName, context, clearCache) {
        Logger.LogInfo('[GraphQL]  [Prepare] mutate', payload, mutationName);
        return this.apollo.mutate(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Reponse] mutate', data)), filter(response => !!response.data), tap(() => clearCache?.forEach(cacheKey => this.clearCache(cacheKey))), map(response => {
            return response.data[mutationName];
        }), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }));
    }
    registerGraphEndpoint(graphEndpoint, options) {
        const url = options?.visitor === true && this._graphConfig?.visitor ? this._graphConfig?.visitor : this._graphConfig?.url;
        let uri = isURL(graphEndpoint.endpoint) ? graphEndpoint.endpoint : url + graphEndpoint.endpoint;
        const newHttpLink = this.httpLink.create({
            headers: graphEndpoint.headers,
            uri: uri,
        });
        this.apollo.client.setLink(this.apollo.client.link.concat(ApolloLink.split(operation => operation.getContext()['clientName'] === graphEndpoint.clientName, newHttpLink)));
    }
    _setupData(payload, context) {
        return { ...payload, ...{ context: { clientName: context } } };
    }
    _getWrapper(data) {
        return this.isReady$;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaGraphService, deps: [{ token: GRAPHQL_SERVER_CONFIG, optional: true }, { token: i1.HttpLink }, { token: i2.Apollo }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaGraphService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaGraphService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [GRAPHQL_SERVER_CONFIG]
                }] }, { type: i1.HttpLink }, { type: i2.Apollo }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvc2VydmljZXMvZ3JhcGhxbC9ncmFwaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckUsT0FBTyxFQUFFLFlBQVksRUFBZSxVQUFVLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHM0YsT0FBTyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEcsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVsQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBS25DLE9BQU8sRUFBRSxxQkFBcUIsRUFBK0IsTUFBTSxjQUFjLENBQUM7Ozs7QUFXbEYsTUFBTSxPQUFPLGNBQWM7SUFPekIsWUFHVSxZQUEwQixFQUMxQixRQUFrQixFQUNsQixNQUFjO1FBRmQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBWGpCLGFBQVEsR0FBRyxJQUFJLGVBQWUsQ0FBVSxJQUFJLENBQUMsQ0FBQztRQUU3QyxtQkFBYyxHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBV3BELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUM1RCxPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUMs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QUFHLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7UUFFaEcsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDdkMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPO1lBQzlCLEdBQUcsRUFBRSxHQUFHO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUN4QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUM1QixVQUFVLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDLFlBQVksQ0FBQyxLQUFLLGFBQWEsQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQzlHLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyxVQUFVLENBQUksT0FBVSxFQUFFLE9BQWU7UUFDL0MsT0FBTyxFQUFFLEdBQUcsT0FBTyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQ2pFLENBQUM7SUFFTyxXQUFXLENBQUMsSUFBa0I7UUFDcEMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7K0dBbFBVLGNBQWMsa0JBU2YscUJBQXFCO21IQVRwQixjQUFjLGNBRmIsTUFBTTs7NEZBRVAsY0FBYztrQkFIMUIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQVNJLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCwgaW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEFwb2xsb0NsaWVudCwgQXBvbGxvRXJyb3IsIEFwb2xsb0xpbmssIEluTWVtb3J5Q2FjaGUgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9jb3JlJztcbmltcG9ydCB7IEFwb2xsbyB9IGZyb20gJ2Fwb2xsby1hbmd1bGFyJztcbmltcG9ydCB7IEh0dHBMaW5rIH0gZnJvbSAnYXBvbGxvLWFuZ3VsYXIvaHR0cCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNhdGNoRXJyb3IsIGZpbHRlciwgbWFwLCBzd2l0Y2hNYXAsIHRha2UsIHRhcCwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBpc1VSTCB9IGZyb20gJ0B0YS91dGlscyc7XG5cbmltcG9ydCB7IFRhU2VydmVyRXJyb3JTZXJ2aWNlIH0gZnJvbSAnLi4vZXJyb3Iuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgR3JhcGhNdXRhdGlvblBheWxvYWQsIEdyYXBoUGF5bG9hZCwgR3JhcGhRdWVyeVBheWxvYWQgfSBmcm9tICcuL21vZGVscy9ncmFwaFBheWxvYWQnO1xuaW1wb3J0IHsgR3JhcGhSZXBvbnNlRGF0YSB9IGZyb20gJy4vbW9kZWxzL2dyYXBoUmVzcG9uc2VEYXRhJztcbmltcG9ydCB7IEdyYXBoUmVwb25zZVBhZ2VkRGF0YSB9IGZyb20gJy4vbW9kZWxzL2dyYXBoUmVzcG9uc2VQYWdlZERhdGEnO1xuaW1wb3J0IHsgUmVwb25zZU11dGF0aW9uRGF0YSB9IGZyb20gJy4vbW9kZWxzL3Jlc3BvbnNlRGF0YSc7XG5pbXBvcnQgeyBHUkFQSFFMX1NFUlZFUl9DT05GSUcsIEdyYXBoRW5kcG9pbnQsIElHcmFwaENvbmZpZyB9IGZyb20gJy4vcHVibGljLWFwaSc7XG5cbmV4cG9ydCB0eXBlIEdyYXBoT3B0aW9ucyA9IHtcbiAgdmlzaXRvcjogYm9vbGVhbjtcbn07XG50eXBlIFdyYXBwZXJEYXRhID0ge1xuICBjb250ZXh0Pzogc3RyaW5nO1xufTtcbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBUYUdyYXBoU2VydmljZSB7XG4gIHB1YmxpYyBpc1JlYWR5JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odHJ1ZSk7XG5cbiAgcHJpdmF0ZSBfZXJyb3JTZXJ2aWNlcyA9IGluamVjdChUYVNlcnZlckVycm9yU2VydmljZSk7XG5cbiAgcHJpdmF0ZSBfZGVmYXVsdEVuZHBvaW50O1xuICBwcml2YXRlIF9jYWNoZTtcbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KEdSQVBIUUxfU0VSVkVSX0NPTkZJRylcbiAgICBwcml2YXRlIF9ncmFwaENvbmZpZzogSUdyYXBoQ29uZmlnLFxuICAgIHByaXZhdGUgaHR0cExpbms6IEh0dHBMaW5rLFxuICAgIHByaXZhdGUgYXBvbGxvOiBBcG9sbG9cbiAgKSB7XG4gICAgdGhpcy5fZGVmYXVsdEVuZHBvaW50ID0gbmV3IEFwb2xsb0xpbmsoKG9wZXJhdGlvbiwgZm9yd2FyZCkgPT4ge1xuICAgICAgcmV0dXJuIGZvcndhcmQob3BlcmF0aW9uKTtcbiAgICB9KTtcblxuICAgIHRoaXMuX2NhY2hlID0gbmV3IEluTWVtb3J5Q2FjaGUoKTtcblxuICAgIHRoaXMuYXBvbGxvLmNsaWVudCA9IG5ldyBBcG9sbG9DbGllbnQoe1xuICAgICAgY2FjaGU6IHRoaXMuX2NhY2hlLFxuICAgICAgbGluazogdGhpcy5fZGVmYXVsdEVuZHBvaW50LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGNsZWFyQ2FjaGUoa2V5OiBzdHJpbmcpIHtcbiAgICB0aGlzLl9jYWNoZS5ldmljdCh7XG4gICAgICBmaWVsZE5hbWU6IGtleSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaFF1ZXJ5TGlzdDxUPihwYXlsb2FkOiBHcmFwaFF1ZXJ5UGF5bG9hZCwgbm9kZTogc3RyaW5nLCBjb250ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0V3JhcHBlcih7IGNvbnRleHQgfSkucGlwZShcbiAgICAgIHRhcCgoKSA9PlxuICAgICAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtRdWVyeV0gZmV0Y2hRdWVyeUxpc3Q6Jywge1xuICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICB9KVxuICAgICAgKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICB0aGlzLmFwb2xsby5xdWVyeTxHcmFwaFJlcG9uc2VEYXRhPFRbXT4+KHRoaXMuX3NldHVwRGF0YShwYXlsb2FkLCBjb250ZXh0KSkucGlwZShcbiAgICAgICAgICB0YXAoZGF0YSA9PlxuICAgICAgICAgICAgTG9nZ2VyLkxvZ0luZm8oJ1tHcmFwaFFMXSBbUmVzcG9uc2VdIGZldGNoUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKSxcbiAgICAgICAgICBmaWx0ZXIocmVzcG9uc2UgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gcmVzcG9uc2UuZGF0YVtub2RlXSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbR3JhcGhRTF0gW0Vycm9yXSBmZXRjaFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvL3RoaXMuX2Vycm9yU2VydmljZXMuYWRkRXJyb3IoZXJyKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbR3JhcGhRTF0gW0Vycm9yXSBmZXRjaFBhZ2VkUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fZXJyb3JTZXJ2aWNlcy5hZGRFcnJvcihwYXlsb2FkLCBlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyKTtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApLFxuICAgICAgdGFrZSgxKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hQYWdlZFF1ZXJ5TGlzdDxUPihwYXlsb2FkOiBHcmFwaFF1ZXJ5UGF5bG9hZCwgbm9kZTogc3RyaW5nLCBjb250ZXh0OiBzdHJpbmcpIHtcbiAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtQcmVwYXJlXSBmZXRjaFBhZ2VkUXVlcnlMaXN0OicsIHtcbiAgICAgIHBheWxvYWQsXG4gICAgICBub2RlLFxuICAgICAgY29udGV4dCxcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5fZ2V0V3JhcHBlcih7IGNvbnRleHQgfSkucGlwZShcbiAgICAgIHRhcCgoKSA9PlxuICAgICAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtRdWVyeV0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHRoaXMuYXBvbGxvLnF1ZXJ5PEdyYXBoUmVwb25zZVBhZ2VkRGF0YTxUPj4odGhpcy5fc2V0dXBEYXRhKHBheWxvYWQsIGNvbnRleHQpKS5waXBlKFxuICAgICAgICAgIHRhcChkYXRhID0+XG4gICAgICAgICAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtSZXNwb25zZV0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICksXG4gICAgICAgICAgZmlsdGVyKHJlc3BvbnNlID0+ICEhcmVzcG9uc2UuZGF0YSksXG4gICAgICAgICAgbWFwKHJlc3BvbnNlID0+IHJlc3BvbnNlLmRhdGFbbm9kZV0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogQXBvbGxvRXJyb3IpID0+IHtcbiAgICAgICAgICAgIExvZ2dlci5Mb2dFcnJvcignW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Vycm9yU2VydmljZXMuYWRkRXJyb3IocGF5bG9hZCwgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRha2UoMSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGZldGNoUXVlcnlCdWlsZGVyPFQ+KHBheWxvYWQ6IEdyYXBoUGF5bG9hZCwgY29udGV4dDogc3RyaW5nKSB7XG4gICAgTG9nZ2VyLkxvZ0luZm8oJ1tHcmFwaFFMXSBbUHJlcGFyZV0gZmV0Y2hRdWVyeUJ1aWxkZXI6Jywge1xuICAgICAgcGF5bG9hZCxcbiAgICAgIGNvbnRleHQsXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuX2dldFdyYXBwZXIoeyBjb250ZXh0IH0pLnBpcGUoXG4gICAgICB0YXAoKCkgPT5cbiAgICAgICAgTG9nZ2VyLkxvZ0luZm8oJ1tHcmFwaFFMXSBbUXVlcnldIGZldGNoUXVlcnlCdWlsZGVyOicsIHtcbiAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHRoaXMuYXBvbGxvLnF1ZXJ5PHsgW2tleTogc3RyaW5nXTogVCB9Pih0aGlzLl9zZXR1cERhdGEocGF5bG9hZCwgY29udGV4dCkpLnBpcGUoXG4gICAgICAgICAgdGFwKGRhdGEgPT5cbiAgICAgICAgICAgIExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1Jlc3BvbnNlXSBmZXRjaFF1ZXJ5QnVpbGRlcjonLCB7XG4gICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICksXG4gICAgICAgICAgZmlsdGVyKHJlc3BvbnNlID0+ICEhcmVzcG9uc2UuZGF0YSksXG4gICAgICAgICAgbWFwKHJlc3BvbnNlID0+IHJlc3BvbnNlLmRhdGFbcGF5bG9hZC5uYW1lXSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbR3JhcGhRTF0gW0Vycm9yXSBmZXRjaFF1ZXJ5QnVpbGRlcjonLCB7XG4gICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Vycm9yU2VydmljZXMuYWRkRXJyb3IocGF5bG9hZCwgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRha2UoMSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGZldGNoUXVlcnk8VD4ocGF5bG9hZDogR3JhcGhRdWVyeVBheWxvYWQsIG5vZGU6IHN0cmluZywgY29udGV4dDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldFdyYXBwZXIoeyBjb250ZXh0IH0pLnBpcGUoXG4gICAgICB0YXAoKCkgPT5cbiAgICAgICAgTG9nZ2VyLkxvZ0luZm8oJ1tHcmFwaFFMXSBbUXVlcnldIGZldGNoUXVlcnk6Jywge1xuICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICB9KVxuICAgICAgKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICB0aGlzLmFwb2xsby5xdWVyeTxHcmFwaFJlcG9uc2VEYXRhPFQ+Pih0aGlzLl9zZXR1cERhdGEocGF5bG9hZCwgY29udGV4dCkpLnBpcGUoXG4gICAgICAgICAgdGFwKGRhdGEgPT5cbiAgICAgICAgICAgIExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1Jlc3BvbnNlXSBmZXRjaFF1ZXJ5OicsIHtcbiAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKSxcbiAgICAgICAgICBmaWx0ZXIocmVzcG9uc2UgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgICAgICBtYXAoZGF0YSA9PiBkYXRhLmRhdGFbbm9kZV0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogQXBvbGxvRXJyb3IpID0+IHtcbiAgICAgICAgICAgIExvZ2dlci5Mb2dFcnJvcignW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Vycm9yU2VydmljZXMuYWRkRXJyb3IocGF5bG9hZCwgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRha2UoMSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIG11dGF0ZTxUPihwYXlsb2FkOiBHcmFwaE11dGF0aW9uUGF5bG9hZCwgbXV0YXRpb25OYW1lOiBzdHJpbmcsIGNvbnRleHQ6IHN0cmluZywgY2xlYXJDYWNoZT86IHN0cmluZ1tdKSB7XG4gICAgTG9nZ2VyLkxvZ0luZm8oJ1tHcmFwaFFMXSAgW1ByZXBhcmVdIG11dGF0ZScsIHBheWxvYWQsIG11dGF0aW9uTmFtZSk7XG4gICAgcmV0dXJuIHRoaXMuYXBvbGxvLm11dGF0ZTxSZXBvbnNlTXV0YXRpb25EYXRhPFQ+Pih0aGlzLl9zZXR1cERhdGEocGF5bG9hZCwgY29udGV4dCkpLnBpcGUoXG4gICAgICB0YXAoZGF0YSA9PiBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtSZXBvbnNlXSBtdXRhdGUnLCBkYXRhKSksXG4gICAgICBmaWx0ZXIocmVzcG9uc2UgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgIHRhcCgoKSA9PiBjbGVhckNhY2hlPy5mb3JFYWNoKGNhY2hlS2V5ID0+IHRoaXMuY2xlYXJDYWNoZShjYWNoZUtleSkpKSxcbiAgICAgIG1hcChyZXNwb25zZSA9PiB7XG4gICAgICAgIHJldHVybiByZXNwb25zZSEuZGF0YSFbbXV0YXRpb25OYW1lXTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICBMb2dnZXIuTG9nRXJyb3IoJ1tHcmFwaFFMXSBbRXJyb3JdIGZldGNoUGFnZWRRdWVyeUxpc3Q6Jywge1xuICAgICAgICAgIHBheWxvYWQsXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fZXJyb3JTZXJ2aWNlcy5hZGRFcnJvcihwYXlsb2FkLCBlcnIpO1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnIpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyR3JhcGhFbmRwb2ludChncmFwaEVuZHBvaW50OiBHcmFwaEVuZHBvaW50LCBvcHRpb25zPzogR3JhcGhPcHRpb25zKSB7XG4gICAgY29uc3QgdXJsID1cbiAgICAgIG9wdGlvbnM/LnZpc2l0b3IgPT09IHRydWUgJiYgdGhpcy5fZ3JhcGhDb25maWc/LnZpc2l0b3IgPyB0aGlzLl9ncmFwaENvbmZpZz8udmlzaXRvciA6IHRoaXMuX2dyYXBoQ29uZmlnPy51cmw7XG5cbiAgICBsZXQgdXJpID0gaXNVUkwoZ3JhcGhFbmRwb2ludC5lbmRwb2ludCkgPyBncmFwaEVuZHBvaW50LmVuZHBvaW50IDogdXJsICsgZ3JhcGhFbmRwb2ludC5lbmRwb2ludDtcblxuICAgIGNvbnN0IG5ld0h0dHBMaW5rID0gdGhpcy5odHRwTGluay5jcmVhdGUoe1xuICAgICAgaGVhZGVyczogZ3JhcGhFbmRwb2ludC5oZWFkZXJzLFxuICAgICAgdXJpOiB1cmksXG4gICAgfSk7XG5cbiAgICB0aGlzLmFwb2xsby5jbGllbnQuc2V0TGluayhcbiAgICAgIHRoaXMuYXBvbGxvLmNsaWVudC5saW5rLmNvbmNhdChcbiAgICAgICAgQXBvbGxvTGluay5zcGxpdChvcGVyYXRpb24gPT4gb3BlcmF0aW9uLmdldENvbnRleHQoKVsnY2xpZW50TmFtZSddID09PSBncmFwaEVuZHBvaW50LmNsaWVudE5hbWUsIG5ld0h0dHBMaW5rKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIF9zZXR1cERhdGE8VD4ocGF5bG9hZDogVCwgY29udGV4dDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHsgLi4ucGF5bG9hZCwgLi4ueyBjb250ZXh0OiB7IGNsaWVudE5hbWU6IGNvbnRleHQgfSB9IH07XG4gIH1cblxuICBwcml2YXRlIF9nZXRXcmFwcGVyKGRhdGE/OiBXcmFwcGVyRGF0YSkge1xuICAgIHJldHVybiB0aGlzLmlzUmVhZHkkO1xuICB9XG59XG4iXX0=