import { Inject, Injectable, Optional, inject } from '@angular/core';
import { ApolloClient, ApolloLink, InMemoryCache } from '@apollo/client/core';
import { BehaviorSubject, catchError, filter, map, switchMap, take, tap, throwError } from 'rxjs';
import { APPLICATION_CONFIG, isURL } from '@ta/utils';
import { CamServerErrorService } from '../error.service';
import { Logger } from '../logger';
import { GRAPHQL_SERVER_CONFIG } from './public-api';
import * as i0 from "@angular/core";
import * as i1 from "apollo-angular/http";
import * as i2 from "apollo-angular";
export class CamGraphService {
    constructor(_graphConfig, httpLink, apollo) {
        this._graphConfig = _graphConfig;
        this.httpLink = httpLink;
        this.apollo = apollo;
        this.contactsLoaded$ = new BehaviorSubject(false);
        this.isReady$ = new BehaviorSubject(true);
        this._errorServices = inject(CamServerErrorService);
        this._applicationConfig = inject(APPLICATION_CONFIG);
        this._defaultEndpoint = new ApolloLink((operation, forward) => {
            return forward(operation);
        });
        this._cache = new InMemoryCache();
        //  (<any>window).apolloCache = this._cache;
        this.apollo.client = new ApolloClient({
            cache: this._cache,
            link: this._defaultEndpoint,
        });
    }
    clearCache(key) {
        this._cache.evict({
            fieldName: key,
        });
    }
    fetchQueryList(payload, node, context) {
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchQueryList:', {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchQueryList:', {
            data,
            node,
            context,
        })), filter(response => !!response.data), map(response => response.data[node]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            //this._errorServices.addError(err);
            return throwError(() => err);
        }), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchPagedQueryList(payload, node, context) {
        Logger.LogInfo('[GraphQL] [Prepare] fetchPagedQueryList:', {
            payload,
            node,
            context,
        });
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchPagedQueryList:', {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchPagedQueryList:', {
            data,
            node,
            context,
        })), filter(response => !!response.data), map(response => response.data[node]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    fetchQuery(payload, node, context) {
        return this._getWrapper({ context }).pipe(tap(() => Logger.LogInfo('[GraphQL] [Query] fetchQuery:', {
            payload,
            node,
            context,
        })), switchMap(() => this.apollo.query(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Response] fetchQuery:', {
            data,
            node,
            context,
        })), filter(response => !!response.data), map(data => data.data[node]), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                node,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }))), take(1));
    }
    mutate(payload, mutationName, context, clearCache) {
        Logger.LogInfo('[GraphQL]  [Prepare] mutate', payload, mutationName);
        return this.apollo.mutate(this._setupData(payload, context)).pipe(tap(data => Logger.LogInfo('[GraphQL] [Reponse] mutate', data)), filter(response => !!response.data), tap(() => clearCache?.forEach(cacheKey => this.clearCache(cacheKey))), map(response => {
            return response.data[mutationName];
        }), catchError((err) => {
            Logger.LogError('[GraphQL] [Error] fetchPagedQueryList:', {
                payload,
                context,
                message: err.message,
            });
            this._errorServices.addError(payload, err);
            return throwError(() => err);
        }));
    }
    registerGraphEndpoint(graphEndpoint, options) {
        const url = options?.visitor === true && this._graphConfig?.visitor ? this._graphConfig?.visitor : this._graphConfig?.url;
        let uri = isURL(graphEndpoint.endpoint) ? graphEndpoint.endpoint : url + graphEndpoint.endpoint;
        const newHttpLink = this.httpLink.create({
            headers: graphEndpoint.headers,
            uri: uri,
        });
        this.apollo.client.setLink(this.apollo.client.link.concat(ApolloLink.split(operation => operation.getContext()['clientName'] === graphEndpoint.clientName, newHttpLink)));
    }
    _setupData(payload, context) {
        return { ...payload, ...{ context: { clientName: context } } };
    }
    _getWrapper(data) {
        if (!this._applicationConfig.isCustomerApplication) {
            return this.isReady$;
        }
        if (data?.context === 'userService') {
            return this.isReady$;
        }
        if (data?.context?.includes('Visitor')) {
            return this.isReady$;
        }
        return this.contactsLoaded$.pipe(filter(loaded => loaded));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamGraphService, deps: [{ token: GRAPHQL_SERVER_CONFIG, optional: true }, { token: i1.HttpLink }, { token: i2.Apollo }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamGraphService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamGraphService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [GRAPHQL_SERVER_CONFIG]
                }] }, { type: i1.HttpLink }, { type: i2.Apollo }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvc2VydmljZXMvZ3JhcGhxbC9ncmFwaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckUsT0FBTyxFQUFFLFlBQVksRUFBZSxVQUFVLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHM0YsT0FBTyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEcsT0FBTyxFQUFFLGtCQUFrQixFQUFzQixLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFMUUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUtuQyxPQUFPLEVBQUUscUJBQXFCLEVBQStCLE1BQU0sY0FBYyxDQUFDOzs7O0FBV2xGLE1BQU0sT0FBTyxlQUFlO0lBUzFCLFlBR1UsWUFBMEIsRUFDMUIsUUFBa0IsRUFDbEIsTUFBYztRQUZkLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQWJqQixvQkFBZSxHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQ3RELGFBQVEsR0FBRyxJQUFJLGVBQWUsQ0FBVSxJQUFJLENBQUMsQ0FBQztRQUU3QyxtQkFBYyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQy9DLHVCQUFrQixHQUF1QixNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FB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QyxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUN2QixDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQzdELENBQUM7K0dBM05VLGVBQWUsa0JBV2hCLHFCQUFxQjttSEFYcEIsZUFBZSxjQUZkLE1BQU07OzRGQUVQLGVBQWU7a0JBSDNCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFXSSxRQUFROzswQkFDUixNQUFNOzJCQUFDLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwsIGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBBcG9sbG9DbGllbnQsIEFwb2xsb0Vycm9yLCBBcG9sbG9MaW5rLCBJbk1lbW9yeUNhY2hlIH0gZnJvbSAnQGFwb2xsby9jbGllbnQvY29yZSc7XG5pbXBvcnQgeyBBcG9sbG8gfSBmcm9tICdhcG9sbG8tYW5ndWxhcic7XG5pbXBvcnQgeyBIdHRwTGluayB9IGZyb20gJ2Fwb2xsby1hbmd1bGFyL2h0dHAnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjYXRjaEVycm9yLCBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwLCB0YWtlLCB0YXAsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgQVBQTElDQVRJT05fQ09ORklHLCBJQXBwbGljYXRpb25Db25maWcsIGlzVVJMIH0gZnJvbSAnQHRhL3V0aWxzJztcblxuaW1wb3J0IHsgQ2FtU2VydmVyRXJyb3JTZXJ2aWNlIH0gZnJvbSAnLi4vZXJyb3Iuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgR3JhcGhNdXRhdGlvblBheWxvYWQsIEdyYXBoUXVlcnlQYXlsb2FkIH0gZnJvbSAnLi9tb2RlbHMvZ3JhcGhQYXlsb2FkJztcbmltcG9ydCB7IEdyYXBoUmVwb25zZURhdGEgfSBmcm9tICcuL21vZGVscy9ncmFwaFJlc3BvbnNlRGF0YSc7XG5pbXBvcnQgeyBHcmFwaFJlcG9uc2VQYWdlZERhdGEgfSBmcm9tICcuL21vZGVscy9ncmFwaFJlc3BvbnNlUGFnZWREYXRhJztcbmltcG9ydCB7IFJlcG9uc2VNdXRhdGlvbkRhdGEgfSBmcm9tICcuL21vZGVscy9yZXNwb25zZURhdGEnO1xuaW1wb3J0IHsgR1JBUEhRTF9TRVJWRVJfQ09ORklHLCBHcmFwaEVuZHBvaW50LCBJR3JhcGhDb25maWcgfSBmcm9tICcuL3B1YmxpYy1hcGknO1xuXG5leHBvcnQgdHlwZSBHcmFwaE9wdGlvbnMgPSB7XG4gIHZpc2l0b3I6IGJvb2xlYW47XG59O1xudHlwZSBXcmFwcGVyRGF0YSA9IHtcbiAgY29udGV4dD86IHN0cmluZztcbn07XG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgQ2FtR3JhcGhTZXJ2aWNlIHtcbiAgcHVibGljIGNvbnRhY3RzTG9hZGVkJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xuICBwdWJsaWMgaXNSZWFkeSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRydWUpO1xuXG4gIHByaXZhdGUgX2Vycm9yU2VydmljZXMgPSBpbmplY3QoQ2FtU2VydmVyRXJyb3JTZXJ2aWNlKTtcbiAgcHJpdmF0ZSBfYXBwbGljYXRpb25Db25maWc6IElBcHBsaWNhdGlvbkNvbmZpZyA9IGluamVjdChBUFBMSUNBVElPTl9DT05GSUcpO1xuXG4gIHByaXZhdGUgX2RlZmF1bHRFbmRwb2ludDtcbiAgcHJpdmF0ZSBfY2FjaGU7XG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChHUkFQSFFMX1NFUlZFUl9DT05GSUcpXG4gICAgcHJpdmF0ZSBfZ3JhcGhDb25maWc6IElHcmFwaENvbmZpZyxcbiAgICBwcml2YXRlIGh0dHBMaW5rOiBIdHRwTGluayxcbiAgICBwcml2YXRlIGFwb2xsbzogQXBvbGxvXG4gICkge1xuICAgIHRoaXMuX2RlZmF1bHRFbmRwb2ludCA9IG5ldyBBcG9sbG9MaW5rKChvcGVyYXRpb24sIGZvcndhcmQpID0+IHtcbiAgICAgIHJldHVybiBmb3J3YXJkKG9wZXJhdGlvbik7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9jYWNoZSA9IG5ldyBJbk1lbW9yeUNhY2hlKCk7XG5cbiAgICAvLyAgKDxhbnk+d2luZG93KS5hcG9sbG9DYWNoZSA9IHRoaXMuX2NhY2hlO1xuXG4gICAgdGhpcy5hcG9sbG8uY2xpZW50ID0gbmV3IEFwb2xsb0NsaWVudCh7XG4gICAgICBjYWNoZTogdGhpcy5fY2FjaGUsXG4gICAgICBsaW5rOiB0aGlzLl9kZWZhdWx0RW5kcG9pbnQsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgY2xlYXJDYWNoZShrZXk6IHN0cmluZykge1xuICAgIHRoaXMuX2NhY2hlLmV2aWN0KHtcbiAgICAgIGZpZWxkTmFtZToga2V5LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGZldGNoUXVlcnlMaXN0PFQ+KHBheWxvYWQ6IEdyYXBoUXVlcnlQYXlsb2FkLCBub2RlOiBzdHJpbmcsIGNvbnRleHQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9nZXRXcmFwcGVyKHsgY29udGV4dCB9KS5waXBlKFxuICAgICAgdGFwKCgpID0+XG4gICAgICAgIExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1F1ZXJ5XSBmZXRjaFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHRoaXMuYXBvbGxvLnF1ZXJ5PEdyYXBoUmVwb25zZURhdGE8VFtdPj4odGhpcy5fc2V0dXBEYXRhKHBheWxvYWQsIGNvbnRleHQpKS5waXBlKFxuICAgICAgICAgIHRhcChkYXRhID0+XG4gICAgICAgICAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtSZXNwb25zZV0gZmV0Y2hRdWVyeUxpc3Q6Jywge1xuICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApLFxuICAgICAgICAgIGZpbHRlcihyZXNwb25zZSA9PiAhIXJlc3BvbnNlLmRhdGEpLFxuICAgICAgICAgIG1hcChyZXNwb25zZSA9PiByZXNwb25zZS5kYXRhW25vZGVdKSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IEFwb2xsb0Vycm9yKSA9PiB7XG4gICAgICAgICAgICBMb2dnZXIuTG9nRXJyb3IoJ1tHcmFwaFFMXSBbRXJyb3JdIGZldGNoUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vdGhpcy5fZXJyb3JTZXJ2aWNlcy5hZGRFcnJvcihlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyKTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IEFwb2xsb0Vycm9yKSA9PiB7XG4gICAgICAgICAgICBMb2dnZXIuTG9nRXJyb3IoJ1tHcmFwaFFMXSBbRXJyb3JdIGZldGNoUGFnZWRRdWVyeUxpc3Q6Jywge1xuICAgICAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLl9lcnJvclNlcnZpY2VzLmFkZEVycm9yKHBheWxvYWQsIGVycik7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBlcnIpO1xuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICB0YWtlKDEpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBmZXRjaFBhZ2VkUXVlcnlMaXN0PFQ+KHBheWxvYWQ6IEdyYXBoUXVlcnlQYXlsb2FkLCBub2RlOiBzdHJpbmcsIGNvbnRleHQ6IHN0cmluZykge1xuICAgIExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1ByZXBhcmVdIGZldGNoUGFnZWRRdWVyeUxpc3Q6Jywge1xuICAgICAgcGF5bG9hZCxcbiAgICAgIG5vZGUsXG4gICAgICBjb250ZXh0LFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLl9nZXRXcmFwcGVyKHsgY29udGV4dCB9KS5waXBlKFxuICAgICAgdGFwKCgpID0+XG4gICAgICAgIExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1F1ZXJ5XSBmZXRjaFBhZ2VkUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgdGhpcy5hcG9sbG8ucXVlcnk8R3JhcGhSZXBvbnNlUGFnZWREYXRhPFQ+Pih0aGlzLl9zZXR1cERhdGEocGF5bG9hZCwgY29udGV4dCkpLnBpcGUoXG4gICAgICAgICAgdGFwKGRhdGEgPT5cbiAgICAgICAgICAgIExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1Jlc3BvbnNlXSBmZXRjaFBhZ2VkUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKSxcbiAgICAgICAgICBmaWx0ZXIocmVzcG9uc2UgPT4gISFyZXNwb25zZS5kYXRhKSxcbiAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gcmVzcG9uc2UuZGF0YVtub2RlXSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbR3JhcGhRTF0gW0Vycm9yXSBmZXRjaFBhZ2VkUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fZXJyb3JTZXJ2aWNlcy5hZGRFcnJvcihwYXlsb2FkLCBlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyKTtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApLFxuICAgICAgdGFrZSgxKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hRdWVyeTxUPihwYXlsb2FkOiBHcmFwaFF1ZXJ5UGF5bG9hZCwgbm9kZTogc3RyaW5nLCBjb250ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0V3JhcHBlcih7IGNvbnRleHQgfSkucGlwZShcbiAgICAgIHRhcCgoKSA9PlxuICAgICAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdIFtRdWVyeV0gZmV0Y2hRdWVyeTonLCB7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHRoaXMuYXBvbGxvLnF1ZXJ5PEdyYXBoUmVwb25zZURhdGE8VD4+KHRoaXMuX3NldHVwRGF0YShwYXlsb2FkLCBjb250ZXh0KSkucGlwZShcbiAgICAgICAgICB0YXAoZGF0YSA9PlxuICAgICAgICAgICAgTG9nZ2VyLkxvZ0luZm8oJ1tHcmFwaFFMXSBbUmVzcG9uc2VdIGZldGNoUXVlcnk6Jywge1xuICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApLFxuICAgICAgICAgIGZpbHRlcihyZXNwb25zZSA9PiAhIXJlc3BvbnNlLmRhdGEpLFxuICAgICAgICAgIG1hcChkYXRhID0+IGRhdGEuZGF0YVtub2RlXSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBBcG9sbG9FcnJvcikgPT4ge1xuICAgICAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbR3JhcGhRTF0gW0Vycm9yXSBmZXRjaFBhZ2VkUXVlcnlMaXN0OicsIHtcbiAgICAgICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICAgICAgbm9kZSxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fZXJyb3JTZXJ2aWNlcy5hZGRFcnJvcihwYXlsb2FkLCBlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyKTtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApLFxuICAgICAgdGFrZSgxKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgbXV0YXRlPFQ+KHBheWxvYWQ6IEdyYXBoTXV0YXRpb25QYXlsb2FkLCBtdXRhdGlvbk5hbWU6IHN0cmluZywgY29udGV4dDogc3RyaW5nLCBjbGVhckNhY2hlPzogc3RyaW5nW10pIHtcbiAgICBMb2dnZXIuTG9nSW5mbygnW0dyYXBoUUxdICBbUHJlcGFyZV0gbXV0YXRlJywgcGF5bG9hZCwgbXV0YXRpb25OYW1lKTtcbiAgICByZXR1cm4gdGhpcy5hcG9sbG8ubXV0YXRlPFJlcG9uc2VNdXRhdGlvbkRhdGE8VD4+KHRoaXMuX3NldHVwRGF0YShwYXlsb2FkLCBjb250ZXh0KSkucGlwZShcbiAgICAgIHRhcChkYXRhID0+IExvZ2dlci5Mb2dJbmZvKCdbR3JhcGhRTF0gW1JlcG9uc2VdIG11dGF0ZScsIGRhdGEpKSxcbiAgICAgIGZpbHRlcihyZXNwb25zZSA9PiAhIXJlc3BvbnNlLmRhdGEpLFxuICAgICAgdGFwKCgpID0+IGNsZWFyQ2FjaGU/LmZvckVhY2goY2FjaGVLZXkgPT4gdGhpcy5jbGVhckNhY2hlKGNhY2hlS2V5KSkpLFxuICAgICAgbWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlIS5kYXRhIVttdXRhdGlvbk5hbWVdO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKChlcnI6IEFwb2xsb0Vycm9yKSA9PiB7XG4gICAgICAgIExvZ2dlci5Mb2dFcnJvcignW0dyYXBoUUxdIFtFcnJvcl0gZmV0Y2hQYWdlZFF1ZXJ5TGlzdDonLCB7XG4gICAgICAgICAgcGF5bG9hZCxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9lcnJvclNlcnZpY2VzLmFkZEVycm9yKHBheWxvYWQsIGVycik7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJHcmFwaEVuZHBvaW50KGdyYXBoRW5kcG9pbnQ6IEdyYXBoRW5kcG9pbnQsIG9wdGlvbnM/OiBHcmFwaE9wdGlvbnMpIHtcbiAgICBjb25zdCB1cmwgPVxuICAgICAgb3B0aW9ucz8udmlzaXRvciA9PT0gdHJ1ZSAmJiB0aGlzLl9ncmFwaENvbmZpZz8udmlzaXRvciA/IHRoaXMuX2dyYXBoQ29uZmlnPy52aXNpdG9yIDogdGhpcy5fZ3JhcGhDb25maWc/LnVybDtcblxuICAgIGxldCB1cmkgPSBpc1VSTChncmFwaEVuZHBvaW50LmVuZHBvaW50KSA/IGdyYXBoRW5kcG9pbnQuZW5kcG9pbnQgOiB1cmwgKyBncmFwaEVuZHBvaW50LmVuZHBvaW50O1xuXG4gICAgY29uc3QgbmV3SHR0cExpbmsgPSB0aGlzLmh0dHBMaW5rLmNyZWF0ZSh7XG4gICAgICBoZWFkZXJzOiBncmFwaEVuZHBvaW50LmhlYWRlcnMsXG4gICAgICB1cmk6IHVyaSxcbiAgICB9KTtcblxuICAgIHRoaXMuYXBvbGxvLmNsaWVudC5zZXRMaW5rKFxuICAgICAgdGhpcy5hcG9sbG8uY2xpZW50LmxpbmsuY29uY2F0KFxuICAgICAgICBBcG9sbG9MaW5rLnNwbGl0KG9wZXJhdGlvbiA9PiBvcGVyYXRpb24uZ2V0Q29udGV4dCgpWydjbGllbnROYW1lJ10gPT09IGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZSwgbmV3SHR0cExpbmspXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldHVwRGF0YTxUPihwYXlsb2FkOiBULCBjb250ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4geyAuLi5wYXlsb2FkLCAuLi57IGNvbnRleHQ6IHsgY2xpZW50TmFtZTogY29udGV4dCB9IH0gfTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFdyYXBwZXIoZGF0YT86IFdyYXBwZXJEYXRhKSB7XG4gICAgaWYgKCF0aGlzLl9hcHBsaWNhdGlvbkNvbmZpZy5pc0N1c3RvbWVyQXBwbGljYXRpb24pIHtcbiAgICAgIHJldHVybiB0aGlzLmlzUmVhZHkkO1xuICAgIH1cblxuICAgIGlmIChkYXRhPy5jb250ZXh0ID09PSAndXNlclNlcnZpY2UnKSB7XG4gICAgICByZXR1cm4gdGhpcy5pc1JlYWR5JDtcbiAgICB9XG4gICAgaWYgKGRhdGE/LmNvbnRleHQ/LmluY2x1ZGVzKCdWaXNpdG9yJykpIHtcbiAgICAgIHJldHVybiB0aGlzLmlzUmVhZHkkO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmNvbnRhY3RzTG9hZGVkJC5waXBlKGZpbHRlcihsb2FkZWQgPT4gbG9hZGVkKSk7XG4gIH1cbn1cbiJdfQ==