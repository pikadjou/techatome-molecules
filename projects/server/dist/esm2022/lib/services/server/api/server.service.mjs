import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { Subject } from 'rxjs';
import { Logger } from '../../logger';
import { StatusReponse } from '../response';
import { RequestMap } from './requestMap';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export const SERVER_CONFIG_KEY = new InjectionToken('config_server');
export class TaServerSevice {
    get requestInProgressNumber() {
        return this._correlations.length;
    }
    get isAuthenticated() {
        return this._isAuthenticated;
    }
    set isAuthenticated(value) {
        this._isAuthenticated = value;
        if (this._isAuthenticated) {
            this._retryLoginRequired();
        }
    }
    constructor($http, _config) {
        this.$http = $http;
        this._config = _config;
        this._tempLoginRequiredRequest = [];
        this._tempPendingRequest = [];
        this._correlations = [];
        this._isAuthenticated = false;
        this._onPacketReceived = (id, response) => {
            Logger.LogInfo('[SERVER] Api Reponse:', response);
            this._resolveCorrelation(id, response.body);
        };
        this._resolveCorrelation = (corrId, body) => {
            const correlation = this._correlations.find(item => item.id === corrId);
            if (!correlation) {
                return;
            }
            let content;
            if (typeof body === 'string') {
                try {
                    content = JSON.parse(body);
                }
                catch (error) {
                    content = body;
                }
            }
            else {
                content = body;
            }
            this._resolveResponseStatus(correlation, content);
            this._correlations = this._correlations.filter(item => item !== correlation);
            if (this.requestInProgressNumber === 0) {
                this._retryPending();
            }
        };
    }
    registerRoutes(routes) {
        RequestMap.register(routes);
    }
    request(request) {
        const subject = new Subject();
        this._send(subject, request);
        return subject;
    }
    retryRequest(list = []) {
        for (const request of list) {
            this._send(request.subject, request.request);
        }
    }
    _send(subject, request) {
        if (!this._config) {
            return;
        }
        // le user doit etre connecté
        if (request.loginRequired === true && this.isAuthenticated === false) {
            this._tempLoginRequiredRequest.push({
                request: request,
                subject: subject,
            });
            return;
        }
        if (this.requestInProgressNumber >= this._config.pendindRequestId) {
            this._tempPendingRequest.push({ request: request, subject: subject });
            return;
        }
        this._addCorrelation(request.id, request, subject);
        this._sendRequest(request);
    }
    _sendRequest(request) {
        if (!this._config) {
            return;
        }
        const requestConfig = RequestMap.getConfigById(request.type);
        if (!requestConfig) {
            return;
        }
        const url = RequestMap.parseUrl({
            serverUrl: this._config.serverUrl,
            url: requestConfig.url,
            request,
            apiExt: this._config.apiExt,
        });
        Logger.LogInfo('[SERVER] Api Request:', url, request);
        switch (requestConfig.type) {
            case 'GET':
                this._get(url, request);
                break;
            case 'POST':
                this._post(url, request);
                break;
            case 'PUT':
                this._put(url, request);
                break;
            case 'PATCH':
                this._patch(url, request);
                break;
            case 'DELETE':
                this._delete(url, request);
                break;
            case 'FILES':
                this._files(url, request);
                break;
            case 'UPDATEFILES':
                this._updateFiles(url, request);
                break;
            default:
                Logger.LogError('[ERROR] Request not send');
        }
    }
    _addCorrelation(corrId, request, sub) {
        this._correlations.push({ id: corrId, request: request, subject: sub });
    }
    _resolveResponseStatus(correlation, content) {
        Logger.LogInfo('[SERVER] Api Reponse content:', content.Status, content.Content);
        switch (content.Status) {
            case StatusReponse.Successful:
            case StatusReponse.NoContent:
                correlation.subject.next(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
                break;
            default:
                correlation.subject.error(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
        }
    }
    _retryPending() {
        const list = [...this._tempPendingRequest];
        this._tempPendingRequest = [];
        this.retryRequest(list);
    }
    _retryLoginRequired() {
        const list = [...this._tempLoginRequiredRequest];
        this._tempLoginRequiredRequest = [];
        this.retryRequest(list);
    }
    _get(url, request) {
        this.$http
            .get(url, {
            headers: this._headers(),
            params: { cacheTime: request.cacheTime },
        })
            .subscribe({
            next: response => {
                this._onPacketReceived(request.id, this._formatReponse(response, 200));
            },
            error: message => {
                this._onPacketReceived(request.id, this._formatReponse(message, message.status));
            },
            complete: () => Logger.LogDebug('API GET CLOSE'),
        });
    }
    _post(url, request) {
        this.$http
            .post(url, request.BrutContent, {
            headers: this._headers(),
        })
            .subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API POST CLOSE'),
        });
    }
    _patch(url, request) {
        this.$http.patch(url, request.Content, { headers: this._headers() }).subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API PATCH CLOSE'),
        });
    }
    _put(url, request) {
        this.$http.put(url, request.Content, { headers: this._headers() }).subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API PUT CLOSE'),
        });
    }
    _delete(url, request) {
        this.$http.delete(url, { headers: this._headers() }).subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _files(url, request) {
        this.$http
            .post(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: '',
            }),
        })
            .subscribe({
            next: response => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _updateFiles(url, request) {
        this.$http
            .put(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: '',
            }),
        })
            .subscribe({
            next: response => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _formatReponse(response, status = 200) {
        return { body: { Status: status, Content: response } };
    }
    _headers(option) {
        let headers = new HttpHeaders();
        if (option?.contentType !== '') {
            headers = headers.set('Content-Type', option?.contentType ? option?.contentType : 'application/json');
        }
        headers = headers.set('Access-Control-Allow-Origin', this._config?.serverUrl ?? '');
        Logger.LogInfo('[SERVER] Api Request Header:', headers);
        return headers;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaServerSevice, deps: [{ token: HttpClient }, { token: SERVER_CONFIG_KEY, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaServerSevice, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaServerSevice, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient, decorators: [{
                    type: Inject,
                    args: [HttpClient]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [SERVER_CONFIG_KEY]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL3NlcnZlci9hcGkvc2VydmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUd0QyxPQUFPLEVBQTJDLGFBQWEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyRixPQUFPLEVBQWtCLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQzs7O0FBRTFELE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLElBQUksY0FBYyxDQUFjLGVBQWUsQ0FBQyxDQUFDO0FBU2xGLE1BQU0sT0FBTyxjQUFjO0lBQ3pCLElBQUksdUJBQXVCO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7SUFDbkMsQ0FBQztJQVFELElBQUksZUFBZTtRQUNqQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBQ0QsSUFBSSxlQUFlLENBQUMsS0FBYztRQUNoQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDN0IsQ0FBQztJQUNILENBQUM7SUFFRCxZQUM2QixLQUFpQixFQUNHLE9BQXFCO1FBRHpDLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDRyxZQUFPLEdBQVAsT0FBTyxDQUFjO1FBbEI5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Q0FBQyxDQUFDO1FBQ3hHLENBQUM7UUFFRCxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUVwRixNQUFNLENBQUMsT0FBTyxDQUFDLDhCQUE4QixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXhELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7K0dBbFFVLGNBQWMsa0JBc0JmLFVBQVUsYUFDRSxpQkFBaUI7bUhBdkI1QixjQUFjLGNBRmIsTUFBTTs7NEZBRVAsY0FBYztrQkFIMUIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQXVCSSxNQUFNOzJCQUFDLFVBQVU7OzBCQUNqQixRQUFROzswQkFBSSxNQUFNOzJCQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi8uLi9sb2dnZXInO1xuaW1wb3J0IHsgQ29ycmVsYXRpb24sIFRlbXBSZXF1ZXN0IH0gZnJvbSAnLi4vaW50ZXJmYWNlJztcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tICcuLi9yZXF1ZXN0JztcbmltcG9ydCB7IElCYWNrUmVzcG9uc2UsIElCYXNlUmVzcG9uc2UsIElSZXNwb25zZSwgU3RhdHVzUmVwb25zZSB9IGZyb20gJy4uL3Jlc3BvbnNlJztcbmltcG9ydCB7IE1hcHBpbmdBcGlUeXBlLCBSZXF1ZXN0TWFwIH0gZnJvbSAnLi9yZXF1ZXN0TWFwJztcblxuZXhwb3J0IGNvbnN0IFNFUlZFUl9DT05GSUdfS0VZID0gbmV3IEluamVjdGlvblRva2VuPElSZXN0Q29uZmlnPignY29uZmlnX3NlcnZlcicpO1xuZXhwb3J0IGludGVyZmFjZSBJUmVzdENvbmZpZyB7XG4gIHBlbmRpbmRSZXF1ZXN0SWQ6IG51bWJlcjtcbiAgc2VydmVyVXJsOiBzdHJpbmc7XG4gIGFwaUV4dD86IHN0cmluZztcbn1cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBUYVNlcnZlclNldmljZSB7XG4gIGdldCByZXF1ZXN0SW5Qcm9ncmVzc051bWJlcigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9jb3JyZWxhdGlvbnMubGVuZ3RoO1xuICB9XG5cbiAgcHJpdmF0ZSBfdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0OiBUZW1wUmVxdWVzdFtdID0gW107XG4gIHByaXZhdGUgX3RlbXBQZW5kaW5nUmVxdWVzdDogVGVtcFJlcXVlc3RbXSA9IFtdO1xuXG4gIHByaXZhdGUgX2NvcnJlbGF0aW9uczogQ29ycmVsYXRpb25bXSA9IFtdO1xuXG4gIHByaXZhdGUgX2lzQXV0aGVudGljYXRlZCA9IGZhbHNlO1xuICBnZXQgaXNBdXRoZW50aWNhdGVkKCkge1xuICAgIHJldHVybiB0aGlzLl9pc0F1dGhlbnRpY2F0ZWQ7XG4gIH1cbiAgc2V0IGlzQXV0aGVudGljYXRlZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2lzQXV0aGVudGljYXRlZCA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl9pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgIHRoaXMuX3JldHJ5TG9naW5SZXF1aXJlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoSHR0cENsaWVudCkgcHVibGljICRodHRwOiBIdHRwQ2xpZW50LFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoU0VSVkVSX0NPTkZJR19LRVkpIHByaXZhdGUgX2NvbmZpZz86IElSZXN0Q29uZmlnXG4gICkge31cblxuICBwdWJsaWMgcmVnaXN0ZXJSb3V0ZXMocm91dGVzOiBNYXBwaW5nQXBpVHlwZSkge1xuICAgIFJlcXVlc3RNYXAucmVnaXN0ZXIocm91dGVzKTtcbiAgfVxuXG4gIHB1YmxpYyByZXF1ZXN0PFQ+KHJlcXVlc3Q6IFJlcXVlc3QpOiBTdWJqZWN0PFQ+IHtcbiAgICBjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3Q8T2JqZWN0PigpO1xuICAgIHRoaXMuX3NlbmQoc3ViamVjdCwgcmVxdWVzdCk7XG4gICAgcmV0dXJuIHN1YmplY3QgYXMgdW5rbm93biBhcyBTdWJqZWN0PFQ+O1xuICB9XG4gIHB1YmxpYyByZXRyeVJlcXVlc3QobGlzdDogVGVtcFJlcXVlc3RbXSA9IFtdKSB7XG4gICAgZm9yIChjb25zdCByZXF1ZXN0IG9mIGxpc3QpIHtcbiAgICAgIHRoaXMuX3NlbmQocmVxdWVzdC5zdWJqZWN0LCByZXF1ZXN0LnJlcXVlc3QpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIF9zZW5kKHN1YmplY3Q6IFN1YmplY3Q8T2JqZWN0PiwgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIGlmICghdGhpcy5fY29uZmlnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGxlIHVzZXIgZG9pdCBldHJlIGNvbm5lY3TDqVxuICAgIGlmIChyZXF1ZXN0LmxvZ2luUmVxdWlyZWQgPT09IHRydWUgJiYgdGhpcy5pc0F1dGhlbnRpY2F0ZWQgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLl90ZW1wTG9naW5SZXF1aXJlZFJlcXVlc3QucHVzaCh7XG4gICAgICAgIHJlcXVlc3Q6IHJlcXVlc3QsXG4gICAgICAgIHN1YmplY3Q6IHN1YmplY3QsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZXF1ZXN0SW5Qcm9ncmVzc051bWJlciA+PSB0aGlzLl9jb25maWcucGVuZGluZFJlcXVlc3RJZCkge1xuICAgICAgdGhpcy5fdGVtcFBlbmRpbmdSZXF1ZXN0LnB1c2goeyByZXF1ZXN0OiByZXF1ZXN0LCBzdWJqZWN0OiBzdWJqZWN0IH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuX2FkZENvcnJlbGF0aW9uKHJlcXVlc3QuaWQsIHJlcXVlc3QsIHN1YmplY3QpO1xuXG4gICAgdGhpcy5fc2VuZFJlcXVlc3QocmVxdWVzdCk7XG4gIH1cbiAgcHJpdmF0ZSBfc2VuZFJlcXVlc3QocmVxdWVzdDogUmVxdWVzdCkge1xuICAgIGlmICghdGhpcy5fY29uZmlnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHJlcXVlc3RDb25maWcgPSBSZXF1ZXN0TWFwLmdldENvbmZpZ0J5SWQocmVxdWVzdC50eXBlKTtcbiAgICBpZiAoIXJlcXVlc3RDb25maWcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdXJsID0gUmVxdWVzdE1hcC5wYXJzZVVybCh7XG4gICAgICBzZXJ2ZXJVcmw6IHRoaXMuX2NvbmZpZy5zZXJ2ZXJVcmwsXG4gICAgICB1cmw6IHJlcXVlc3RDb25maWcudXJsLFxuICAgICAgcmVxdWVzdCxcbiAgICAgIGFwaUV4dDogdGhpcy5fY29uZmlnLmFwaUV4dCxcbiAgICB9KTtcbiAgICBMb2dnZXIuTG9nSW5mbygnW1NFUlZFUl0gQXBpIFJlcXVlc3Q6JywgdXJsLCByZXF1ZXN0KTtcblxuICAgIHN3aXRjaCAocmVxdWVzdENvbmZpZy50eXBlKSB7XG4gICAgICBjYXNlICdHRVQnOlxuICAgICAgICB0aGlzLl9nZXQodXJsLCByZXF1ZXN0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdQT1NUJzpcbiAgICAgICAgdGhpcy5fcG9zdCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BVVCc6XG4gICAgICAgIHRoaXMuX3B1dCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BBVENIJzpcbiAgICAgICAgdGhpcy5fcGF0Y2godXJsLCByZXF1ZXN0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdERUxFVEUnOlxuICAgICAgICB0aGlzLl9kZWxldGUodXJsLCByZXF1ZXN0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdGSUxFUyc6XG4gICAgICAgIHRoaXMuX2ZpbGVzKHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnVVBEQVRFRklMRVMnOlxuICAgICAgICB0aGlzLl91cGRhdGVGaWxlcyh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIExvZ2dlci5Mb2dFcnJvcignW0VSUk9SXSBSZXF1ZXN0IG5vdCBzZW5kJyk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgX29uUGFja2V0UmVjZWl2ZWQgPSAoaWQ6IG51bWJlciwgcmVzcG9uc2U6IElSZXNwb25zZSk6IHZvaWQgPT4ge1xuICAgIExvZ2dlci5Mb2dJbmZvKCdbU0VSVkVSXSBBcGkgUmVwb25zZTonLCByZXNwb25zZSk7XG5cbiAgICB0aGlzLl9yZXNvbHZlQ29ycmVsYXRpb24oaWQsIHJlc3BvbnNlLmJvZHkpO1xuICB9O1xuICBwcml2YXRlIF9hZGRDb3JyZWxhdGlvbihjb3JySWQ6IG51bWJlciwgcmVxdWVzdDogUmVxdWVzdCwgc3ViOiBTdWJqZWN0PE9iamVjdD4pIHtcbiAgICB0aGlzLl9jb3JyZWxhdGlvbnMucHVzaCh7IGlkOiBjb3JySWQsIHJlcXVlc3Q6IHJlcXVlc3QsIHN1YmplY3Q6IHN1YiB9KTtcbiAgfVxuICBwcml2YXRlIF9yZXNvbHZlQ29ycmVsYXRpb24gPSAoY29ycklkOiBudW1iZXIsIGJvZHk6IHN0cmluZyB8IE9iamVjdCkgPT4ge1xuICAgIGNvbnN0IGNvcnJlbGF0aW9uID0gdGhpcy5fY29ycmVsYXRpb25zLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBjb3JySWQpO1xuXG4gICAgaWYgKCFjb3JyZWxhdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgY29udGVudDtcbiAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb250ZW50ID0gSlNPTi5wYXJzZSg8c3RyaW5nPmJvZHkpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29udGVudCA9IGJvZHk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnRlbnQgPSBib2R5O1xuICAgIH1cbiAgICB0aGlzLl9yZXNvbHZlUmVzcG9uc2VTdGF0dXMoY29ycmVsYXRpb24sIGNvbnRlbnQpO1xuXG4gICAgdGhpcy5fY29ycmVsYXRpb25zID0gdGhpcy5fY29ycmVsYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IGNvcnJlbGF0aW9uKTtcbiAgICBpZiAodGhpcy5yZXF1ZXN0SW5Qcm9ncmVzc051bWJlciA9PT0gMCkge1xuICAgICAgdGhpcy5fcmV0cnlQZW5kaW5nKCk7XG4gICAgfVxuICB9O1xuICBwcml2YXRlIF9yZXNvbHZlUmVzcG9uc2VTdGF0dXMoY29ycmVsYXRpb246IENvcnJlbGF0aW9uLCBjb250ZW50OiBJQmFzZVJlc3BvbnNlKSB7XG4gICAgTG9nZ2VyLkxvZ0luZm8oJ1tTRVJWRVJdIEFwaSBSZXBvbnNlIGNvbnRlbnQ6JywgY29udGVudC5TdGF0dXMsIGNvbnRlbnQuQ29udGVudCk7XG4gICAgc3dpdGNoIChjb250ZW50LlN0YXR1cykge1xuICAgICAgY2FzZSBTdGF0dXNSZXBvbnNlLlN1Y2Nlc3NmdWw6XG4gICAgICBjYXNlIFN0YXR1c1JlcG9uc2UuTm9Db250ZW50OlxuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0Lm5leHQoY29udGVudC5Db250ZW50KTtcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC5lcnJvcihjb250ZW50LkNvbnRlbnQpO1xuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9yZXRyeVBlbmRpbmcoKSB7XG4gICAgY29uc3QgbGlzdCA9IFsuLi50aGlzLl90ZW1wUGVuZGluZ1JlcXVlc3RdO1xuICAgIHRoaXMuX3RlbXBQZW5kaW5nUmVxdWVzdCA9IFtdO1xuXG4gICAgdGhpcy5yZXRyeVJlcXVlc3QobGlzdCk7XG4gIH1cblxuICBwcml2YXRlIF9yZXRyeUxvZ2luUmVxdWlyZWQoKSB7XG4gICAgY29uc3QgbGlzdCA9IFsuLi50aGlzLl90ZW1wTG9naW5SZXF1aXJlZFJlcXVlc3RdO1xuICAgIHRoaXMuX3RlbXBMb2dpblJlcXVpcmVkUmVxdWVzdCA9IFtdO1xuXG4gICAgdGhpcy5yZXRyeVJlcXVlc3QobGlzdCk7XG4gIH1cblxuICBwcml2YXRlIF9nZXQodXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAuZ2V0PElCYWNrUmVzcG9uc2U+KHVybCwge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCksXG4gICAgICAgIHBhcmFtczogeyBjYWNoZVRpbWU6IHJlcXVlc3QuY2FjaGVUaW1lIH0sXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHtcbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UsIDIwMCkpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogbWVzc2FnZSA9PiB7XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBHRVQgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3Bvc3QodXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAucG9zdDxJQmFja1Jlc3BvbnNlPih1cmwsIHJlcXVlc3QuQnJ1dENvbnRlbnQsIHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5faGVhZGVycygpLFxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiByZXNwb25zZSA9PiB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKSxcbiAgICAgICAgZXJyb3I6IG1lc3NhZ2UgPT4gdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKSksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBQT1NUIENMT1NFJyksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9wYXRjaCh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHAucGF0Y2g8SUJhY2tSZXNwb25zZT4odXJsLCByZXF1ZXN0LkNvbnRlbnQsIHsgaGVhZGVyczogdGhpcy5faGVhZGVycygpIH0pLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiByZXNwb25zZSA9PiB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKSxcbiAgICAgIGVycm9yOiBtZXNzYWdlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cykpLFxuICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZygnQVBJIFBBVENIIENMT1NFJyksXG4gICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfcHV0KHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cC5wdXQ8SUJhY2tSZXNwb25zZT4odXJsLCByZXF1ZXN0LkNvbnRlbnQsIHsgaGVhZGVyczogdGhpcy5faGVhZGVycygpIH0pLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiByZXNwb25zZSA9PiB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKSxcbiAgICAgIGVycm9yOiBtZXNzYWdlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cykpLFxuICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZygnQVBJIFBVVCBDTE9TRScpLFxuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX2RlbGV0ZSh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHAuZGVsZXRlPElCYWNrUmVzcG9uc2U+KHVybCwgeyBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCkgfSkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpLFxuICAgICAgZXJyb3I6IG1lc3NhZ2UgPT4gdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKSksXG4gICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgREVMRVRFIENMT1NFJyksXG4gICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfZmlsZXModXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAucG9zdDxJQmFja1Jlc3BvbnNlPih1cmwsIHJlcXVlc3QuQnJ1dENvbnRlbnQuZmlsZXMsIHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5faGVhZGVycyh7XG4gICAgICAgICAgY29udGVudFR5cGU6ICcnLFxuICAgICAgICB9KSxcbiAgICAgIH0pXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogcmVzcG9uc2UgPT4ge1xuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogbWVzc2FnZSA9PiB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpKSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZygnQVBJIERFTEVURSBDTE9TRScpLFxuICAgICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfdXBkYXRlRmlsZXModXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAucHV0PElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5CcnV0Q29udGVudC5maWxlcywge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKHtcbiAgICAgICAgICBjb250ZW50VHlwZTogJycsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiByZXNwb25zZSA9PiB7XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBtZXNzYWdlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cykpLFxuICAgICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgREVMRVRFIENMT1NFJyksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlOiBvYmplY3QsIHN0YXR1czogbnVtYmVyID0gMjAwKTogSVJlc3BvbnNlIHtcbiAgICByZXR1cm4geyBib2R5OiB7IFN0YXR1czogc3RhdHVzLCBDb250ZW50OiByZXNwb25zZSB9IH07XG4gIH1cbiAgcHJpdmF0ZSBfaGVhZGVycyhvcHRpb24/OiB7IGNvbnRlbnRUeXBlPzogc3RyaW5nIH0pOiBIdHRwSGVhZGVycyB7XG4gICAgbGV0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcblxuICAgIGlmIChvcHRpb24/LmNvbnRlbnRUeXBlICE9PSAnJykge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCBvcHRpb24/LmNvbnRlbnRUeXBlID8gb3B0aW9uPy5jb250ZW50VHlwZSA6ICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgfVxuXG4gICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCB0aGlzLl9jb25maWc/LnNlcnZlclVybCA/PyAnJyk7XG5cbiAgICBMb2dnZXIuTG9nSW5mbygnW1NFUlZFUl0gQXBpIFJlcXVlc3QgSGVhZGVyOicsIGhlYWRlcnMpO1xuXG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cbn1cbiJdfQ==