import { HttpClient, HttpHeaders } from "@angular/common/http";
import { Inject, Injectable, InjectionToken, Optional } from "@angular/core";
import { Subject } from "rxjs";
import { Logger } from "../../logger";
import { StatusReponse, } from "../response";
import { RequestMap } from "./requestMap";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export const SERVER_CONFIG_KEY = new InjectionToken("config_server");
export class TaServerSevice {
    get requestInProgressNumber() {
        return this._correlations.length;
    }
    get isAuthenticated() {
        return this._isAuthenticated;
    }
    set isAuthenticated(value) {
        this._isAuthenticated = value;
        if (this._isAuthenticated) {
            this._retryLoginRequired();
        }
    }
    constructor($http, _config) {
        this.$http = $http;
        this._config = _config;
        this._tempLoginRequiredRequest = [];
        this._tempPendingRequest = [];
        this._correlations = [];
        this._isAuthenticated = false;
        this._onPacketReceived = (id, response) => {
            Logger.LogInfo("[SERVER] Api Reponse:", response);
            this._resolveCorrelation(id, response.body);
        };
        this._resolveCorrelation = (corrId, body) => {
            const correlation = this._correlations.find((item) => item.id === corrId);
            if (!correlation) {
                return;
            }
            let content;
            if (typeof body === "string") {
                try {
                    content = JSON.parse(body);
                }
                catch (error) {
                    content = body;
                }
            }
            else {
                content = body;
            }
            this._resolveResponseStatus(correlation, content);
            this._correlations = this._correlations.filter((item) => item !== correlation);
            if (this.requestInProgressNumber === 0) {
                this._retryPending();
            }
        };
    }
    registerRoutes(routes) {
        RequestMap.register(routes);
    }
    request(request) {
        const subject = new Subject();
        this._send(subject, request);
        return subject;
    }
    retryRequest(list = []) {
        for (const request of list) {
            this._send(request.subject, request.request);
        }
    }
    _send(subject, request) {
        if (!this._config) {
            return;
        }
        // le user doit etre connecté
        if (request.loginRequired === true && this.isAuthenticated === false) {
            this._tempLoginRequiredRequest.push({
                request: request,
                subject: subject,
            });
            return;
        }
        if (this.requestInProgressNumber >= this._config.pendindRequestId) {
            this._tempPendingRequest.push({ request: request, subject: subject });
            return;
        }
        this._addCorrelation(request.id, request, subject);
        this._sendRequest(request);
    }
    _sendRequest(request) {
        if (!this._config) {
            return;
        }
        const requestConfig = RequestMap.getConfigById(request.type);
        if (!requestConfig) {
            return;
        }
        const url = RequestMap.parseUrl({
            serverUrl: this._config.serverUrl,
            url: requestConfig.url,
            request,
            apiExt: this._config.apiExt,
        });
        Logger.LogInfo("[SERVER] Api Request:", url, request);
        switch (requestConfig.type) {
            case "GET":
                this._get(url, request);
                break;
            case "POST":
                this._post(url, request);
                break;
            case "PUT":
                this._put(url, request);
                break;
            case "PATCH":
                this._patch(url, request);
                break;
            case "DELETE":
                this._delete(url, request);
                break;
            case "FILES":
                this._files(url, request);
                break;
            case "UPDATEFILES":
                this._updateFiles(url, request);
                break;
            default:
                Logger.LogError("[ERROR] Request not send");
        }
    }
    _addCorrelation(corrId, request, sub) {
        this._correlations.push({ id: corrId, request: request, subject: sub });
    }
    _resolveResponseStatus(correlation, content) {
        Logger.LogInfo("[SERVER] Api Reponse content:", content.Status, content.Content);
        switch (content.Status) {
            case StatusReponse.Successful:
            case StatusReponse.NoContent:
                correlation.subject.next(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
                break;
            default:
                correlation.subject.error(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
        }
    }
    _retryPending() {
        const list = [...this._tempPendingRequest];
        this._tempPendingRequest = [];
        this.retryRequest(list);
    }
    _retryLoginRequired() {
        const list = [...this._tempLoginRequiredRequest];
        this._tempLoginRequiredRequest = [];
        this.retryRequest(list);
    }
    _get(url, request) {
        this.$http
            .get(url, {
            headers: this._headers(),
            params: { cacheTime: request.cacheTime },
        })
            .subscribe({
            next: (response) => {
                this._onPacketReceived(request.id, this._formatReponse(response, 200));
            },
            error: (message) => {
                this._onPacketReceived(request.id, this._formatReponse(message, message.status));
            },
            complete: () => Logger.LogDebug("API GET CLOSE"),
        });
    }
    _post(url, request) {
        this.$http
            .post(url, request.BrutContent, {
            headers: this._headers(),
        })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug("API POST CLOSE"),
        });
    }
    _patch(url, request) {
        this.$http
            .patch(url, request.Content, { headers: this._headers() })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug("API PATCH CLOSE"),
        });
    }
    _put(url, request) {
        this.$http
            .put(url, request.Content, { headers: this._headers() })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug("API PUT CLOSE"),
        });
    }
    _delete(url, request) {
        this.$http
            .delete(url, { headers: this._headers() })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug("API DELETE CLOSE"),
        });
    }
    _files(url, request) {
        this.$http
            .post(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: "",
            }),
        })
            .subscribe({
            next: (response) => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug("API DELETE CLOSE"),
        });
    }
    _updateFiles(url, request) {
        this.$http
            .put(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: "",
            }),
        })
            .subscribe({
            next: (response) => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug("API DELETE CLOSE"),
        });
    }
    _formatReponse(response, status = 200) {
        return { body: { Status: status, Content: response } };
    }
    _headers(option) {
        let headers = new HttpHeaders();
        if (option?.contentType !== "") {
            headers = headers.set("Content-Type", option?.contentType ? option?.contentType : "application/json");
        }
        headers = headers.set("Access-Control-Allow-Origin", this._config?.serverUrl ?? "");
        Logger.LogInfo("[SERVER] Api Request Header:", headers);
        return headers;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaServerSevice, deps: [{ token: HttpClient }, { token: SERVER_CONFIG_KEY, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaServerSevice, providedIn: "root" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaServerSevice, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient, decorators: [{
                    type: Inject,
                    args: [HttpClient]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [SERVER_CONFIG_KEY]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL3NlcnZlci9hcGkvc2VydmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUd0QyxPQUFPLEVBSUwsYUFBYSxHQUNkLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBa0IsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDOzs7QUFFMUQsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxjQUFjLENBQ2pELGVBQWUsQ0FDaEIsQ0FBQztBQVNGLE1BQU0sT0FBTyxjQUFjO0lBQ3pCLElBQUksdUJBQXVCO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7SUFDbkMsQ0FBQztJQVFELElBQUksZUFBZTtRQUNqQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBQ0QsSUFBSSxlQUFlLENBQUMsS0FBYztRQUNoQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDN0IsQ0FBQztJQUNILENBQUM7SUFFRCxZQUM2QixLQUFpQixFQUNHLE9BQXFCO1FBRHpDLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDRyxZQUFPLEdBQVAsT0FBTyxDQUFjO1FBbEI5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LE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUNuQixjQUFjLEVBQ2QsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQy9ELENBQUM7UUFDSixDQUFDO1FBRUQsT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQ25CLDZCQUE2QixFQUM3QixJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsSUFBSSxFQUFFLENBQzlCLENBQUM7UUFFRixNQUFNLENBQUMsT0FBTyxDQUFDLDhCQUE4QixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXhELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7K0dBN1RVLGNBQWMsa0JBc0JmLFVBQVUsYUFDRSxpQkFBaUI7bUhBdkI1QixjQUFjLGNBRmIsTUFBTTs7NEZBRVAsY0FBYztrQkFIMUIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQXVCSSxNQUFNOzJCQUFDLFVBQVU7OzBCQUNqQixRQUFROzswQkFBSSxNQUFNOzJCQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5cbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tIFwicnhqc1wiO1xuXG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tIFwiLi4vLi4vbG9nZ2VyXCI7XG5pbXBvcnQgeyBDb3JyZWxhdGlvbiwgVGVtcFJlcXVlc3QgfSBmcm9tIFwiLi4vaW50ZXJmYWNlXCI7XG5pbXBvcnQgeyBSZXF1ZXN0IH0gZnJvbSBcIi4uL3JlcXVlc3RcIjtcbmltcG9ydCB7XG4gIElCYWNrUmVzcG9uc2UsXG4gIElCYXNlUmVzcG9uc2UsXG4gIElSZXNwb25zZSxcbiAgU3RhdHVzUmVwb25zZSxcbn0gZnJvbSBcIi4uL3Jlc3BvbnNlXCI7XG5pbXBvcnQgeyBNYXBwaW5nQXBpVHlwZSwgUmVxdWVzdE1hcCB9IGZyb20gXCIuL3JlcXVlc3RNYXBcIjtcblxuZXhwb3J0IGNvbnN0IFNFUlZFUl9DT05GSUdfS0VZID0gbmV3IEluamVjdGlvblRva2VuPElSZXN0Q29uZmlnPihcbiAgXCJjb25maWdfc2VydmVyXCJcbik7XG5leHBvcnQgaW50ZXJmYWNlIElSZXN0Q29uZmlnIHtcbiAgcGVuZGluZFJlcXVlc3RJZDogbnVtYmVyO1xuICBzZXJ2ZXJVcmw6IHN0cmluZztcbiAgYXBpRXh0Pzogc3RyaW5nO1xufVxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiBcInJvb3RcIixcbn0pXG5leHBvcnQgY2xhc3MgVGFTZXJ2ZXJTZXZpY2Uge1xuICBnZXQgcmVxdWVzdEluUHJvZ3Jlc3NOdW1iZXIoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fY29ycmVsYXRpb25zLmxlbmd0aDtcbiAgfVxuXG4gIHByaXZhdGUgX3RlbXBMb2dpblJlcXVpcmVkUmVxdWVzdDogVGVtcFJlcXVlc3RbXSA9IFtdO1xuICBwcml2YXRlIF90ZW1wUGVuZGluZ1JlcXVlc3Q6IFRlbXBSZXF1ZXN0W10gPSBbXTtcblxuICBwcml2YXRlIF9jb3JyZWxhdGlvbnM6IENvcnJlbGF0aW9uW10gPSBbXTtcblxuICBwcml2YXRlIF9pc0F1dGhlbnRpY2F0ZWQgPSBmYWxzZTtcbiAgZ2V0IGlzQXV0aGVudGljYXRlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNBdXRoZW50aWNhdGVkO1xuICB9XG4gIHNldCBpc0F1dGhlbnRpY2F0ZWQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9pc0F1dGhlbnRpY2F0ZWQgPSB2YWx1ZTtcbiAgICBpZiAodGhpcy5faXNBdXRoZW50aWNhdGVkKSB7XG4gICAgICB0aGlzLl9yZXRyeUxvZ2luUmVxdWlyZWQoKTtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEh0dHBDbGllbnQpIHB1YmxpYyAkaHR0cDogSHR0cENsaWVudCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFNFUlZFUl9DT05GSUdfS0VZKSBwcml2YXRlIF9jb25maWc/OiBJUmVzdENvbmZpZ1xuICApIHt9XG5cbiAgcHVibGljIHJlZ2lzdGVyUm91dGVzKHJvdXRlczogTWFwcGluZ0FwaVR5cGUpIHtcbiAgICBSZXF1ZXN0TWFwLnJlZ2lzdGVyKHJvdXRlcyk7XG4gIH1cblxuICBwdWJsaWMgcmVxdWVzdDxUPihyZXF1ZXN0OiBSZXF1ZXN0KTogU3ViamVjdDxUPiB7XG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0PE9iamVjdD4oKTtcbiAgICB0aGlzLl9zZW5kKHN1YmplY3QsIHJlcXVlc3QpO1xuICAgIHJldHVybiBzdWJqZWN0IGFzIHVua25vd24gYXMgU3ViamVjdDxUPjtcbiAgfVxuICBwdWJsaWMgcmV0cnlSZXF1ZXN0KGxpc3Q6IFRlbXBSZXF1ZXN0W10gPSBbXSkge1xuICAgIGZvciAoY29uc3QgcmVxdWVzdCBvZiBsaXN0KSB7XG4gICAgICB0aGlzLl9zZW5kKHJlcXVlc3Quc3ViamVjdCwgcmVxdWVzdC5yZXF1ZXN0KTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBfc2VuZChzdWJqZWN0OiBTdWJqZWN0PE9iamVjdD4sIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICBpZiAoIXRoaXMuX2NvbmZpZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBsZSB1c2VyIGRvaXQgZXRyZSBjb25uZWN0w6lcbiAgICBpZiAocmVxdWVzdC5sb2dpblJlcXVpcmVkID09PSB0cnVlICYmIHRoaXMuaXNBdXRoZW50aWNhdGVkID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5fdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0LnB1c2goe1xuICAgICAgICByZXF1ZXN0OiByZXF1ZXN0LFxuICAgICAgICBzdWJqZWN0OiBzdWJqZWN0LFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucmVxdWVzdEluUHJvZ3Jlc3NOdW1iZXIgPj0gdGhpcy5fY29uZmlnLnBlbmRpbmRSZXF1ZXN0SWQpIHtcbiAgICAgIHRoaXMuX3RlbXBQZW5kaW5nUmVxdWVzdC5wdXNoKHsgcmVxdWVzdDogcmVxdWVzdCwgc3ViamVjdDogc3ViamVjdCB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLl9hZGRDb3JyZWxhdGlvbihyZXF1ZXN0LmlkLCByZXF1ZXN0LCBzdWJqZWN0KTtcblxuICAgIHRoaXMuX3NlbmRSZXF1ZXN0KHJlcXVlc3QpO1xuICB9XG4gIHByaXZhdGUgX3NlbmRSZXF1ZXN0KHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICBpZiAoIXRoaXMuX2NvbmZpZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0Q29uZmlnID0gUmVxdWVzdE1hcC5nZXRDb25maWdCeUlkKHJlcXVlc3QudHlwZSk7XG4gICAgaWYgKCFyZXF1ZXN0Q29uZmlnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHVybCA9IFJlcXVlc3RNYXAucGFyc2VVcmwoe1xuICAgICAgc2VydmVyVXJsOiB0aGlzLl9jb25maWcuc2VydmVyVXJsLFxuICAgICAgdXJsOiByZXF1ZXN0Q29uZmlnLnVybCxcbiAgICAgIHJlcXVlc3QsXG4gICAgICBhcGlFeHQ6IHRoaXMuX2NvbmZpZy5hcGlFeHQsXG4gICAgfSk7XG4gICAgTG9nZ2VyLkxvZ0luZm8oXCJbU0VSVkVSXSBBcGkgUmVxdWVzdDpcIiwgdXJsLCByZXF1ZXN0KTtcblxuICAgIHN3aXRjaCAocmVxdWVzdENvbmZpZy50eXBlKSB7XG4gICAgICBjYXNlIFwiR0VUXCI6XG4gICAgICAgIHRoaXMuX2dldCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJQT1NUXCI6XG4gICAgICAgIHRoaXMuX3Bvc3QodXJsLCByZXF1ZXN0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiUFVUXCI6XG4gICAgICAgIHRoaXMuX3B1dCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJQQVRDSFwiOlxuICAgICAgICB0aGlzLl9wYXRjaCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJERUxFVEVcIjpcbiAgICAgICAgdGhpcy5fZGVsZXRlKHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIkZJTEVTXCI6XG4gICAgICAgIHRoaXMuX2ZpbGVzKHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIlVQREFURUZJTEVTXCI6XG4gICAgICAgIHRoaXMuX3VwZGF0ZUZpbGVzKHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKFwiW0VSUk9SXSBSZXF1ZXN0IG5vdCBzZW5kXCIpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIF9vblBhY2tldFJlY2VpdmVkID0gKGlkOiBudW1iZXIsIHJlc3BvbnNlOiBJUmVzcG9uc2UpOiB2b2lkID0+IHtcbiAgICBMb2dnZXIuTG9nSW5mbyhcIltTRVJWRVJdIEFwaSBSZXBvbnNlOlwiLCByZXNwb25zZSk7XG5cbiAgICB0aGlzLl9yZXNvbHZlQ29ycmVsYXRpb24oaWQsIHJlc3BvbnNlLmJvZHkpO1xuICB9O1xuICBwcml2YXRlIF9hZGRDb3JyZWxhdGlvbihcbiAgICBjb3JySWQ6IG51bWJlcixcbiAgICByZXF1ZXN0OiBSZXF1ZXN0LFxuICAgIHN1YjogU3ViamVjdDxPYmplY3Q+XG4gICkge1xuICAgIHRoaXMuX2NvcnJlbGF0aW9ucy5wdXNoKHsgaWQ6IGNvcnJJZCwgcmVxdWVzdDogcmVxdWVzdCwgc3ViamVjdDogc3ViIH0pO1xuICB9XG4gIHByaXZhdGUgX3Jlc29sdmVDb3JyZWxhdGlvbiA9IChjb3JySWQ6IG51bWJlciwgYm9keTogc3RyaW5nIHwgT2JqZWN0KSA9PiB7XG4gICAgY29uc3QgY29ycmVsYXRpb24gPSB0aGlzLl9jb3JyZWxhdGlvbnMuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gY29ycklkKTtcblxuICAgIGlmICghY29ycmVsYXRpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGNvbnRlbnQ7XG4gICAgaWYgKHR5cGVvZiBib2R5ID09PSBcInN0cmluZ1wiKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb250ZW50ID0gSlNPTi5wYXJzZSg8c3RyaW5nPmJvZHkpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29udGVudCA9IGJvZHk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnRlbnQgPSBib2R5O1xuICAgIH1cbiAgICB0aGlzLl9yZXNvbHZlUmVzcG9uc2VTdGF0dXMoY29ycmVsYXRpb24sIGNvbnRlbnQpO1xuXG4gICAgdGhpcy5fY29ycmVsYXRpb25zID0gdGhpcy5fY29ycmVsYXRpb25zLmZpbHRlcihcbiAgICAgIChpdGVtKSA9PiBpdGVtICE9PSBjb3JyZWxhdGlvblxuICAgICk7XG4gICAgaWYgKHRoaXMucmVxdWVzdEluUHJvZ3Jlc3NOdW1iZXIgPT09IDApIHtcbiAgICAgIHRoaXMuX3JldHJ5UGVuZGluZygpO1xuICAgIH1cbiAgfTtcbiAgcHJpdmF0ZSBfcmVzb2x2ZVJlc3BvbnNlU3RhdHVzKFxuICAgIGNvcnJlbGF0aW9uOiBDb3JyZWxhdGlvbixcbiAgICBjb250ZW50OiBJQmFzZVJlc3BvbnNlXG4gICkge1xuICAgIExvZ2dlci5Mb2dJbmZvKFxuICAgICAgXCJbU0VSVkVSXSBBcGkgUmVwb25zZSBjb250ZW50OlwiLFxuICAgICAgY29udGVudC5TdGF0dXMsXG4gICAgICBjb250ZW50LkNvbnRlbnRcbiAgICApO1xuICAgIHN3aXRjaCAoY29udGVudC5TdGF0dXMpIHtcbiAgICAgIGNhc2UgU3RhdHVzUmVwb25zZS5TdWNjZXNzZnVsOlxuICAgICAgY2FzZSBTdGF0dXNSZXBvbnNlLk5vQ29udGVudDpcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC5uZXh0KGNvbnRlbnQuQ29udGVudCk7XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC51bnN1YnNjcmliZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QuZXJyb3IoY29udGVudC5Db250ZW50KTtcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfcmV0cnlQZW5kaW5nKCkge1xuICAgIGNvbnN0IGxpc3QgPSBbLi4udGhpcy5fdGVtcFBlbmRpbmdSZXF1ZXN0XTtcbiAgICB0aGlzLl90ZW1wUGVuZGluZ1JlcXVlc3QgPSBbXTtcblxuICAgIHRoaXMucmV0cnlSZXF1ZXN0KGxpc3QpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmV0cnlMb2dpblJlcXVpcmVkKCkge1xuICAgIGNvbnN0IGxpc3QgPSBbLi4udGhpcy5fdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0XTtcbiAgICB0aGlzLl90ZW1wTG9naW5SZXF1aXJlZFJlcXVlc3QgPSBbXTtcblxuICAgIHRoaXMucmV0cnlSZXF1ZXN0KGxpc3QpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0KHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cFxuICAgICAgLmdldDxJQmFja1Jlc3BvbnNlPih1cmwsIHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5faGVhZGVycygpLFxuICAgICAgICBwYXJhbXM6IHsgY2FjaGVUaW1lOiByZXF1ZXN0LmNhY2hlVGltZSB9LFxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKFxuICAgICAgICAgICAgcmVxdWVzdC5pZCxcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UsIDIwMClcbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKFxuICAgICAgICAgICAgcmVxdWVzdC5pZCxcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpXG4gICAgICAgICAgKTtcbiAgICAgICAgfSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZyhcIkFQSSBHRVQgQ0xPU0VcIiksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9wb3N0KHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cFxuICAgICAgLnBvc3Q8SUJhY2tSZXNwb25zZT4odXJsLCByZXF1ZXN0LkJydXRDb250ZW50LCB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSxcbiAgICAgIH0pXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKHJlc3BvbnNlKSA9PlxuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpLFxuICAgICAgICBlcnJvcjogKG1lc3NhZ2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKVxuICAgICAgICAgICksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoXCJBUEkgUE9TVCBDTE9TRVwiKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3BhdGNoKHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cFxuICAgICAgLnBhdGNoPElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5Db250ZW50LCB7IGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChyZXNwb25zZSkgPT5cbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKSxcbiAgICAgICAgZXJyb3I6IChtZXNzYWdlKSA9PlxuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQoXG4gICAgICAgICAgICByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cylcbiAgICAgICAgICApLFxuICAgICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKFwiQVBJIFBBVENIIENMT1NFXCIpLFxuICAgICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfcHV0KHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cFxuICAgICAgLnB1dDxJQmFja1Jlc3BvbnNlPih1cmwsIHJlcXVlc3QuQ29udGVudCwgeyBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCkgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAocmVzcG9uc2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlKSksXG4gICAgICAgIGVycm9yOiAobWVzc2FnZSkgPT5cbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKFxuICAgICAgICAgICAgcmVxdWVzdC5pZCxcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpXG4gICAgICAgICAgKSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZyhcIkFQSSBQVVQgQ0xPU0VcIiksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9kZWxldGUodXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAuZGVsZXRlPElCYWNrUmVzcG9uc2U+KHVybCwgeyBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCkgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAocmVzcG9uc2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlKSksXG4gICAgICAgIGVycm9yOiAobWVzc2FnZSkgPT5cbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKFxuICAgICAgICAgICAgcmVxdWVzdC5pZCxcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpXG4gICAgICAgICAgKSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZyhcIkFQSSBERUxFVEUgQ0xPU0VcIiksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9maWxlcyh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wb3N0PElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5CcnV0Q29udGVudC5maWxlcywge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKHtcbiAgICAgICAgICBjb250ZW50VHlwZTogXCJcIixcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKG1lc3NhZ2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKVxuICAgICAgICAgICksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoXCJBUEkgREVMRVRFIENMT1NFXCIpLFxuICAgICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfdXBkYXRlRmlsZXModXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAucHV0PElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5CcnV0Q29udGVudC5maWxlcywge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKHtcbiAgICAgICAgICBjb250ZW50VHlwZTogXCJcIixcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKG1lc3NhZ2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKVxuICAgICAgICAgICksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoXCJBUEkgREVMRVRFIENMT1NFXCIpLFxuICAgICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfZm9ybWF0UmVwb25zZShyZXNwb25zZTogb2JqZWN0LCBzdGF0dXM6IG51bWJlciA9IDIwMCk6IElSZXNwb25zZSB7XG4gICAgcmV0dXJuIHsgYm9keTogeyBTdGF0dXM6IHN0YXR1cywgQ29udGVudDogcmVzcG9uc2UgfSB9O1xuICB9XG4gIHByaXZhdGUgX2hlYWRlcnMob3B0aW9uPzogeyBjb250ZW50VHlwZT86IHN0cmluZyB9KTogSHR0cEhlYWRlcnMge1xuICAgIGxldCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG5cbiAgICBpZiAob3B0aW9uPy5jb250ZW50VHlwZSAhPT0gXCJcIikge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KFxuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiLFxuICAgICAgICBvcHRpb24/LmNvbnRlbnRUeXBlID8gb3B0aW9uPy5jb250ZW50VHlwZSA6IFwiYXBwbGljYXRpb24vanNvblwiXG4gICAgICApO1xuICAgIH1cblxuICAgIGhlYWRlcnMgPSBoZWFkZXJzLnNldChcbiAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCIsXG4gICAgICB0aGlzLl9jb25maWc/LnNlcnZlclVybCA/PyBcIlwiXG4gICAgKTtcblxuICAgIExvZ2dlci5Mb2dJbmZvKFwiW1NFUlZFUl0gQXBpIFJlcXVlc3QgSGVhZGVyOlwiLCBoZWFkZXJzKTtcblxuICAgIHJldHVybiBoZWFkZXJzO1xuICB9XG59XG4iXX0=