import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { Subject } from 'rxjs';
import { Logger } from '../../logger';
import { StatusReponse, } from '../response';
import { RequestMap } from './requestMap';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export const SERVER_CONFIG_KEY = new InjectionToken('config_server');
export class CamServerSevice {
    get requestInProgressNumber() {
        return this._correlations.length;
    }
    get isAuthenticated() {
        return this._isAuthenticated;
    }
    set isAuthenticated(value) {
        this._isAuthenticated = value;
        if (this._isAuthenticated) {
            this._retryLoginRequired();
        }
    }
    constructor($http, _config) {
        this.$http = $http;
        this._config = _config;
        this._tempLoginRequiredRequest = [];
        this._tempPendingRequest = [];
        this._correlations = [];
        this._isAuthenticated = false;
        this._onPacketReceived = (id, response) => {
            Logger.LogInfo('[SERVER] Api Reponse:', response);
            this._resolveCorrelation(id, response.body);
        };
        this._resolveCorrelation = (corrId, body) => {
            const correlation = this._correlations.find((item) => item.id === corrId);
            if (!correlation) {
                return;
            }
            let content;
            if (typeof body === 'string') {
                try {
                    content = JSON.parse(body);
                }
                catch (error) {
                    content = body;
                }
            }
            else {
                content = body;
            }
            this._resolveResponseStatus(correlation, content);
            this._correlations = this._correlations.filter((item) => item !== correlation);
            if (this.requestInProgressNumber === 0) {
                this._retryPending();
            }
        };
    }
    registerRoutes(routes) {
        RequestMap.register(routes);
    }
    request(request) {
        const subject = new Subject();
        this._send(subject, request);
        return subject;
    }
    retryRequest(list = []) {
        for (const request of list) {
            this._send(request.subject, request.request);
        }
    }
    _send(subject, request) {
        if (!this._config) {
            return;
        }
        // le user doit etre connecté
        if (request.loginRequired === true && this.isAuthenticated === false) {
            this._tempLoginRequiredRequest.push({
                request: request,
                subject: subject,
            });
            return;
        }
        if (this.requestInProgressNumber >= this._config.pendindRequestId) {
            this._tempPendingRequest.push({ request: request, subject: subject });
            return;
        }
        this._addCorrelation(request.id, request, subject);
        this._sendRequest(request);
    }
    _sendRequest(request) {
        if (!this._config) {
            return;
        }
        const requestConfig = RequestMap.getConfigById(request.type);
        if (!requestConfig) {
            return;
        }
        const url = RequestMap.parseUrl({
            serverUrl: this._config.serverUrl,
            url: requestConfig.url,
            request,
            apiExt: this._config.apiExt,
        });
        Logger.LogInfo('[SERVER] Api Request:', url, request);
        switch (requestConfig.type) {
            case 'GET':
                this._get(url, request);
                break;
            case 'POST':
                this._post(url, request);
                break;
            case 'PUT':
                this._put(url, request);
                break;
            case 'PATCH':
                this._patch(url, request);
                break;
            case 'DELETE':
                this._delete(url, request);
                break;
            case 'FILES':
                this._files(url, request);
                break;
            case 'UPDATEFILES':
                this._updateFiles(url, request);
                break;
            default:
                Logger.LogError('[ERROR] Request not send');
        }
    }
    _addCorrelation(corrId, request, sub) {
        this._correlations.push({ id: corrId, request: request, subject: sub });
    }
    _resolveResponseStatus(correlation, content) {
        Logger.LogInfo('[SERVER] Api Reponse content:', content.Status, content.Content);
        switch (content.Status) {
            case StatusReponse.Successful:
            case StatusReponse.NoContent:
                correlation.subject.next(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
                break;
            default:
                correlation.subject.error(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
        }
    }
    _retryPending() {
        const list = [...this._tempPendingRequest];
        this._tempPendingRequest = [];
        this.retryRequest(list);
    }
    _retryLoginRequired() {
        const list = [...this._tempLoginRequiredRequest];
        this._tempLoginRequiredRequest = [];
        this.retryRequest(list);
    }
    _get(url, request) {
        this.$http
            .get(url, {
            headers: this._headers(),
            params: { cacheTime: request.cacheTime },
        })
            .subscribe({
            next: (response) => {
                this._onPacketReceived(request.id, this._formatReponse(response, 200));
            },
            error: (message) => {
                this._onPacketReceived(request.id, this._formatReponse(message, message.status));
            },
            complete: () => Logger.LogDebug('API GET CLOSE'),
        });
    }
    _post(url, request) {
        this.$http
            .post(url, request.BrutContent, {
            headers: this._headers(),
        })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API POST CLOSE'),
        });
    }
    _patch(url, request) {
        this.$http
            .patch(url, request.Content, { headers: this._headers() })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API PATCH CLOSE'),
        });
    }
    _put(url, request) {
        this.$http
            .put(url, request.Content, { headers: this._headers() })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API PUT CLOSE'),
        });
    }
    _delete(url, request) {
        this.$http
            .delete(url, { headers: this._headers() })
            .subscribe({
            next: (response) => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _files(url, request) {
        this.$http
            .post(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: '',
            }),
        })
            .subscribe({
            next: (response) => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _updateFiles(url, request) {
        this.$http
            .put(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: '',
            }),
        })
            .subscribe({
            next: (response) => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: (message) => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _formatReponse(response, status = 200) {
        return { body: { Status: status, Content: response } };
    }
    _headers(option) {
        let headers = new HttpHeaders();
        if (option?.contentType !== '') {
            headers = headers.set('Content-Type', option?.contentType ? option?.contentType : 'application/json');
        }
        headers = headers.set('Access-Control-Allow-Origin', this._config?.serverUrl ?? '');
        Logger.LogInfo('[SERVER] Api Request Header:', headers);
        return headers;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamServerSevice, deps: [{ token: HttpClient }, { token: SERVER_CONFIG_KEY, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamServerSevice, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CamServerSevice, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient, decorators: [{
                    type: Inject,
                    args: [HttpClient]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [SERVER_CONFIG_KEY]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL3NlcnZlci9hcGkvc2VydmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUd0QyxPQUFPLEVBSUwsYUFBYSxHQUNkLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBa0IsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDOzs7QUFFMUQsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxjQUFjLENBQ2pELGVBQWUsQ0FDaEIsQ0FBQztBQVNGLE1BQU0sT0FBTyxlQUFlO0lBQzFCLElBQUksdUJBQXVCO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7SUFDbkMsQ0FBQztJQVFELElBQUksZUFBZTtRQUNqQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBQ0QsSUFBSSxlQUFlLENBQUMsS0FBYztRQUNoQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDN0IsQ0FBQztJQUNILENBQUM7SUFFRCxZQUM2QixLQUFpQixFQUNHLE9BQXVCO1FBRDNDLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDRyxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQWxC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QixPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FDbkIsY0FBYyxFQUNkLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUMvRCxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUNuQiw2QkFBNkIsRUFDN0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTLElBQUksRUFBRSxDQUM5QixDQUFDO1FBRUYsTUFBTSxDQUFDLE9BQU8sQ0FBQyw4QkFBOEIsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUV4RCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOytHQTdUVSxlQUFlLGtCQXNCaEIsVUFBVSxhQUNFLGlCQUFpQjttSEF2QjVCLGVBQWUsY0FGZCxNQUFNOzs0RkFFUCxlQUFlO2tCQUgzQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBdUJJLE1BQU07MkJBQUMsVUFBVTs7MEJBQ2pCLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uLy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBDb3JyZWxhdGlvbiwgVGVtcFJlcXVlc3QgfSBmcm9tICcuLi9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJy4uL3JlcXVlc3QnO1xuaW1wb3J0IHtcbiAgSUJhY2tSZXNwb25zZSxcbiAgSUJhc2VSZXNwb25zZSxcbiAgSVJlc3BvbnNlLFxuICBTdGF0dXNSZXBvbnNlLFxufSBmcm9tICcuLi9yZXNwb25zZSc7XG5pbXBvcnQgeyBNYXBwaW5nQXBpVHlwZSwgUmVxdWVzdE1hcCB9IGZyb20gJy4vcmVxdWVzdE1hcCc7XG5cbmV4cG9ydCBjb25zdCBTRVJWRVJfQ09ORklHX0tFWSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxJU2VydmVyQ29uZmlnPihcbiAgJ2NvbmZpZ19zZXJ2ZXInXG4pO1xuZXhwb3J0IGludGVyZmFjZSBJU2VydmVyQ29uZmlnIHtcbiAgcGVuZGluZFJlcXVlc3RJZDogbnVtYmVyO1xuICBzZXJ2ZXJVcmw6IHN0cmluZztcbiAgYXBpRXh0Pzogc3RyaW5nO1xufVxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIENhbVNlcnZlclNldmljZSB7XG4gIGdldCByZXF1ZXN0SW5Qcm9ncmVzc051bWJlcigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9jb3JyZWxhdGlvbnMubGVuZ3RoO1xuICB9XG5cbiAgcHJpdmF0ZSBfdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0OiBUZW1wUmVxdWVzdFtdID0gW107XG4gIHByaXZhdGUgX3RlbXBQZW5kaW5nUmVxdWVzdDogVGVtcFJlcXVlc3RbXSA9IFtdO1xuXG4gIHByaXZhdGUgX2NvcnJlbGF0aW9uczogQ29ycmVsYXRpb25bXSA9IFtdO1xuXG4gIHByaXZhdGUgX2lzQXV0aGVudGljYXRlZCA9IGZhbHNlO1xuICBnZXQgaXNBdXRoZW50aWNhdGVkKCkge1xuICAgIHJldHVybiB0aGlzLl9pc0F1dGhlbnRpY2F0ZWQ7XG4gIH1cbiAgc2V0IGlzQXV0aGVudGljYXRlZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2lzQXV0aGVudGljYXRlZCA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl9pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgIHRoaXMuX3JldHJ5TG9naW5SZXF1aXJlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoSHR0cENsaWVudCkgcHVibGljICRodHRwOiBIdHRwQ2xpZW50LFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoU0VSVkVSX0NPTkZJR19LRVkpIHByaXZhdGUgX2NvbmZpZz86IElTZXJ2ZXJDb25maWdcbiAgKSB7fVxuXG4gIHB1YmxpYyByZWdpc3RlclJvdXRlcyhyb3V0ZXM6IE1hcHBpbmdBcGlUeXBlKSB7XG4gICAgUmVxdWVzdE1hcC5yZWdpc3Rlcihyb3V0ZXMpO1xuICB9XG5cbiAgcHVibGljIHJlcXVlc3Q8VD4ocmVxdWVzdDogUmVxdWVzdCk6IFN1YmplY3Q8VD4ge1xuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdDxPYmplY3Q+KCk7XG4gICAgdGhpcy5fc2VuZChzdWJqZWN0LCByZXF1ZXN0KTtcbiAgICByZXR1cm4gc3ViamVjdCBhcyB1bmtub3duIGFzIFN1YmplY3Q8VD47XG4gIH1cbiAgcHVibGljIHJldHJ5UmVxdWVzdChsaXN0OiBUZW1wUmVxdWVzdFtdID0gW10pIHtcbiAgICBmb3IgKGNvbnN0IHJlcXVlc3Qgb2YgbGlzdCkge1xuICAgICAgdGhpcy5fc2VuZChyZXF1ZXN0LnN1YmplY3QsIHJlcXVlc3QucmVxdWVzdCk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgX3NlbmQoc3ViamVjdDogU3ViamVjdDxPYmplY3Q+LCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgaWYgKCF0aGlzLl9jb25maWcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gbGUgdXNlciBkb2l0IGV0cmUgY29ubmVjdMOpXG4gICAgaWYgKHJlcXVlc3QubG9naW5SZXF1aXJlZCA9PT0gdHJ1ZSAmJiB0aGlzLmlzQXV0aGVudGljYXRlZCA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuX3RlbXBMb2dpblJlcXVpcmVkUmVxdWVzdC5wdXNoKHtcbiAgICAgICAgcmVxdWVzdDogcmVxdWVzdCxcbiAgICAgICAgc3ViamVjdDogc3ViamVjdCxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlcXVlc3RJblByb2dyZXNzTnVtYmVyID49IHRoaXMuX2NvbmZpZy5wZW5kaW5kUmVxdWVzdElkKSB7XG4gICAgICB0aGlzLl90ZW1wUGVuZGluZ1JlcXVlc3QucHVzaCh7IHJlcXVlc3Q6IHJlcXVlc3QsIHN1YmplY3Q6IHN1YmplY3QgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fYWRkQ29ycmVsYXRpb24ocmVxdWVzdC5pZCwgcmVxdWVzdCwgc3ViamVjdCk7XG5cbiAgICB0aGlzLl9zZW5kUmVxdWVzdChyZXF1ZXN0KTtcbiAgfVxuICBwcml2YXRlIF9zZW5kUmVxdWVzdChyZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgaWYgKCF0aGlzLl9jb25maWcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgcmVxdWVzdENvbmZpZyA9IFJlcXVlc3RNYXAuZ2V0Q29uZmlnQnlJZChyZXF1ZXN0LnR5cGUpO1xuICAgIGlmICghcmVxdWVzdENvbmZpZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB1cmwgPSBSZXF1ZXN0TWFwLnBhcnNlVXJsKHtcbiAgICAgIHNlcnZlclVybDogdGhpcy5fY29uZmlnLnNlcnZlclVybCxcbiAgICAgIHVybDogcmVxdWVzdENvbmZpZy51cmwsXG4gICAgICByZXF1ZXN0LFxuICAgICAgYXBpRXh0OiB0aGlzLl9jb25maWcuYXBpRXh0LFxuICAgIH0pO1xuICAgIExvZ2dlci5Mb2dJbmZvKCdbU0VSVkVSXSBBcGkgUmVxdWVzdDonLCB1cmwsIHJlcXVlc3QpO1xuXG4gICAgc3dpdGNoIChyZXF1ZXN0Q29uZmlnLnR5cGUpIHtcbiAgICAgIGNhc2UgJ0dFVCc6XG4gICAgICAgIHRoaXMuX2dldCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BPU1QnOlxuICAgICAgICB0aGlzLl9wb3N0KHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUFVUJzpcbiAgICAgICAgdGhpcy5fcHV0KHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUEFUQ0gnOlxuICAgICAgICB0aGlzLl9wYXRjaCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0RFTEVURSc6XG4gICAgICAgIHRoaXMuX2RlbGV0ZSh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0ZJTEVTJzpcbiAgICAgICAgdGhpcy5fZmlsZXModXJsLCByZXF1ZXN0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdVUERBVEVGSUxFUyc6XG4gICAgICAgIHRoaXMuX3VwZGF0ZUZpbGVzKHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbRVJST1JdIFJlcXVlc3Qgbm90IHNlbmQnKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBfb25QYWNrZXRSZWNlaXZlZCA9IChpZDogbnVtYmVyLCByZXNwb25zZTogSVJlc3BvbnNlKTogdm9pZCA9PiB7XG4gICAgTG9nZ2VyLkxvZ0luZm8oJ1tTRVJWRVJdIEFwaSBSZXBvbnNlOicsIHJlc3BvbnNlKTtcblxuICAgIHRoaXMuX3Jlc29sdmVDb3JyZWxhdGlvbihpZCwgcmVzcG9uc2UuYm9keSk7XG4gIH07XG4gIHByaXZhdGUgX2FkZENvcnJlbGF0aW9uKFxuICAgIGNvcnJJZDogbnVtYmVyLFxuICAgIHJlcXVlc3Q6IFJlcXVlc3QsXG4gICAgc3ViOiBTdWJqZWN0PE9iamVjdD5cbiAgKSB7XG4gICAgdGhpcy5fY29ycmVsYXRpb25zLnB1c2goeyBpZDogY29ycklkLCByZXF1ZXN0OiByZXF1ZXN0LCBzdWJqZWN0OiBzdWIgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfcmVzb2x2ZUNvcnJlbGF0aW9uID0gKGNvcnJJZDogbnVtYmVyLCBib2R5OiBzdHJpbmcgfCBPYmplY3QpID0+IHtcbiAgICBjb25zdCBjb3JyZWxhdGlvbiA9IHRoaXMuX2NvcnJlbGF0aW9ucy5maW5kKChpdGVtKSA9PiBpdGVtLmlkID09PSBjb3JySWQpO1xuXG4gICAgaWYgKCFjb3JyZWxhdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgY29udGVudDtcbiAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb250ZW50ID0gSlNPTi5wYXJzZSg8c3RyaW5nPmJvZHkpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29udGVudCA9IGJvZHk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnRlbnQgPSBib2R5O1xuICAgIH1cbiAgICB0aGlzLl9yZXNvbHZlUmVzcG9uc2VTdGF0dXMoY29ycmVsYXRpb24sIGNvbnRlbnQpO1xuXG4gICAgdGhpcy5fY29ycmVsYXRpb25zID0gdGhpcy5fY29ycmVsYXRpb25zLmZpbHRlcihcbiAgICAgIChpdGVtKSA9PiBpdGVtICE9PSBjb3JyZWxhdGlvblxuICAgICk7XG4gICAgaWYgKHRoaXMucmVxdWVzdEluUHJvZ3Jlc3NOdW1iZXIgPT09IDApIHtcbiAgICAgIHRoaXMuX3JldHJ5UGVuZGluZygpO1xuICAgIH1cbiAgfTtcbiAgcHJpdmF0ZSBfcmVzb2x2ZVJlc3BvbnNlU3RhdHVzKFxuICAgIGNvcnJlbGF0aW9uOiBDb3JyZWxhdGlvbixcbiAgICBjb250ZW50OiBJQmFzZVJlc3BvbnNlXG4gICkge1xuICAgIExvZ2dlci5Mb2dJbmZvKFxuICAgICAgJ1tTRVJWRVJdIEFwaSBSZXBvbnNlIGNvbnRlbnQ6JyxcbiAgICAgIGNvbnRlbnQuU3RhdHVzLFxuICAgICAgY29udGVudC5Db250ZW50XG4gICAgKTtcbiAgICBzd2l0Y2ggKGNvbnRlbnQuU3RhdHVzKSB7XG4gICAgICBjYXNlIFN0YXR1c1JlcG9uc2UuU3VjY2Vzc2Z1bDpcbiAgICAgIGNhc2UgU3RhdHVzUmVwb25zZS5Ob0NvbnRlbnQ6XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QubmV4dChjb250ZW50LkNvbnRlbnQpO1xuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LmVycm9yKGNvbnRlbnQuQ29udGVudCk7XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3JldHJ5UGVuZGluZygpIHtcbiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMuX3RlbXBQZW5kaW5nUmVxdWVzdF07XG4gICAgdGhpcy5fdGVtcFBlbmRpbmdSZXF1ZXN0ID0gW107XG5cbiAgICB0aGlzLnJldHJ5UmVxdWVzdChsaXN0KTtcbiAgfVxuXG4gIHByaXZhdGUgX3JldHJ5TG9naW5SZXF1aXJlZCgpIHtcbiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMuX3RlbXBMb2dpblJlcXVpcmVkUmVxdWVzdF07XG4gICAgdGhpcy5fdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0ID0gW107XG5cbiAgICB0aGlzLnJldHJ5UmVxdWVzdChsaXN0KTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldCh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5nZXQ8SUJhY2tSZXNwb25zZT4odXJsLCB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSxcbiAgICAgICAgcGFyYW1zOiB7IGNhY2hlVGltZTogcmVxdWVzdC5jYWNoZVRpbWUgfSxcbiAgICAgIH0pXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlLCAyMDApXG4gICAgICAgICAgKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKVxuICAgICAgICAgICk7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBHRVQgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3Bvc3QodXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwXG4gICAgICAucG9zdDxJQmFja1Jlc3BvbnNlPih1cmwsIHJlcXVlc3QuQnJ1dENvbnRlbnQsIHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5faGVhZGVycygpLFxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAocmVzcG9uc2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlKSksXG4gICAgICAgIGVycm9yOiAobWVzc2FnZSkgPT5cbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKFxuICAgICAgICAgICAgcmVxdWVzdC5pZCxcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpXG4gICAgICAgICAgKSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZygnQVBJIFBPU1QgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3BhdGNoKHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cFxuICAgICAgLnBhdGNoPElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5Db250ZW50LCB7IGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChyZXNwb25zZSkgPT5cbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKSxcbiAgICAgICAgZXJyb3I6IChtZXNzYWdlKSA9PlxuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQoXG4gICAgICAgICAgICByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cylcbiAgICAgICAgICApLFxuICAgICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgUEFUQ0ggQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3B1dCh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wdXQ8SUJhY2tSZXNwb25zZT4odXJsLCByZXF1ZXN0LkNvbnRlbnQsIHsgaGVhZGVyczogdGhpcy5faGVhZGVycygpIH0pXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKHJlc3BvbnNlKSA9PlxuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpLFxuICAgICAgICBlcnJvcjogKG1lc3NhZ2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKVxuICAgICAgICAgICksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBQVVQgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX2RlbGV0ZSh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5kZWxldGU8SUJhY2tSZXNwb25zZT4odXJsLCB7IGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChyZXNwb25zZSkgPT5cbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKSxcbiAgICAgICAgZXJyb3I6IChtZXNzYWdlKSA9PlxuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQoXG4gICAgICAgICAgICByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cylcbiAgICAgICAgICApLFxuICAgICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgREVMRVRFIENMT1NFJyksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9maWxlcyh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wb3N0PElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5CcnV0Q29udGVudC5maWxlcywge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKHtcbiAgICAgICAgICBjb250ZW50VHlwZTogJycsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IChtZXNzYWdlKSA9PlxuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQoXG4gICAgICAgICAgICByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cylcbiAgICAgICAgICApLFxuICAgICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgREVMRVRFIENMT1NFJyksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF91cGRhdGVGaWxlcyh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wdXQ8SUJhY2tSZXNwb25zZT4odXJsLCByZXF1ZXN0LkJydXRDb250ZW50LmZpbGVzLCB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoe1xuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnJyxcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKG1lc3NhZ2UpID0+XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChcbiAgICAgICAgICAgIHJlcXVlc3QuaWQsXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKVxuICAgICAgICAgICksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBERUxFVEUgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2U6IG9iamVjdCwgc3RhdHVzOiBudW1iZXIgPSAyMDApOiBJUmVzcG9uc2Uge1xuICAgIHJldHVybiB7IGJvZHk6IHsgU3RhdHVzOiBzdGF0dXMsIENvbnRlbnQ6IHJlc3BvbnNlIH0gfTtcbiAgfVxuICBwcml2YXRlIF9oZWFkZXJzKG9wdGlvbj86IHsgY29udGVudFR5cGU/OiBzdHJpbmcgfSk6IEh0dHBIZWFkZXJzIHtcbiAgICBsZXQgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuXG4gICAgaWYgKG9wdGlvbj8uY29udGVudFR5cGUgIT09ICcnKSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoXG4gICAgICAgICdDb250ZW50LVR5cGUnLFxuICAgICAgICBvcHRpb24/LmNvbnRlbnRUeXBlID8gb3B0aW9uPy5jb250ZW50VHlwZSA6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyxcbiAgICAgIHRoaXMuX2NvbmZpZz8uc2VydmVyVXJsID8/ICcnXG4gICAgKTtcblxuICAgIExvZ2dlci5Mb2dJbmZvKCdbU0VSVkVSXSBBcGkgUmVxdWVzdCBIZWFkZXI6JywgaGVhZGVycyk7XG5cbiAgICByZXR1cm4gaGVhZGVycztcbiAgfVxufVxuIl19