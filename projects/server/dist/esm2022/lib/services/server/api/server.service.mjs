import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { Subject } from 'rxjs';
import { Logger } from '../../logger';
import { StatusReponse } from '../response';
import { RequestMap } from './requestMap';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export const SERVER_CONFIG_KEY = new InjectionToken('config_server');
export class TaServerSevice {
    get requestInProgressNumber() {
        return this._correlations.length;
    }
    get isAuthenticated() {
        return this._isAuthenticated;
    }
    set isAuthenticated(value) {
        this._isAuthenticated = value;
        if (this._isAuthenticated) {
            this._retryLoginRequired();
        }
    }
    constructor($http, _config) {
        this.$http = $http;
        this._config = _config;
        this._tempLoginRequiredRequest = [];
        this._tempPendingRequest = [];
        this._correlations = [];
        this._isAuthenticated = false;
        this._onPacketReceived = (id, response) => {
            Logger.LogInfo('[SERVER] Api Reponse:', response);
            this._resolveCorrelation(id, response.body);
        };
        this._resolveCorrelation = (corrId, body) => {
            const correlation = this._correlations.find(item => item.id === corrId);
            if (!correlation) {
                return;
            }
            let content;
            if (typeof body === 'string') {
                try {
                    content = JSON.parse(body);
                }
                catch (error) {
                    content = body;
                }
            }
            else {
                content = body;
            }
            this._resolveResponseStatus(correlation, content);
            this._correlations = this._correlations.filter(item => item !== correlation);
            if (this.requestInProgressNumber === 0) {
                this._retryPending();
            }
        };
    }
    registerRoutes(routes) {
        RequestMap.register(routes);
    }
    request(request) {
        const subject = new Subject();
        this._send(subject, request);
        return subject;
    }
    retryRequest(list = []) {
        for (const request of list) {
            this._send(request.subject, request.request);
        }
    }
    _send(subject, request) {
        if (!this._config) {
            return;
        }
        // le user doit etre connecté
        if (request.loginRequired === true && this.isAuthenticated === false) {
            this._tempLoginRequiredRequest.push({
                request: request,
                subject: subject,
            });
            return;
        }
        if (this.requestInProgressNumber >= this._config.pendindRequestId) {
            this._tempPendingRequest.push({ request: request, subject: subject });
            return;
        }
        this._addCorrelation(request.id, request, subject);
        this._sendRequest(request);
    }
    _sendRequest(request) {
        if (!this._config) {
            return;
        }
        const requestConfig = RequestMap.getConfigById(request.type);
        if (!requestConfig) {
            return;
        }
        const url = RequestMap.parseUrl({
            serverUrl: this._config.serverUrl,
            url: requestConfig.url,
            request,
            apiExt: this._config.apiExt,
        });
        Logger.LogInfo('[SERVER] Api Request:', url, request);
        switch (requestConfig.type) {
            case 'GET':
                this._get(url, request);
                break;
            case 'POST':
                this._post(url, request);
                break;
            case 'PUT':
                this._put(url, request);
                break;
            case 'PATCH':
                this._patch(url, request);
                break;
            case 'DELETE':
                this._delete(url, request);
                break;
            case 'FILES':
                this._files(url, request);
                break;
            case 'UPDATEFILES':
                this._updateFiles(url, request);
                break;
            default:
                Logger.LogError('[ERROR] Request not send');
        }
    }
    _addCorrelation(corrId, request, sub) {
        this._correlations.push({ id: corrId, request: request, subject: sub });
    }
    _resolveResponseStatus(correlation, content) {
        Logger.LogInfo('[SERVER] Api Reponse content:', content.Status, content.Content);
        switch (content.Status) {
            case StatusReponse.Successful:
            case StatusReponse.NoContent:
                correlation.subject.next(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
                break;
            default:
                correlation.subject.error(content.Content);
                correlation.subject.complete();
                correlation.subject.unsubscribe();
        }
    }
    _retryPending() {
        const list = [...this._tempPendingRequest];
        this._tempPendingRequest = [];
        this.retryRequest(list);
    }
    _retryLoginRequired() {
        const list = [...this._tempLoginRequiredRequest];
        this._tempLoginRequiredRequest = [];
        this.retryRequest(list);
    }
    _get(url, request) {
        this.$http
            .get(url, {
            headers: this._headers(),
            params: { cacheTime: request.cacheTime },
        })
            .subscribe({
            next: response => {
                this._onPacketReceived(request.id, this._formatReponse(response, 200));
            },
            error: message => {
                this._onPacketReceived(request.id, this._formatReponse(message, message.status));
            },
            complete: () => Logger.LogDebug('API GET CLOSE'),
        });
    }
    _post(url, request) {
        this.$http
            .post(url, request.BrutContent, {
            headers: this._headers(),
        })
            .subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API POST CLOSE'),
        });
    }
    _patch(url, request) {
        this.$http.patch(url, request.Content, { headers: this._headers() }).subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API PATCH CLOSE'),
        });
    }
    _put(url, request) {
        this.$http.put(url, request.Content, { headers: this._headers() }).subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API PUT CLOSE'),
        });
    }
    _delete(url, request) {
        this.$http.delete(url, { headers: this._headers() }).subscribe({
            next: response => this._onPacketReceived(request.id, this._formatReponse(response)),
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _files(url, request) {
        this.$http
            .post(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: '',
            }),
        })
            .subscribe({
            next: response => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _updateFiles(url, request) {
        this.$http
            .put(url, request.BrutContent.files, {
            headers: this._headers({
                contentType: '',
            }),
        })
            .subscribe({
            next: response => {
                this._onPacketReceived(request.id, this._formatReponse(response));
            },
            error: message => this._onPacketReceived(request.id, this._formatReponse(message, message.status)),
            complete: () => Logger.LogDebug('API DELETE CLOSE'),
        });
    }
    _formatReponse(response, status = 200) {
        return { body: { Status: status, Content: response } };
    }
    _headers(option) {
        let headers = new HttpHeaders();
        if (option?.contentType !== '') {
            headers = headers.set('Content-Type', option?.contentType ? option?.contentType : 'application/json');
        }
        headers = headers.set('Access-Control-Allow-Origin', this._config?.serverUrl ?? '');
        Logger.LogInfo('[SERVER] Api Request Header:', headers);
        return headers;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaServerSevice, deps: [{ token: HttpClient }, { token: SERVER_CONFIG_KEY, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaServerSevice, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: TaServerSevice, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient, decorators: [{
                    type: Inject,
                    args: [HttpClient]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [SERVER_CONFIG_KEY]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL3NlcnZlci9hcGkvc2VydmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUd0QyxPQUFPLEVBQTJDLGFBQWEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyRixPQUFPLEVBQWtCLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQzs7O0FBRTFELE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLElBQUksY0FBYyxDQUFnQixlQUFlLENBQUMsQ0FBQztBQVNwRixNQUFNLE9BQU8sY0FBYztJQUN6QixJQUFJLHVCQUF1QjtRQUN6QixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDO0lBQ25DLENBQUM7SUFRRCxJQUFJLGVBQWU7UUFDakIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7SUFDL0IsQ0FBQztJQUNELElBQUksZUFBZSxDQUFDLEtBQWM7UUFDaEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUM5QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzdCLENBQUM7SUFDSCxDQUFDO0lBRUQsWUFDNkIsS0FBaUIsRUFDRyxPQUF1QjtRQUQzQyxVQUFLLEdBQUwsS0FBSyxDQUFZO1FBQ0csWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFs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QixDQUFDLENBQUM7UUFDeEcsQ0FBQztRQUVELE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXBGLE1BQU0sQ0FBQyxPQUFPLENBQUMsOEJBQThCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFeEQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQzsrR0FsUVUsY0FBYyxrQkFzQmYsVUFBVSxhQUNFLGlCQUFpQjttSEF2QjVCLGNBQWMsY0FGYixNQUFNOzs0RkFFUCxjQUFjO2tCQUgxQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBdUJJLE1BQU07MkJBQUMsVUFBVTs7MEJBQ2pCLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uLy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBDb3JyZWxhdGlvbiwgVGVtcFJlcXVlc3QgfSBmcm9tICcuLi9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJy4uL3JlcXVlc3QnO1xuaW1wb3J0IHsgSUJhY2tSZXNwb25zZSwgSUJhc2VSZXNwb25zZSwgSVJlc3BvbnNlLCBTdGF0dXNSZXBvbnNlIH0gZnJvbSAnLi4vcmVzcG9uc2UnO1xuaW1wb3J0IHsgTWFwcGluZ0FwaVR5cGUsIFJlcXVlc3RNYXAgfSBmcm9tICcuL3JlcXVlc3RNYXAnO1xuXG5leHBvcnQgY29uc3QgU0VSVkVSX0NPTkZJR19LRVkgPSBuZXcgSW5qZWN0aW9uVG9rZW48SVNlcnZlckNvbmZpZz4oJ2NvbmZpZ19zZXJ2ZXInKTtcbmV4cG9ydCBpbnRlcmZhY2UgSVNlcnZlckNvbmZpZyB7XG4gIHBlbmRpbmRSZXF1ZXN0SWQ6IG51bWJlcjtcbiAgc2VydmVyVXJsOiBzdHJpbmc7XG4gIGFwaUV4dD86IHN0cmluZztcbn1cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBUYVNlcnZlclNldmljZSB7XG4gIGdldCByZXF1ZXN0SW5Qcm9ncmVzc051bWJlcigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9jb3JyZWxhdGlvbnMubGVuZ3RoO1xuICB9XG5cbiAgcHJpdmF0ZSBfdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0OiBUZW1wUmVxdWVzdFtdID0gW107XG4gIHByaXZhdGUgX3RlbXBQZW5kaW5nUmVxdWVzdDogVGVtcFJlcXVlc3RbXSA9IFtdO1xuXG4gIHByaXZhdGUgX2NvcnJlbGF0aW9uczogQ29ycmVsYXRpb25bXSA9IFtdO1xuXG4gIHByaXZhdGUgX2lzQXV0aGVudGljYXRlZCA9IGZhbHNlO1xuICBnZXQgaXNBdXRoZW50aWNhdGVkKCkge1xuICAgIHJldHVybiB0aGlzLl9pc0F1dGhlbnRpY2F0ZWQ7XG4gIH1cbiAgc2V0IGlzQXV0aGVudGljYXRlZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2lzQXV0aGVudGljYXRlZCA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl9pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgIHRoaXMuX3JldHJ5TG9naW5SZXF1aXJlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoSHR0cENsaWVudCkgcHVibGljICRodHRwOiBIdHRwQ2xpZW50LFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoU0VSVkVSX0NPTkZJR19LRVkpIHByaXZhdGUgX2NvbmZpZz86IElTZXJ2ZXJDb25maWdcbiAgKSB7fVxuXG4gIHB1YmxpYyByZWdpc3RlclJvdXRlcyhyb3V0ZXM6IE1hcHBpbmdBcGlUeXBlKSB7XG4gICAgUmVxdWVzdE1hcC5yZWdpc3Rlcihyb3V0ZXMpO1xuICB9XG5cbiAgcHVibGljIHJlcXVlc3Q8VD4ocmVxdWVzdDogUmVxdWVzdCk6IFN1YmplY3Q8VD4ge1xuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdDxPYmplY3Q+KCk7XG4gICAgdGhpcy5fc2VuZChzdWJqZWN0LCByZXF1ZXN0KTtcbiAgICByZXR1cm4gc3ViamVjdCBhcyB1bmtub3duIGFzIFN1YmplY3Q8VD47XG4gIH1cbiAgcHVibGljIHJldHJ5UmVxdWVzdChsaXN0OiBUZW1wUmVxdWVzdFtdID0gW10pIHtcbiAgICBmb3IgKGNvbnN0IHJlcXVlc3Qgb2YgbGlzdCkge1xuICAgICAgdGhpcy5fc2VuZChyZXF1ZXN0LnN1YmplY3QsIHJlcXVlc3QucmVxdWVzdCk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgX3NlbmQoc3ViamVjdDogU3ViamVjdDxPYmplY3Q+LCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgaWYgKCF0aGlzLl9jb25maWcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gbGUgdXNlciBkb2l0IGV0cmUgY29ubmVjdMOpXG4gICAgaWYgKHJlcXVlc3QubG9naW5SZXF1aXJlZCA9PT0gdHJ1ZSAmJiB0aGlzLmlzQXV0aGVudGljYXRlZCA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuX3RlbXBMb2dpblJlcXVpcmVkUmVxdWVzdC5wdXNoKHtcbiAgICAgICAgcmVxdWVzdDogcmVxdWVzdCxcbiAgICAgICAgc3ViamVjdDogc3ViamVjdCxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlcXVlc3RJblByb2dyZXNzTnVtYmVyID49IHRoaXMuX2NvbmZpZy5wZW5kaW5kUmVxdWVzdElkKSB7XG4gICAgICB0aGlzLl90ZW1wUGVuZGluZ1JlcXVlc3QucHVzaCh7IHJlcXVlc3Q6IHJlcXVlc3QsIHN1YmplY3Q6IHN1YmplY3QgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fYWRkQ29ycmVsYXRpb24ocmVxdWVzdC5pZCwgcmVxdWVzdCwgc3ViamVjdCk7XG5cbiAgICB0aGlzLl9zZW5kUmVxdWVzdChyZXF1ZXN0KTtcbiAgfVxuICBwcml2YXRlIF9zZW5kUmVxdWVzdChyZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgaWYgKCF0aGlzLl9jb25maWcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgcmVxdWVzdENvbmZpZyA9IFJlcXVlc3RNYXAuZ2V0Q29uZmlnQnlJZChyZXF1ZXN0LnR5cGUpO1xuICAgIGlmICghcmVxdWVzdENvbmZpZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB1cmwgPSBSZXF1ZXN0TWFwLnBhcnNlVXJsKHtcbiAgICAgIHNlcnZlclVybDogdGhpcy5fY29uZmlnLnNlcnZlclVybCxcbiAgICAgIHVybDogcmVxdWVzdENvbmZpZy51cmwsXG4gICAgICByZXF1ZXN0LFxuICAgICAgYXBpRXh0OiB0aGlzLl9jb25maWcuYXBpRXh0LFxuICAgIH0pO1xuICAgIExvZ2dlci5Mb2dJbmZvKCdbU0VSVkVSXSBBcGkgUmVxdWVzdDonLCB1cmwsIHJlcXVlc3QpO1xuXG4gICAgc3dpdGNoIChyZXF1ZXN0Q29uZmlnLnR5cGUpIHtcbiAgICAgIGNhc2UgJ0dFVCc6XG4gICAgICAgIHRoaXMuX2dldCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BPU1QnOlxuICAgICAgICB0aGlzLl9wb3N0KHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUFVUJzpcbiAgICAgICAgdGhpcy5fcHV0KHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUEFUQ0gnOlxuICAgICAgICB0aGlzLl9wYXRjaCh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0RFTEVURSc6XG4gICAgICAgIHRoaXMuX2RlbGV0ZSh1cmwsIHJlcXVlc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0ZJTEVTJzpcbiAgICAgICAgdGhpcy5fZmlsZXModXJsLCByZXF1ZXN0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdVUERBVEVGSUxFUyc6XG4gICAgICAgIHRoaXMuX3VwZGF0ZUZpbGVzKHVybCwgcmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgTG9nZ2VyLkxvZ0Vycm9yKCdbRVJST1JdIFJlcXVlc3Qgbm90IHNlbmQnKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBfb25QYWNrZXRSZWNlaXZlZCA9IChpZDogbnVtYmVyLCByZXNwb25zZTogSVJlc3BvbnNlKTogdm9pZCA9PiB7XG4gICAgTG9nZ2VyLkxvZ0luZm8oJ1tTRVJWRVJdIEFwaSBSZXBvbnNlOicsIHJlc3BvbnNlKTtcblxuICAgIHRoaXMuX3Jlc29sdmVDb3JyZWxhdGlvbihpZCwgcmVzcG9uc2UuYm9keSk7XG4gIH07XG4gIHByaXZhdGUgX2FkZENvcnJlbGF0aW9uKGNvcnJJZDogbnVtYmVyLCByZXF1ZXN0OiBSZXF1ZXN0LCBzdWI6IFN1YmplY3Q8T2JqZWN0Pikge1xuICAgIHRoaXMuX2NvcnJlbGF0aW9ucy5wdXNoKHsgaWQ6IGNvcnJJZCwgcmVxdWVzdDogcmVxdWVzdCwgc3ViamVjdDogc3ViIH0pO1xuICB9XG4gIHByaXZhdGUgX3Jlc29sdmVDb3JyZWxhdGlvbiA9IChjb3JySWQ6IG51bWJlciwgYm9keTogc3RyaW5nIHwgT2JqZWN0KSA9PiB7XG4gICAgY29uc3QgY29ycmVsYXRpb24gPSB0aGlzLl9jb3JyZWxhdGlvbnMuZmluZChpdGVtID0+IGl0ZW0uaWQgPT09IGNvcnJJZCk7XG5cbiAgICBpZiAoIWNvcnJlbGF0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBjb250ZW50O1xuICAgIGlmICh0eXBlb2YgYm9keSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnRlbnQgPSBKU09OLnBhcnNlKDxzdHJpbmc+Ym9keSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb250ZW50ID0gYm9keTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29udGVudCA9IGJvZHk7XG4gICAgfVxuICAgIHRoaXMuX3Jlc29sdmVSZXNwb25zZVN0YXR1cyhjb3JyZWxhdGlvbiwgY29udGVudCk7XG5cbiAgICB0aGlzLl9jb3JyZWxhdGlvbnMgPSB0aGlzLl9jb3JyZWxhdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbSAhPT0gY29ycmVsYXRpb24pO1xuICAgIGlmICh0aGlzLnJlcXVlc3RJblByb2dyZXNzTnVtYmVyID09PSAwKSB7XG4gICAgICB0aGlzLl9yZXRyeVBlbmRpbmcoKTtcbiAgICB9XG4gIH07XG4gIHByaXZhdGUgX3Jlc29sdmVSZXNwb25zZVN0YXR1cyhjb3JyZWxhdGlvbjogQ29ycmVsYXRpb24sIGNvbnRlbnQ6IElCYXNlUmVzcG9uc2UpIHtcbiAgICBMb2dnZXIuTG9nSW5mbygnW1NFUlZFUl0gQXBpIFJlcG9uc2UgY29udGVudDonLCBjb250ZW50LlN0YXR1cywgY29udGVudC5Db250ZW50KTtcbiAgICBzd2l0Y2ggKGNvbnRlbnQuU3RhdHVzKSB7XG4gICAgICBjYXNlIFN0YXR1c1JlcG9uc2UuU3VjY2Vzc2Z1bDpcbiAgICAgIGNhc2UgU3RhdHVzUmVwb25zZS5Ob0NvbnRlbnQ6XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QubmV4dChjb250ZW50LkNvbnRlbnQpO1xuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb3JyZWxhdGlvbi5zdWJqZWN0LmVycm9yKGNvbnRlbnQuQ29udGVudCk7XG4gICAgICAgIGNvcnJlbGF0aW9uLnN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgICAgY29ycmVsYXRpb24uc3ViamVjdC51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3JldHJ5UGVuZGluZygpIHtcbiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMuX3RlbXBQZW5kaW5nUmVxdWVzdF07XG4gICAgdGhpcy5fdGVtcFBlbmRpbmdSZXF1ZXN0ID0gW107XG5cbiAgICB0aGlzLnJldHJ5UmVxdWVzdChsaXN0KTtcbiAgfVxuXG4gIHByaXZhdGUgX3JldHJ5TG9naW5SZXF1aXJlZCgpIHtcbiAgICBjb25zdCBsaXN0ID0gWy4uLnRoaXMuX3RlbXBMb2dpblJlcXVpcmVkUmVxdWVzdF07XG4gICAgdGhpcy5fdGVtcExvZ2luUmVxdWlyZWRSZXF1ZXN0ID0gW107XG5cbiAgICB0aGlzLnJldHJ5UmVxdWVzdChsaXN0KTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldCh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5nZXQ8SUJhY2tSZXNwb25zZT4odXJsLCB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSxcbiAgICAgICAgcGFyYW1zOiB7IGNhY2hlVGltZTogcmVxdWVzdC5jYWNoZVRpbWUgfSxcbiAgICAgIH0pXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogcmVzcG9uc2UgPT4ge1xuICAgICAgICAgIHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSwgMjAwKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBtZXNzYWdlID0+IHtcbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpKTtcbiAgICAgICAgfSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZygnQVBJIEdFVCBDTE9TRScpLFxuICAgICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfcG9zdCh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wb3N0PElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5CcnV0Q29udGVudCwge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCksXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpLFxuICAgICAgICBlcnJvcjogbWVzc2FnZSA9PiB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpKSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IExvZ2dlci5Mb2dEZWJ1ZygnQVBJIFBPU1QgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3BhdGNoKHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cC5wYXRjaDxJQmFja1Jlc3BvbnNlPih1cmwsIHJlcXVlc3QuQ29udGVudCwgeyBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCkgfSkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpLFxuICAgICAgZXJyb3I6IG1lc3NhZ2UgPT4gdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKSksXG4gICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgUEFUQ0ggQ0xPU0UnKSxcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9wdXQodXJsOiBzdHJpbmcsIHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiRodHRwLnB1dDxJQmFja1Jlc3BvbnNlPih1cmwsIHJlcXVlc3QuQ29udGVudCwgeyBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKCkgfSkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShyZXNwb25zZSkpLFxuICAgICAgZXJyb3I6IG1lc3NhZ2UgPT4gdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKSksXG4gICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgUFVUIENMT1NFJyksXG4gICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfZGVsZXRlKHVybDogc3RyaW5nLCByZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gICAgdGhpcy4kaHR0cC5kZWxldGU8SUJhY2tSZXNwb25zZT4odXJsLCB7IGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSB9KS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogcmVzcG9uc2UgPT4gdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlKSksXG4gICAgICBlcnJvcjogbWVzc2FnZSA9PiB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UobWVzc2FnZSwgbWVzc2FnZS5zdGF0dXMpKSxcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBERUxFVEUgQ0xPU0UnKSxcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIF9maWxlcyh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wb3N0PElCYWNrUmVzcG9uc2U+KHVybCwgcmVxdWVzdC5CcnV0Q29udGVudC5maWxlcywge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzKHtcbiAgICAgICAgICBjb250ZW50VHlwZTogJycsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiByZXNwb25zZSA9PiB7XG4gICAgICAgICAgdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKHJlc3BvbnNlKSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBtZXNzYWdlID0+IHRoaXMuX29uUGFja2V0UmVjZWl2ZWQocmVxdWVzdC5pZCwgdGhpcy5fZm9ybWF0UmVwb25zZShtZXNzYWdlLCBtZXNzYWdlLnN0YXR1cykpLFxuICAgICAgICBjb21wbGV0ZTogKCkgPT4gTG9nZ2VyLkxvZ0RlYnVnKCdBUEkgREVMRVRFIENMT1NFJyksXG4gICAgICB9KTtcbiAgfVxuICBwcml2YXRlIF91cGRhdGVGaWxlcyh1cmw6IHN0cmluZywgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXMuJGh0dHBcbiAgICAgIC5wdXQ8SUJhY2tSZXNwb25zZT4odXJsLCByZXF1ZXN0LkJydXRDb250ZW50LmZpbGVzLCB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoe1xuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnJyxcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHtcbiAgICAgICAgICB0aGlzLl9vblBhY2tldFJlY2VpdmVkKHJlcXVlc3QuaWQsIHRoaXMuX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2UpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IG1lc3NhZ2UgPT4gdGhpcy5fb25QYWNrZXRSZWNlaXZlZChyZXF1ZXN0LmlkLCB0aGlzLl9mb3JtYXRSZXBvbnNlKG1lc3NhZ2UsIG1lc3NhZ2Uuc3RhdHVzKSksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBMb2dnZXIuTG9nRGVidWcoJ0FQSSBERUxFVEUgQ0xPU0UnKSxcbiAgICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX2Zvcm1hdFJlcG9uc2UocmVzcG9uc2U6IG9iamVjdCwgc3RhdHVzOiBudW1iZXIgPSAyMDApOiBJUmVzcG9uc2Uge1xuICAgIHJldHVybiB7IGJvZHk6IHsgU3RhdHVzOiBzdGF0dXMsIENvbnRlbnQ6IHJlc3BvbnNlIH0gfTtcbiAgfVxuICBwcml2YXRlIF9oZWFkZXJzKG9wdGlvbj86IHsgY29udGVudFR5cGU/OiBzdHJpbmcgfSk6IEh0dHBIZWFkZXJzIHtcbiAgICBsZXQgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuXG4gICAgaWYgKG9wdGlvbj8uY29udGVudFR5cGUgIT09ICcnKSB7XG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsIG9wdGlvbj8uY29udGVudFR5cGUgPyBvcHRpb24/LmNvbnRlbnRUeXBlIDogJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICB9XG5cbiAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsIHRoaXMuX2NvbmZpZz8uc2VydmVyVXJsID8/ICcnKTtcblxuICAgIExvZ2dlci5Mb2dJbmZvKCdbU0VSVkVSXSBBcGkgUmVxdWVzdCBIZWFkZXI6JywgaGVhZGVycyk7XG5cbiAgICByZXR1cm4gaGVhZGVycztcbiAgfVxufVxuIl19