import { HttpClient } from '@angular/common/http';
import { inject } from '@angular/core';
import { map } from 'rxjs';
import { TaBaseStrapiService } from '@ta/server';
import { GET_TRANSLATIONS } from './queries';
import { TaTranslationRegistryService } from './translation-registry.service';
import { TRANSLATION_SOURCE_CONFIG, TranslationSourceType } from './translation-source.config';
export class TaLazyTranslationService extends TaBaseStrapiService {
    get id() {
        return this._id;
    }
    constructor(id, isApp = false) {
        super();
        this._registry = inject(TaTranslationRegistryService);
        this._sourceConfig = inject(TRANSLATION_SOURCE_CONFIG);
        this._http = inject(HttpClient);
        this._id = '';
        this._isApp = false;
        this._id = id;
        this._isApp = isApp;
        this._registry.register(this);
    }
    static getInstance() {
        return inject(this);
    }
    getTranslation(lang) {
        const source$ = this._sourceConfig.type === TranslationSourceType.FILE
            ? this._getTranslationsFromFile(lang)
            : this._getTranslationsFromGraphQL(lang);
        return source$.pipe(map((translations) => translations.reduce((acc, translation) => {
            acc[(this._isApp ? '' : this._id + '.') + translation.key.trim()] = translation.value;
            return acc;
        }, {})), map((translations) => Object.entries(translations).reduce((acc, [key, value]) => {
            const keys = key.split('.');
            keys.reduce((current, k, index) => {
                if (index === keys.length - 1) {
                    current[k] = value;
                }
                else {
                    current[k] = current[k] || {};
                }
                return current[k];
            }, acc);
            return acc;
        }, {})));
    }
    _getTranslationsFromFile(lang) {
        return this._http.get(`${this._sourceConfig.filePath}${this._id}/${lang}.json`);
    }
    _getTranslationsFromGraphQL(lang) {
        return this._strapiService.fetchQueryList$(GET_TRANSLATIONS(lang, this._id), 'translations');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS10cmFuc2xhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zZXJ2aWNlcy9sYXp5LXRyYW5zbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdkMsT0FBTyxFQUFjLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV2QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFHakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzdDLE9BQU8sRUFBZ0IsNEJBQTRCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM1RixPQUFPLEVBQUUseUJBQXlCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUvRixNQUFNLE9BQWdCLHdCQUF5QixTQUFRLG1CQUFtQjtJQUN4RSxJQUFJLEVBQUU7UUFDSixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDbEIsQ0FBQztJQVFELFlBQVksRUFBVSxFQUFFLEtBQUssR0FBRyxLQUFLO1FBQ25DLEtBQUssRUFBRSxDQUFDO1FBUk8sY0FBUyxHQUFHLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBQ2pELGtCQUFhLEdBQUcsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDbEQsVUFBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVwQyxRQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ1QsV0FBTSxHQUFHLEtBQUssQ0FBQztRQUtyQixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVztRQUNoQixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRU0sY0FBYyxDQUFDLElBQVk7UUFDaEMsTUFBTSxPQUFPLEdBQ1gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEtBQUsscUJBQXFCLENBQUMsSUFBSTtZQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQztZQUNyQyxDQUFDLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTdDLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FDakIsR0FBRyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FDbkIsWUFBWSxDQUFDLE1BQU0sQ0FBOEIsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUU7WUFDcEUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDO1lBQ3RGLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUNQLEVBQ0QsR0FBRyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FDbkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUN4RCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxNQUFNLENBQTJCLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDMUQsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDOUIsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztnQkFDckIsQ0FBQztxQkFBTSxDQUFDO29CQUNOLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNoQyxDQUFDO2dCQUNELE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUVSLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUNQLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxJQUFZO1FBQzNDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDO0lBQ2pHLENBQUM7SUFFTywyQkFBMkIsQ0FBQyxJQUFZO1FBQzlDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLENBQWMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUM1RyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBpbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG1hcCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgVGFCYXNlU3RyYXBpU2VydmljZSB9IGZyb20gJ0B0YS9zZXJ2ZXInO1xyXG5cclxuaW1wb3J0IHsgVHJhbnNsYXRpb24gfSBmcm9tICcuL2R0by90cmFuc2xhdGlvbic7XHJcbmltcG9ydCB7IEdFVF9UUkFOU0xBVElPTlMgfSBmcm9tICcuL3F1ZXJpZXMnO1xyXG5pbXBvcnQgeyBJVHJhbnNsYXRpb24sIFRhVHJhbnNsYXRpb25SZWdpc3RyeVNlcnZpY2UgfSBmcm9tICcuL3RyYW5zbGF0aW9uLXJlZ2lzdHJ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBUUkFOU0xBVElPTl9TT1VSQ0VfQ09ORklHLCBUcmFuc2xhdGlvblNvdXJjZVR5cGUgfSBmcm9tICcuL3RyYW5zbGF0aW9uLXNvdXJjZS5jb25maWcnO1xyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFRhTGF6eVRyYW5zbGF0aW9uU2VydmljZSBleHRlbmRzIFRhQmFzZVN0cmFwaVNlcnZpY2UgaW1wbGVtZW50cyBJVHJhbnNsYXRpb24ge1xyXG4gIGdldCBpZCgpIHtcclxuICAgIHJldHVybiB0aGlzLl9pZDtcclxuICB9XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfcmVnaXN0cnkgPSBpbmplY3QoVGFUcmFuc2xhdGlvblJlZ2lzdHJ5U2VydmljZSk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfc291cmNlQ29uZmlnID0gaW5qZWN0KFRSQU5TTEFUSU9OX1NPVVJDRV9DT05GSUcpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2h0dHAgPSBpbmplY3QoSHR0cENsaWVudCk7XHJcblxyXG4gIHByaXZhdGUgX2lkID0gJyc7XHJcbiAgcHJpdmF0ZSBfaXNBcHAgPSBmYWxzZTtcclxuXHJcbiAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgaXNBcHAgPSBmYWxzZSkge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLl9pZCA9IGlkO1xyXG4gICAgdGhpcy5faXNBcHAgPSBpc0FwcDtcclxuICAgIHRoaXMuX3JlZ2lzdHJ5LnJlZ2lzdGVyKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldEluc3RhbmNlKCkge1xyXG4gICAgcmV0dXJuIGluamVjdCh0aGlzKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRUcmFuc2xhdGlvbihsYW5nOiBzdHJpbmcpOiBPYnNlcnZhYmxlPG9iamVjdCB8IG51bGw+IHtcclxuICAgIGNvbnN0IHNvdXJjZSQgPVxyXG4gICAgICB0aGlzLl9zb3VyY2VDb25maWcudHlwZSA9PT0gVHJhbnNsYXRpb25Tb3VyY2VUeXBlLkZJTEVcclxuICAgICAgICA/IHRoaXMuX2dldFRyYW5zbGF0aW9uc0Zyb21GaWxlKGxhbmcpXHJcbiAgICAgICAgOiB0aGlzLl9nZXRUcmFuc2xhdGlvbnNGcm9tR3JhcGhRTChsYW5nKTtcclxuXHJcbiAgICByZXR1cm4gc291cmNlJC5waXBlKFxyXG4gICAgICBtYXAoKHRyYW5zbGF0aW9ucykgPT5cclxuICAgICAgICB0cmFuc2xhdGlvbnMucmVkdWNlPHsgW2luZGV4OiBzdHJpbmddOiBzdHJpbmcgfT4oKGFjYywgdHJhbnNsYXRpb24pID0+IHtcclxuICAgICAgICAgIGFjY1sodGhpcy5faXNBcHAgPyAnJyA6IHRoaXMuX2lkICsgJy4nKSArIHRyYW5zbGF0aW9uLmtleS50cmltKCldID0gdHJhbnNsYXRpb24udmFsdWU7XHJcbiAgICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICAgIH0sIHt9KSxcclxuICAgICAgKSxcclxuICAgICAgbWFwKCh0cmFuc2xhdGlvbnMpID0+XHJcbiAgICAgICAgT2JqZWN0LmVudHJpZXModHJhbnNsYXRpb25zKS5yZWR1Y2UoKGFjYywgW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBrZXlzID0ga2V5LnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICBrZXlzLnJlZHVjZTx7IFtpbmRleDogc3RyaW5nXTogYW55IH0+KChjdXJyZW50LCBrLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IGtleXMubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgIGN1cnJlbnRba10gPSB2YWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBjdXJyZW50W2tdID0gY3VycmVudFtrXSB8fCB7fTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gY3VycmVudFtrXTtcclxuICAgICAgICAgIH0sIGFjYyk7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICB9LCB7fSksXHJcbiAgICAgICksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZ2V0VHJhbnNsYXRpb25zRnJvbUZpbGUobGFuZzogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5faHR0cC5nZXQ8VHJhbnNsYXRpb25bXT4oYCR7dGhpcy5fc291cmNlQ29uZmlnLmZpbGVQYXRofSR7dGhpcy5faWR9LyR7bGFuZ30uanNvbmApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZ2V0VHJhbnNsYXRpb25zRnJvbUdyYXBoUUwobGFuZzogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fc3RyYXBpU2VydmljZS5mZXRjaFF1ZXJ5TGlzdCQ8VHJhbnNsYXRpb24+KEdFVF9UUkFOU0xBVElPTlMobGFuZywgdGhpcy5faWQpLCAndHJhbnNsYXRpb25zJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==