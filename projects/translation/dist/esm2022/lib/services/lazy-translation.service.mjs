import { HttpClient } from "@angular/common/http";
import { inject } from "@angular/core";
import { map } from "rxjs";
import { TaBaseStrapiService } from "@ta/server";
import { GET_TRANSLATIONS } from "./queries";
import { TaTranslationRegistryService, } from "./translation-registry.service";
import { TRANSLATION_SOURCE_CONFIG, TranslationSourceType, } from "./translation-source.config";
export class TaLazyTranslationService extends TaBaseStrapiService {
    get id() {
        return this._id;
    }
    constructor(id, isApp = false) {
        super();
        this._registry = inject(TaTranslationRegistryService);
        this._sourceConfig = inject(TRANSLATION_SOURCE_CONFIG);
        this._http = inject(HttpClient);
        this._id = "";
        this._isApp = false;
        this._id = id;
        this._isApp = isApp;
        this._registry.register(this);
    }
    static getInstance() {
        return inject(this);
    }
    getTranslation(lang) {
        const source$ = this._sourceConfig.type === TranslationSourceType.FILE
            ? this._getTranslationsFromFile(lang)
            : this._getTranslationsFromGraphQL(lang);
        return source$.pipe(map((translations) => translations.reduce((acc, translation) => {
            acc[(this._isApp ? "" : this._id + ".") + translation.key.trim()] =
                translation.value;
            return acc;
        }, {})), map((translations) => Object.entries(translations).reduce((acc, [key, value]) => {
            const keys = key.split(".");
            keys.reduce((current, k, index) => {
                if (index === keys.length - 1) {
                    current[k] = value;
                }
                else {
                    current[k] = current[k] || {};
                }
                return current[k];
            }, acc);
            return acc;
        }, {})));
    }
    _getTranslationsFromFile(lang) {
        return this._http
            .get(`${this._sourceConfig.filePath}${this._id}/${lang}.json`)
            .pipe(map((jsonData) => Object.entries(jsonData).map(([key, value]) => ({
            key,
            value,
        }))));
    }
    _getTranslationsFromGraphQL(lang) {
        return this._strapiService.fetchQueryList$(GET_TRANSLATIONS(lang, this._id), "translations");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS10cmFuc2xhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zZXJ2aWNlcy9sYXp5LXRyYW5zbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdkMsT0FBTyxFQUFjLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV2QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFHakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzdDLE9BQU8sRUFFTCw0QkFBNEIsR0FDN0IsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN4QyxPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLHFCQUFxQixHQUN0QixNQUFNLDZCQUE2QixDQUFDO0FBRXJDLE1BQU0sT0FBZ0Isd0JBQ3BCLFNBQVEsbUJBQW1CO0lBRzNCLElBQUksRUFBRTtRQUNKLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNsQixDQUFDO0lBUUQsWUFBWSxFQUFVLEVBQUUsS0FBSyxHQUFHLEtBQUs7UUFDbkMsS0FBSyxFQUFFLENBQUM7UUFSTyxjQUFTLEdBQUcsTUFBTSxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFDakQsa0JBQWEsR0FBRyxNQUFNLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNsRCxVQUFLLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXBDLFFBQUcsR0FBRyxFQUFFLENBQUM7UUFDVCxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBS3JCLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXO1FBQ2hCLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFTSxjQUFjLENBQUMsSUFBWTtRQUNoQyxNQUFNLE9BQU8sR0FDWCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksS0FBSyxxQkFBcUIsQ0FBQyxJQUFJO1lBQ3BELENBQUMsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDO1lBQ3JDLENBQUMsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFN0MsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixHQUFHLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUNuQixZQUFZLENBQUMsTUFBTSxDQUE4QixDQUFDLEdBQUcsRUFBRSxXQUFXLEVBQUUsRUFBRTtZQUNwRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDL0QsV0FBVyxDQUFDLEtBQUssQ0FBQztZQUNwQixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FDUCxFQUNELEdBQUcsQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDeEQsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM1QixJQUFJLENBQUMsTUFBTSxDQUEyQixDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQzFELElBQUksS0FBSyxLQUFLLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQzlCLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQ3JCLENBQUM7cUJBQU0sQ0FBQztvQkFDTixPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDaEMsQ0FBQztnQkFDRCxPQUFPLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFUixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FDUCxDQUNGLENBQUM7SUFDSixDQUFDO0lBRU8sd0JBQXdCLENBQUMsSUFBWTtRQUMzQyxPQUFPLElBQUksQ0FBQyxLQUFLO2FBQ2QsR0FBRyxDQUNGLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLE9BQU8sQ0FDekQ7YUFDQSxJQUFJLENBQ0gsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FDZixNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzlDLEdBQUc7WUFDSCxLQUFLO1NBQ04sQ0FBQyxDQUFDLENBQ0osQ0FDRixDQUFDO0lBQ04sQ0FBQztJQUVPLDJCQUEyQixDQUFDLElBQVk7UUFDOUMsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FDeEMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsRUFDaEMsY0FBYyxDQUNmLENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XG5pbXBvcnQgeyBpbmplY3QgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBtYXAgfSBmcm9tIFwicnhqc1wiO1xuXG5pbXBvcnQgeyBUYUJhc2VTdHJhcGlTZXJ2aWNlIH0gZnJvbSBcIkB0YS9zZXJ2ZXJcIjtcblxuaW1wb3J0IHsgVHJhbnNsYXRpb24gfSBmcm9tIFwiLi9kdG8vdHJhbnNsYXRpb25cIjtcbmltcG9ydCB7IEdFVF9UUkFOU0xBVElPTlMgfSBmcm9tIFwiLi9xdWVyaWVzXCI7XG5pbXBvcnQge1xuICBJVHJhbnNsYXRpb24sXG4gIFRhVHJhbnNsYXRpb25SZWdpc3RyeVNlcnZpY2UsXG59IGZyb20gXCIuL3RyYW5zbGF0aW9uLXJlZ2lzdHJ5LnNlcnZpY2VcIjtcbmltcG9ydCB7XG4gIFRSQU5TTEFUSU9OX1NPVVJDRV9DT05GSUcsXG4gIFRyYW5zbGF0aW9uU291cmNlVHlwZSxcbn0gZnJvbSBcIi4vdHJhbnNsYXRpb24tc291cmNlLmNvbmZpZ1wiO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGFMYXp5VHJhbnNsYXRpb25TZXJ2aWNlXG4gIGV4dGVuZHMgVGFCYXNlU3RyYXBpU2VydmljZVxuICBpbXBsZW1lbnRzIElUcmFuc2xhdGlvblxue1xuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lkO1xuICB9XG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlZ2lzdHJ5ID0gaW5qZWN0KFRhVHJhbnNsYXRpb25SZWdpc3RyeVNlcnZpY2UpO1xuICBwcml2YXRlIHJlYWRvbmx5IF9zb3VyY2VDb25maWcgPSBpbmplY3QoVFJBTlNMQVRJT05fU09VUkNFX0NPTkZJRyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2h0dHAgPSBpbmplY3QoSHR0cENsaWVudCk7XG5cbiAgcHJpdmF0ZSBfaWQgPSBcIlwiO1xuICBwcml2YXRlIF9pc0FwcCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcsIGlzQXBwID0gZmFsc2UpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5faWQgPSBpZDtcbiAgICB0aGlzLl9pc0FwcCA9IGlzQXBwO1xuICAgIHRoaXMuX3JlZ2lzdHJ5LnJlZ2lzdGVyKHRoaXMpO1xuICB9XG5cbiAgc3RhdGljIGdldEluc3RhbmNlKCkge1xuICAgIHJldHVybiBpbmplY3QodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0VHJhbnNsYXRpb24obGFuZzogc3RyaW5nKTogT2JzZXJ2YWJsZTxvYmplY3QgfCBudWxsPiB7XG4gICAgY29uc3Qgc291cmNlJCA9XG4gICAgICB0aGlzLl9zb3VyY2VDb25maWcudHlwZSA9PT0gVHJhbnNsYXRpb25Tb3VyY2VUeXBlLkZJTEVcbiAgICAgICAgPyB0aGlzLl9nZXRUcmFuc2xhdGlvbnNGcm9tRmlsZShsYW5nKVxuICAgICAgICA6IHRoaXMuX2dldFRyYW5zbGF0aW9uc0Zyb21HcmFwaFFMKGxhbmcpO1xuXG4gICAgcmV0dXJuIHNvdXJjZSQucGlwZShcbiAgICAgIG1hcCgodHJhbnNsYXRpb25zKSA9PlxuICAgICAgICB0cmFuc2xhdGlvbnMucmVkdWNlPHsgW2luZGV4OiBzdHJpbmddOiBzdHJpbmcgfT4oKGFjYywgdHJhbnNsYXRpb24pID0+IHtcbiAgICAgICAgICBhY2NbKHRoaXMuX2lzQXBwID8gXCJcIiA6IHRoaXMuX2lkICsgXCIuXCIpICsgdHJhbnNsYXRpb24ua2V5LnRyaW0oKV0gPVxuICAgICAgICAgICAgdHJhbnNsYXRpb24udmFsdWU7XG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSwge30pXG4gICAgICApLFxuICAgICAgbWFwKCh0cmFuc2xhdGlvbnMpID0+XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHRyYW5zbGF0aW9ucykucmVkdWNlKChhY2MsIFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGtleXMgPSBrZXkuc3BsaXQoXCIuXCIpO1xuICAgICAgICAgIGtleXMucmVkdWNlPHsgW2luZGV4OiBzdHJpbmddOiBhbnkgfT4oKGN1cnJlbnQsIGssIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IGtleXMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICBjdXJyZW50W2tdID0gdmFsdWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjdXJyZW50W2tdID0gY3VycmVudFtrXSB8fCB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50W2tdO1xuICAgICAgICAgIH0sIGFjYyk7XG5cbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LCB7fSlcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0VHJhbnNsYXRpb25zRnJvbUZpbGUobGFuZzogc3RyaW5nKTogT2JzZXJ2YWJsZTxUcmFuc2xhdGlvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuX2h0dHBcbiAgICAgIC5nZXQ8eyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfT4oXG4gICAgICAgIGAke3RoaXMuX3NvdXJjZUNvbmZpZy5maWxlUGF0aH0ke3RoaXMuX2lkfS8ke2xhbmd9Lmpzb25gXG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChqc29uRGF0YSkgPT5cbiAgICAgICAgICBPYmplY3QuZW50cmllcyhqc29uRGF0YSkubWFwKChba2V5LCB2YWx1ZV0pID0+ICh7XG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICB9KSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFRyYW5zbGF0aW9uc0Zyb21HcmFwaFFMKGxhbmc6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9zdHJhcGlTZXJ2aWNlLmZldGNoUXVlcnlMaXN0JDxUcmFuc2xhdGlvbj4oXG4gICAgICBHRVRfVFJBTlNMQVRJT05TKGxhbmcsIHRoaXMuX2lkKSxcbiAgICAgIFwidHJhbnNsYXRpb25zXCJcbiAgICApO1xuICB9XG59XG4iXX0=