import { HttpClient } from '@angular/common/http';
import { inject } from '@angular/core';
import { map } from 'rxjs';
import { TaBaseStrapiService } from '@ta/server';
import { GET_TRANSLATIONS } from './queries';
import { TaTranslationRegistryService } from './translation-registry.service';
import { TRANSLATION_SOURCE_CONFIG, TranslationSourceType } from './translation-source.config';
export class TaLazyTranslationService extends TaBaseStrapiService {
    get id() {
        return this._id;
    }
    constructor(id, isApp = false) {
        super();
        this._registry = inject(TaTranslationRegistryService);
        this._sourceConfig = inject(TRANSLATION_SOURCE_CONFIG);
        this._http = inject(HttpClient);
        this._id = '';
        this._isApp = false;
        this._id = id;
        this._isApp = isApp;
        this._registry.register(this);
    }
    static getInstance() {
        return inject(this);
    }
    getTranslation(lang) {
        const source$ = this._sourceConfig.type === TranslationSourceType.FILE
            ? this._getTranslationsFromFile(lang)
            : this._getTranslationsFromGraphQL(lang);
        return source$.pipe(map((translations) => translations.reduce((acc, translation) => {
            acc[(this._isApp ? '' : this._id + '.') + translation.key.trim()] = translation.value;
            return acc;
        }, {})), map((translations) => Object.entries(translations).reduce((acc, [key, value]) => {
            const keys = key.split('.');
            keys.reduce((current, k, index) => {
                if (index === keys.length - 1) {
                    current[k] = value;
                }
                else {
                    current[k] = current[k] || {};
                }
                return current[k];
            }, acc);
            return acc;
        }, {})));
    }
    _getTranslationsFromFile(lang) {
        return this._http.get(`${this._sourceConfig.filePath}${this._id}/${lang}.json`).pipe(map((jsonData) => Object.entries(jsonData).map(([key, value]) => ({
            key,
            value,
        }))));
    }
    _getTranslationsFromGraphQL(lang) {
        return this._strapiService.fetchQueryList$(GET_TRANSLATIONS(lang, this._id), 'translations');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS10cmFuc2xhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zZXJ2aWNlcy9sYXp5LXRyYW5zbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdkMsT0FBTyxFQUFjLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV2QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFHakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzdDLE9BQU8sRUFBZ0IsNEJBQTRCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM1RixPQUFPLEVBQUUseUJBQXlCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUvRixNQUFNLE9BQWdCLHdCQUF5QixTQUFRLG1CQUFtQjtJQUN4RSxJQUFJLEVBQUU7UUFDSixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDbEIsQ0FBQztJQVFELFlBQVksRUFBVSxFQUFFLEtBQUssR0FBRyxLQUFLO1FBQ25DLEtBQUssRUFBRSxDQUFDO1FBUk8sY0FBUyxHQUFHLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBQ2pELGtCQUFhLEdBQUcsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDbEQsVUFBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVwQyxRQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ1QsV0FBTSxHQUFHLEtBQUssQ0FBQztRQUtyQixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVztRQUNoQixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRU0sY0FBYyxDQUFDLElBQVk7UUFDaEMsTUFBTSxPQUFPLEdBQ1gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEtBQUsscUJBQXFCLENBQUMsSUFBSTtZQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQztZQUNyQyxDQUFDLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTdDLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FDakIsR0FBRyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FDbkIsWUFBWSxDQUFDLE1BQU0sQ0FBOEIsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUU7WUFDcEUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDO1lBQ3RGLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUNQLEVBQ0QsR0FBRyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FDbkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUN4RCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxNQUFNLENBQTJCLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDMUQsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDOUIsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztnQkFDckIsQ0FBQztxQkFBTSxDQUFDO29CQUNOLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNoQyxDQUFDO2dCQUNELE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUVSLE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUNQLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxJQUFZO1FBQzNDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQTRCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDN0csR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FDZixNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzlDLEdBQUc7WUFDSCxLQUFLO1NBQ04sQ0FBQyxDQUFDLENBQ0osQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVPLDJCQUEyQixDQUFDLElBQVk7UUFDOUMsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBYyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQzVHLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgbWFwIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBUYUJhc2VTdHJhcGlTZXJ2aWNlIH0gZnJvbSAnQHRhL3NlcnZlcic7XHJcblxyXG5pbXBvcnQgeyBUcmFuc2xhdGlvbiB9IGZyb20gJy4vZHRvL3RyYW5zbGF0aW9uJztcclxuaW1wb3J0IHsgR0VUX1RSQU5TTEFUSU9OUyB9IGZyb20gJy4vcXVlcmllcyc7XHJcbmltcG9ydCB7IElUcmFuc2xhdGlvbiwgVGFUcmFuc2xhdGlvblJlZ2lzdHJ5U2VydmljZSB9IGZyb20gJy4vdHJhbnNsYXRpb24tcmVnaXN0cnkuc2VydmljZSc7XHJcbmltcG9ydCB7IFRSQU5TTEFUSU9OX1NPVVJDRV9DT05GSUcsIFRyYW5zbGF0aW9uU291cmNlVHlwZSB9IGZyb20gJy4vdHJhbnNsYXRpb24tc291cmNlLmNvbmZpZyc7XHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGFMYXp5VHJhbnNsYXRpb25TZXJ2aWNlIGV4dGVuZHMgVGFCYXNlU3RyYXBpU2VydmljZSBpbXBsZW1lbnRzIElUcmFuc2xhdGlvbiB7XHJcbiAgZ2V0IGlkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lkO1xyXG4gIH1cclxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWdpc3RyeSA9IGluamVjdChUYVRyYW5zbGF0aW9uUmVnaXN0cnlTZXJ2aWNlKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IF9zb3VyY2VDb25maWcgPSBpbmplY3QoVFJBTlNMQVRJT05fU09VUkNFX0NPTkZJRyk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfaHR0cCA9IGluamVjdChIdHRwQ2xpZW50KTtcclxuXHJcbiAgcHJpdmF0ZSBfaWQgPSAnJztcclxuICBwcml2YXRlIF9pc0FwcCA9IGZhbHNlO1xyXG5cclxuICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nLCBpc0FwcCA9IGZhbHNlKSB7XHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIHRoaXMuX2lkID0gaWQ7XHJcbiAgICB0aGlzLl9pc0FwcCA9IGlzQXBwO1xyXG4gICAgdGhpcy5fcmVnaXN0cnkucmVnaXN0ZXIodGhpcyk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0SW5zdGFuY2UoKSB7XHJcbiAgICByZXR1cm4gaW5qZWN0KHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldFRyYW5zbGF0aW9uKGxhbmc6IHN0cmluZyk6IE9ic2VydmFibGU8b2JqZWN0IHwgbnVsbD4ge1xyXG4gICAgY29uc3Qgc291cmNlJCA9XHJcbiAgICAgIHRoaXMuX3NvdXJjZUNvbmZpZy50eXBlID09PSBUcmFuc2xhdGlvblNvdXJjZVR5cGUuRklMRVxyXG4gICAgICAgID8gdGhpcy5fZ2V0VHJhbnNsYXRpb25zRnJvbUZpbGUobGFuZylcclxuICAgICAgICA6IHRoaXMuX2dldFRyYW5zbGF0aW9uc0Zyb21HcmFwaFFMKGxhbmcpO1xyXG5cclxuICAgIHJldHVybiBzb3VyY2UkLnBpcGUoXHJcbiAgICAgIG1hcCgodHJhbnNsYXRpb25zKSA9PlxyXG4gICAgICAgIHRyYW5zbGF0aW9ucy5yZWR1Y2U8eyBbaW5kZXg6IHN0cmluZ106IHN0cmluZyB9PigoYWNjLCB0cmFuc2xhdGlvbikgPT4ge1xyXG4gICAgICAgICAgYWNjWyh0aGlzLl9pc0FwcCA/ICcnIDogdGhpcy5faWQgKyAnLicpICsgdHJhbnNsYXRpb24ua2V5LnRyaW0oKV0gPSB0cmFuc2xhdGlvbi52YWx1ZTtcclxuICAgICAgICAgIHJldHVybiBhY2M7XHJcbiAgICAgICAgfSwge30pLFxyXG4gICAgICApLFxyXG4gICAgICBtYXAoKHRyYW5zbGF0aW9ucykgPT5cclxuICAgICAgICBPYmplY3QuZW50cmllcyh0cmFuc2xhdGlvbnMpLnJlZHVjZSgoYWNjLCBba2V5LCB2YWx1ZV0pID0+IHtcclxuICAgICAgICAgIGNvbnN0IGtleXMgPSBrZXkuc3BsaXQoJy4nKTtcclxuICAgICAgICAgIGtleXMucmVkdWNlPHsgW2luZGV4OiBzdHJpbmddOiBhbnkgfT4oKGN1cnJlbnQsIGssIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0ga2V5cy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgY3VycmVudFtrXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGN1cnJlbnRba10gPSBjdXJyZW50W2tdIHx8IHt9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50W2tdO1xyXG4gICAgICAgICAgfSwgYWNjKTtcclxuXHJcbiAgICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICAgIH0sIHt9KSxcclxuICAgICAgKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9nZXRUcmFuc2xhdGlvbnNGcm9tRmlsZShsYW5nOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRyYW5zbGF0aW9uW10+IHtcclxuICAgIHJldHVybiB0aGlzLl9odHRwLmdldDx7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9PihgJHt0aGlzLl9zb3VyY2VDb25maWcuZmlsZVBhdGh9JHt0aGlzLl9pZH0vJHtsYW5nfS5qc29uYCkucGlwZShcclxuICAgICAgbWFwKChqc29uRGF0YSkgPT5cclxuICAgICAgICBPYmplY3QuZW50cmllcyhqc29uRGF0YSkubWFwKChba2V5LCB2YWx1ZV0pID0+ICh7XHJcbiAgICAgICAgICBrZXksXHJcbiAgICAgICAgICB2YWx1ZSxcclxuICAgICAgICB9KSksXHJcbiAgICAgICksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZ2V0VHJhbnNsYXRpb25zRnJvbUdyYXBoUUwobGFuZzogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fc3RyYXBpU2VydmljZS5mZXRjaFF1ZXJ5TGlzdCQ8VHJhbnNsYXRpb24+KEdFVF9UUkFOU0xBVElPTlMobGFuZywgdGhpcy5faWQpLCAndHJhbnNsYXRpb25zJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==