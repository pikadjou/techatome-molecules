import { Injectable } from "@angular/core";
import { map, of, switchMap } from "rxjs";
import { HandleComplexRequest, TaBaseService } from "@ta/server";
import { getUniqueArray } from "@ta/utils";
import { GET_NOTIFICATIONS, GET_NOTIFICATIONS_COUNT, READ_NOTIFICATION, } from "./queries";
import * as i0 from "@angular/core";
import * as i1 from "./shared.service";
const graphEndpoint = {
    clientName: "notificationService",
    endpoint: "notification",
};
export class TaNotificationDataService extends TaBaseService {
    constructor(_sharedService) {
        super();
        this._sharedService = _sharedService;
        this.list = new HandleComplexRequest();
        this.count = new HandleComplexRequest();
        this._graphService.registerGraphEndpoint(graphEndpoint);
    }
    fetchNotifications$(filters) {
        return this.list.fetch(this.computeKey(filters), this._graphService
            .fetchPagedQueryList(GET_NOTIFICATIONS(filters), "notifications", graphEndpoint.clientName)
            .pipe(map((data) => data.items ?? []), switchMap((entities) => {
            if (!this._sharedService.getProjects$) {
                return of(entities);
            }
            return this._sharedService
                .getProjects$(getUniqueArray(entities.map((entity) => entity.projectId)))
                .pipe(map((projects) => entities.map((entity) => ({
                ...entity,
                ...{
                    project: projects.find((project) => project.id === entity.projectId),
                },
            }))));
        })));
    }
    fetchNumberOfNotifications$(filters) {
        return this.count.fetch(this.computeKey(filters), this._graphService
            .fetchPagedQueryList(GET_NOTIFICATIONS_COUNT(filters), "notifications", graphEndpoint.clientName)
            .pipe(map((data) => data.totalCount)));
    }
    isRead$(id) {
        return this._graphService.mutate(READ_NOTIFICATION(id), "notificationRead", graphEndpoint.clientName);
    }
    computeKey(filters) {
        if (!filters) {
            return "all";
        }
        return `${filters.projectId}-${filters.isNew}-${filters.take}`;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaNotificationDataService, deps: [{ token: i1.TaNotificationSharedService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaNotificationDataService, providedIn: "root" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.14", ngImport: i0, type: TaNotificationDataService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: () => [{ type: i1.TaNotificationSharedService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zZXJ2aWNlcy9kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFMUMsT0FBTyxFQUFpQixvQkFBb0IsRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDaEYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUczQyxPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLHVCQUF1QixFQUV2QixpQkFBaUIsR0FDbEIsTUFBTSxXQUFXLENBQUM7OztBQUduQixNQUFNLGFBQWEsR0FBa0I7SUFDbkMsVUFBVSxFQUFFLHFCQUFxQjtJQUNqQyxRQUFRLEVBQUUsY0FBYztDQUN6QixDQUFDO0FBS0YsTUFBTSxPQUFPLHlCQUEwQixTQUFRLGFBQWE7SUFLMUQsWUFBb0IsY0FBMkM7UUFDN0QsS0FBSyxFQUFFLENBQUM7UUFEVSxtQkFBYyxHQUFkLGNBQWMsQ0FBNkI7UUFKeEQsU0FBSSxHQUFHLElBQUksb0JBQW9CLEVBQXFCLENBQUM7UUFFckQsVUFBSyxHQUFHLElBQUksb0JBQW9CLEVBQVUsQ0FBQztRQUtoRCxJQUFJLENBQUMsYUFBYSxDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFTSxtQkFBbUIsQ0FBQyxPQUEyQjtRQUNwRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUNwQixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUN4QixJQUFJLENBQUMsYUFBYTthQUNmLG1CQUFtQixDQUNsQixpQkFBaUIsQ0FBQyxPQUFPLENBQUMsRUFDMUIsZUFBZSxFQUNmLGFBQWEsQ0FBQyxVQUFVLENBQ3pCO2FBQ0EsSUFBSSxDQUNILEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsRUFDL0IsU0FBUyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ3RDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3RCLENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQyxjQUFjO2lCQUN2QixZQUFZLENBQ1gsY0FBYyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUMzRDtpQkFDQSxJQUFJLENBQ0gsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FDZixRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUN4QixHQUFHLE1BQU07Z0JBQ1QsR0FBRztvQkFDRCxPQUFPLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FDcEIsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssTUFBTSxDQUFDLFNBQVMsQ0FDN0M7aUJBQ0Y7YUFDRixDQUFDLENBQUMsQ0FDSixDQUNGLENBQUM7UUFDTixDQUFDLENBQUMsQ0FDSCxDQUNKLENBQUM7SUFDSixDQUFDO0lBRU0sMkJBQTJCLENBQUMsT0FBMkI7UUFDNUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FDckIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFDeEIsSUFBSSxDQUFDLGFBQWE7YUFDZixtQkFBbUIsQ0FDbEIsdUJBQXVCLENBQUMsT0FBTyxDQUFDLEVBQ2hDLGVBQWUsRUFDZixhQUFhLENBQUMsVUFBVSxDQUN6QjthQUNBLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUN4QyxDQUFDO0lBQ0osQ0FBQztJQUVNLE9BQU8sQ0FBQyxFQUFVO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQzlCLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxFQUNyQixrQkFBa0IsRUFDbEIsYUFBYSxDQUFDLFVBQVUsQ0FDekIsQ0FBQztJQUNKLENBQUM7SUFFTSxVQUFVLENBQUMsT0FBNEI7UUFDNUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2IsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDakUsQ0FBQzsrR0ExRVUseUJBQXlCO21IQUF6Qix5QkFBeUIsY0FGeEIsTUFBTTs7NEZBRVAseUJBQXlCO2tCQUhyQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG5pbXBvcnQgeyBtYXAsIG9mLCBzd2l0Y2hNYXAgfSBmcm9tIFwicnhqc1wiO1xuXG5pbXBvcnQgeyBHcmFwaEVuZHBvaW50LCBIYW5kbGVDb21wbGV4UmVxdWVzdCwgVGFCYXNlU2VydmljZSB9IGZyb20gXCJAdGEvc2VydmVyXCI7XG5pbXBvcnQgeyBnZXRVbmlxdWVBcnJheSB9IGZyb20gXCJAdGEvdXRpbHNcIjtcblxuaW1wb3J0IHsgTm90aWZpY2F0aW9uRHRvIH0gZnJvbSBcIi4vZHRvL25vdGlmaWNhdGlvblwiO1xuaW1wb3J0IHtcbiAgR0VUX05PVElGSUNBVElPTlMsXG4gIEdFVF9OT1RJRklDQVRJT05TX0NPVU5ULFxuICBOb3RpZmljYXRpb25GaWx0ZXIsXG4gIFJFQURfTk9USUZJQ0FUSU9OLFxufSBmcm9tIFwiLi9xdWVyaWVzXCI7XG5pbXBvcnQgeyBUYU5vdGlmaWNhdGlvblNoYXJlZFNlcnZpY2UgfSBmcm9tIFwiLi9zaGFyZWQuc2VydmljZVwiO1xuXG5jb25zdCBncmFwaEVuZHBvaW50OiBHcmFwaEVuZHBvaW50ID0ge1xuICBjbGllbnROYW1lOiBcIm5vdGlmaWNhdGlvblNlcnZpY2VcIixcbiAgZW5kcG9pbnQ6IFwibm90aWZpY2F0aW9uXCIsXG59O1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46IFwicm9vdFwiLFxufSlcbmV4cG9ydCBjbGFzcyBUYU5vdGlmaWNhdGlvbkRhdGFTZXJ2aWNlIGV4dGVuZHMgVGFCYXNlU2VydmljZSB7XG4gIHB1YmxpYyBsaXN0ID0gbmV3IEhhbmRsZUNvbXBsZXhSZXF1ZXN0PE5vdGlmaWNhdGlvbkR0b1tdPigpO1xuXG4gIHB1YmxpYyBjb3VudCA9IG5ldyBIYW5kbGVDb21wbGV4UmVxdWVzdDxudW1iZXI+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfc2hhcmVkU2VydmljZTogVGFOb3RpZmljYXRpb25TaGFyZWRTZXJ2aWNlKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuX2dyYXBoU2VydmljZS5yZWdpc3RlckdyYXBoRW5kcG9pbnQoZ3JhcGhFbmRwb2ludCk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hOb3RpZmljYXRpb25zJChmaWx0ZXJzOiBOb3RpZmljYXRpb25GaWx0ZXIpIHtcbiAgICByZXR1cm4gdGhpcy5saXN0LmZldGNoKFxuICAgICAgdGhpcy5jb21wdXRlS2V5KGZpbHRlcnMpLFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0PE5vdGlmaWNhdGlvbkR0bz4oXG4gICAgICAgICAgR0VUX05PVElGSUNBVElPTlMoZmlsdGVycyksXG4gICAgICAgICAgXCJub3RpZmljYXRpb25zXCIsXG4gICAgICAgICAgZ3JhcGhFbmRwb2ludC5jbGllbnROYW1lXG4gICAgICAgIClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWFwKChkYXRhKSA9PiBkYXRhLml0ZW1zID8/IFtdKSxcbiAgICAgICAgICBzd2l0Y2hNYXAoKGVudGl0aWVzKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3NoYXJlZFNlcnZpY2UuZ2V0UHJvamVjdHMkKSB7XG4gICAgICAgICAgICAgIHJldHVybiBvZihlbnRpdGllcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc2hhcmVkU2VydmljZVxuICAgICAgICAgICAgICAuZ2V0UHJvamVjdHMkKFxuICAgICAgICAgICAgICAgIGdldFVuaXF1ZUFycmF5KGVudGl0aWVzLm1hcCgoZW50aXR5KSA9PiBlbnRpdHkucHJvamVjdElkKSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHByb2plY3RzKSA9PlxuICAgICAgICAgICAgICAgICAgZW50aXRpZXMubWFwKChlbnRpdHkpID0+ICh7XG4gICAgICAgICAgICAgICAgICAgIC4uLmVudGl0eSxcbiAgICAgICAgICAgICAgICAgICAgLi4ue1xuICAgICAgICAgICAgICAgICAgICAgIHByb2plY3Q6IHByb2plY3RzLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAocHJvamVjdCkgPT4gcHJvamVjdC5pZCA9PT0gZW50aXR5LnByb2plY3RJZFxuICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZmV0Y2hOdW1iZXJPZk5vdGlmaWNhdGlvbnMkKGZpbHRlcnM6IE5vdGlmaWNhdGlvbkZpbHRlcikge1xuICAgIHJldHVybiB0aGlzLmNvdW50LmZldGNoKFxuICAgICAgdGhpcy5jb21wdXRlS2V5KGZpbHRlcnMpLFxuICAgICAgdGhpcy5fZ3JhcGhTZXJ2aWNlXG4gICAgICAgIC5mZXRjaFBhZ2VkUXVlcnlMaXN0KFxuICAgICAgICAgIEdFVF9OT1RJRklDQVRJT05TX0NPVU5UKGZpbHRlcnMpLFxuICAgICAgICAgIFwibm90aWZpY2F0aW9uc1wiLFxuICAgICAgICAgIGdyYXBoRW5kcG9pbnQuY2xpZW50TmFtZVxuICAgICAgICApXG4gICAgICAgIC5waXBlKG1hcCgoZGF0YSkgPT4gZGF0YS50b3RhbENvdW50KSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGlzUmVhZCQoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9ncmFwaFNlcnZpY2UubXV0YXRlPGJvb2xlYW4+KFxuICAgICAgUkVBRF9OT1RJRklDQVRJT04oaWQpLFxuICAgICAgXCJub3RpZmljYXRpb25SZWFkXCIsXG4gICAgICBncmFwaEVuZHBvaW50LmNsaWVudE5hbWVcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGNvbXB1dGVLZXkoZmlsdGVycz86IE5vdGlmaWNhdGlvbkZpbHRlcikge1xuICAgIGlmICghZmlsdGVycykge1xuICAgICAgcmV0dXJuIFwiYWxsXCI7XG4gICAgfVxuXG4gICAgcmV0dXJuIGAke2ZpbHRlcnMucHJvamVjdElkfS0ke2ZpbHRlcnMuaXNOZXd9LSR7ZmlsdGVycy50YWtlfWA7XG4gIH1cbn1cbiJdfQ==