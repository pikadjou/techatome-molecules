export class TagTool {
    static get isInline() {
        return true;
    }
    static get shortcut() {
        return 'CTRL+A';
    }
    static get sanitize() {
        return {
            span: {
                'class': true,
                'data-user-id': true,
            },
        };
    }
    constructor({ api, config }) {
        this.users = [];
        this.dropdown = document.createElement('div');
        this.templateTagSpan = document.createElement('span');
        this._currentTagSpan = null;
        this.handleKeydown = (event) => {
            if (!event || !(event instanceof KeyboardEvent)) {
                return;
            }
            if (event.key === '@') {
                event.preventDefault(); // Emp√™che l'insertion du @ par d√©faut
                this._insertTagAtCursor();
                return;
            }
            if (event.key === 'Escape') {
                this._cancelTag();
            }
        };
        this.handleTyping = () => {
            if (!this._currentTagSpan) {
                return;
            }
            const text = this._currentTagSpan?.textContent?.trim();
            const query = text?.slice(1).toLowerCase(); // Supprime le @ et met en minuscule
            const filteredUsers = !query || query?.length === 0 ? this.users : this.users.filter(user => user.name.toLowerCase().includes(query));
            this._updateDropdown(filteredUsers);
        };
        this.handleOutsideClick = (event) => {
            if (!event) {
                return;
            }
            if (this.dropdown.hidden) {
                return;
            }
            // V√©rifie si le clic n'est PAS sur la dropdown ni sur la mention en cours
            if (!this.dropdown.contains(event.target) && this._currentTagSpan !== event.target) {
                this._cancelTag();
            }
        };
        this.api = api;
        this.users = config?.users || [];
        this._initDOM();
    }
    render() {
        return {
            icon: '@',
            label: 'Tag',
            onActivate: () => {
                this._insertTagAtCursor();
            },
        };
    }
    surround(range) {
        if (!range) {
            return;
        }
        if (!this._currentTagSpan) {
            return;
        }
        this._currentTagSpan = this.templateTagSpan.cloneNode(true);
        range.insertNode(this._currentTagSpan);
        this._showDropdown();
    }
    checkState() {
        return false;
    }
    _initDOM() {
        this.templateTagSpan.classList.add('tag-user', 'text-color-text-brand-primary');
        this.templateTagSpan.dataset['userId'] = '';
        this.templateTagSpan.textContent = '@';
        this.dropdown.classList.add('tag-dropdown', 'p-space-sm', 'bxs-shadow-black-sm');
        this.dropdown.style.position = 'absolute';
        this.dropdown.style.background = 'white';
        this.dropdown.style.zIndex = '1000';
        this.dropdown.style.maxHeight = '150px';
        this.dropdown.style.overflowY = 'auto';
        const editorDiv = document.body.querySelector('.editor-container');
        if (editorDiv) {
            this.api.listeners.on(editorDiv, 'keydown', this.handleKeydown);
            this.api.listeners.on(editorDiv, 'input', this.handleTyping);
        }
        this.api.listeners.on(document.body, 'click', this.handleOutsideClick);
    }
    _insertTagAtCursor() {
        const selection = window.getSelection();
        if (!selection) {
            return;
        }
        const range = selection.getRangeAt(0);
        if (!range) {
            return;
        }
        this._currentTagSpan = this.templateTagSpan.cloneNode(true);
        range.insertNode(this._currentTagSpan);
        range.setStartAfter(this._currentTagSpan);
        range.setEndAfter(this._currentTagSpan);
        selection.removeAllRanges();
        selection.addRange(range);
        this._showDropdown();
    }
    _showDropdown() {
        if (!this._currentTagSpan) {
            return;
        }
        this._updateDropdown(this.users);
        document.body.appendChild(this.dropdown);
        const rect = this._currentTagSpan.getBoundingClientRect();
        this.dropdown.style.top = `${rect.bottom + window.scrollY}px`;
        this.dropdown.style.left = `${rect.left + window.scrollX}px`;
    }
    _hideDropdown() {
        document.body.removeChild(this.dropdown);
    }
    _updateDropdown(users) {
        this.dropdown.innerHTML = '';
        if (users.length === 0) {
            const noResult = document.createElement('div');
            noResult.textContent = 'Aucun r√©sultat';
            noResult.style.padding = '5px';
            this.dropdown.appendChild(noResult);
            return;
        }
        users.forEach((user, index) => {
            const option = document.createElement('div');
            option.textContent = user.name;
            option.style.padding = '5px';
            option.style.cursor = 'pointer';
            option.dataset['index'] = index.toString();
            option.addEventListener('click', () => this._selectUser(user));
            this.dropdown.appendChild(option);
        });
    }
    _selectUser(user) {
        if (!this._currentTagSpan) {
            return;
        }
        // Remplace le contenu du span avec le nom s√©lectionn√©
        this._currentTagSpan.textContent = `@${user.name}`;
        this._currentTagSpan.dataset['userId'] = user.id;
        // Ins√®re un n≈ìud texte apr√®s la tag pour √©viter de garder le style
        const textNode = document.createTextNode('\u00A0'); // Un espace pour √©viter que le curseur colle
        this._currentTagSpan.after(textNode);
        // üî• D√©place le curseur apr√®s la tag pour continuer √† √©crire normalement
        const range = document.createRange();
        const selection = window.getSelection();
        range.setStartAfter(textNode);
        range.collapse(true);
        selection?.removeAllRanges();
        selection?.addRange(range);
        // Cache la dropdown et r√©initialise
        this._currentTagSpan = null;
        this._hideDropdown();
    }
    _cancelTag() {
        if (!this._currentTagSpan) {
            return;
        }
        // R√©cup√®re le texte √† l'int√©rieur de la span
        const textContent = this._currentTagSpan.textContent || '';
        // Cr√©e un n≈ìud texte avec le m√™me contenu
        const textNode = document.createTextNode(textContent);
        // Remplace la span par le texte brut
        this._currentTagSpan.replaceWith(textNode);
        // R√©initialise la r√©f√©rence
        this._currentTagSpan = null;
        this._hideDropdown();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFnLWVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy93eXNpc3d5Zy9jb21wb25lbnRzL3BsdWdpbnMvdGFnLWVkaXRvci90YWctZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLE1BQU0sS0FBSyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNELE1BQU0sS0FBSyxRQUFRO1FBQ2pCLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDRCxNQUFNLEtBQUssUUFBUTtRQUNqQixPQUFPO1lBQ0wsSUFBSSxFQUFFO2dCQUNKLE9BQU8sRUFBRSxJQUFJO2dCQUNiLGNBQWMsRUFBRSxJQUFJO2FBQ3JCO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFVRCxZQUFZLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBdUQ7UUFQekUsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUVuQixhQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxvQkFBZSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFaEQsb0JBQWUsR0FBMkIsSUFBSSxDQUFDO1FBcUNoRCxrQkFBYSxHQUFHLENBQUMsS0FBYSxFQUFFLEVBQUU7WUFDdkMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLGFBQWEsQ0FBQyxFQUFFLENBQUM7Z0JBQ2hELE9BQU87WUFDVCxDQUFDO1lBQ0QsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUN0QixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxzQ0FBc0M7Z0JBQzlELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUMxQixPQUFPO1lBQ1QsQ0FBQztZQUNELElBQUksS0FBSyxD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UUFFM0MsNEJBQTRCO1FBQzVCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzVCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUEksIEJsb2NrVG9vbENvbnN0cnVjdG9yT3B0aW9ucywgSW5saW5lVG9vbCB9IGZyb20gJ0BlZGl0b3Jqcy9lZGl0b3Jqcyc7XHJcbmltcG9ydCB7IE1lbnVDb25maWcgfSBmcm9tICdAZWRpdG9yanMvZWRpdG9yanMvdHlwZXMvdG9vbHMnO1xyXG5cclxudHlwZSBVc2VyID0geyBpZDogc3RyaW5nOyBuYW1lOiBzdHJpbmcgfTtcclxuXHJcbmV4cG9ydCBjbGFzcyBUYWdUb29sIGltcGxlbWVudHMgSW5saW5lVG9vbCB7XHJcbiAgc3RhdGljIGdldCBpc0lubGluZSgpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuICBzdGF0aWMgZ2V0IHNob3J0Y3V0KCkge1xyXG4gICAgcmV0dXJuICdDVFJMK0EnO1xyXG4gIH1cclxuICBzdGF0aWMgZ2V0IHNhbml0aXplKCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3Bhbjoge1xyXG4gICAgICAgICdjbGFzcyc6IHRydWUsXHJcbiAgICAgICAgJ2RhdGEtdXNlci1pZCc6IHRydWUsXHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcmVhZG9ubHkgYXBpOiBBUEk7XHJcbiAgcHVibGljIHVzZXJzOiBVc2VyW10gPSBbXTtcclxuXHJcbiAgcHVibGljIGRyb3Bkb3duID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgcHVibGljIHRlbXBsYXRlVGFnU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuXHJcbiAgcHJpdmF0ZSBfY3VycmVudFRhZ1NwYW46IG51bGwgfCBIVE1MU3BhbkVsZW1lbnQgPSBudWxsO1xyXG5cclxuICBjb25zdHJ1Y3Rvcih7IGFwaSwgY29uZmlnIH06IEJsb2NrVG9vbENvbnN0cnVjdG9yT3B0aW9uczxhbnksIHsgdXNlcnM6IFVzZXJbXSB9Pikge1xyXG4gICAgdGhpcy5hcGkgPSBhcGk7XHJcbiAgICB0aGlzLnVzZXJzID0gY29uZmlnPy51c2VycyB8fCBbXTtcclxuXHJcbiAgICB0aGlzLl9pbml0RE9NKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVuZGVyKCk6IE1lbnVDb25maWcge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgaWNvbjogJ0AnLFxyXG4gICAgICBsYWJlbDogJ1RhZycsXHJcbiAgICAgIG9uQWN0aXZhdGU6ICgpID0+IHtcclxuICAgICAgICB0aGlzLl9pbnNlcnRUYWdBdEN1cnNvcigpO1xyXG4gICAgICB9LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdXJyb3VuZChyYW5nZTogUmFuZ2UgfCBudWxsKSB7XHJcbiAgICBpZiAoIXJhbmdlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRoaXMuX2N1cnJlbnRUYWdTcGFuKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuID0gdGhpcy50ZW1wbGF0ZVRhZ1NwYW4uY2xvbmVOb2RlKHRydWUpIGFzIHR5cGVvZiB0aGlzLnRlbXBsYXRlVGFnU3BhbjtcclxuICAgIHJhbmdlLmluc2VydE5vZGUodGhpcy5fY3VycmVudFRhZ1NwYW4pO1xyXG5cclxuICAgIHRoaXMuX3Nob3dEcm9wZG93bigpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNoZWNrU3RhdGUoKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaGFuZGxlS2V5ZG93biA9IChldmVudD86IEV2ZW50KSA9PiB7XHJcbiAgICBpZiAoIWV2ZW50IHx8ICEoZXZlbnQgaW5zdGFuY2VvZiBLZXlib2FyZEV2ZW50KSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoZXZlbnQua2V5ID09PSAnQCcpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gRW1ww6pjaGUgbCdpbnNlcnRpb24gZHUgQCBwYXIgZMOpZmF1dFxyXG4gICAgICB0aGlzLl9pbnNlcnRUYWdBdEN1cnNvcigpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoZXZlbnQua2V5ID09PSAnRXNjYXBlJykge1xyXG4gICAgICB0aGlzLl9jYW5jZWxUYWcoKTtcclxuICAgIH1cclxuICB9O1xyXG4gIHB1YmxpYyBoYW5kbGVUeXBpbmcgPSAoKSA9PiB7XHJcbiAgICBpZiAoIXRoaXMuX2N1cnJlbnRUYWdTcGFuKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHRleHQgPSB0aGlzLl9jdXJyZW50VGFnU3Bhbj8udGV4dENvbnRlbnQ/LnRyaW0oKTtcclxuICAgIGNvbnN0IHF1ZXJ5ID0gdGV4dD8uc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsgLy8gU3VwcHJpbWUgbGUgQCBldCBtZXQgZW4gbWludXNjdWxlXHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRVc2VycyA9XHJcbiAgICAgICFxdWVyeSB8fCBxdWVyeT8ubGVuZ3RoID09PSAwID8gdGhpcy51c2VycyA6IHRoaXMudXNlcnMuZmlsdGVyKHVzZXIgPT4gdXNlci5uYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocXVlcnkpKTtcclxuXHJcbiAgICB0aGlzLl91cGRhdGVEcm9wZG93bihmaWx0ZXJlZFVzZXJzKTtcclxuICB9O1xyXG4gIHB1YmxpYyBoYW5kbGVPdXRzaWRlQ2xpY2sgPSAoZXZlbnQ/OiBFdmVudCkgPT4ge1xyXG4gICAgaWYgKCFldmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5kcm9wZG93bi5oaWRkZW4pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFbDqXJpZmllIHNpIGxlIGNsaWMgbidlc3QgUEFTIHN1ciBsYSBkcm9wZG93biBuaSBzdXIgbGEgbWVudGlvbiBlbiBjb3Vyc1xyXG4gICAgaWYgKCF0aGlzLmRyb3Bkb3duLmNvbnRhaW5zKGV2ZW50LnRhcmdldCBhcyBOb2RlKSAmJiB0aGlzLl9jdXJyZW50VGFnU3BhbiAhPT0gZXZlbnQudGFyZ2V0KSB7XHJcbiAgICAgIHRoaXMuX2NhbmNlbFRhZygpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgX2luaXRET00oKSB7XHJcbiAgICB0aGlzLnRlbXBsYXRlVGFnU3Bhbi5jbGFzc0xpc3QuYWRkKCd0YWctdXNlcicsICd0ZXh0LWNvbG9yLXRleHQtYnJhbmQtcHJpbWFyeScpO1xyXG4gICAgdGhpcy50ZW1wbGF0ZVRhZ1NwYW4uZGF0YXNldFsndXNlcklkJ10gPSAnJztcclxuICAgIHRoaXMudGVtcGxhdGVUYWdTcGFuLnRleHRDb250ZW50ID0gJ0AnO1xyXG5cclxuICAgIHRoaXMuZHJvcGRvd24uY2xhc3NMaXN0LmFkZCgndGFnLWRyb3Bkb3duJywgJ3Atc3BhY2Utc20nLCAnYnhzLXNoYWRvdy1ibGFjay1zbScpO1xyXG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XHJcbiAgICB0aGlzLmRyb3Bkb3duLnN0eWxlLmJhY2tncm91bmQgPSAnd2hpdGUnO1xyXG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS56SW5kZXggPSAnMTAwMCc7XHJcbiAgICB0aGlzLmRyb3Bkb3duLnN0eWxlLm1heEhlaWdodCA9ICcxNTBweCc7XHJcbiAgICB0aGlzLmRyb3Bkb3duLnN0eWxlLm92ZXJmbG93WSA9ICdhdXRvJztcclxuXHJcbiAgICBjb25zdCBlZGl0b3JEaXYgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoJy5lZGl0b3ItY29udGFpbmVyJyk7XHJcbiAgICBpZiAoZWRpdG9yRGl2KSB7XHJcbiAgICAgIHRoaXMuYXBpLmxpc3RlbmVycy5vbihlZGl0b3JEaXYsICdrZXlkb3duJywgdGhpcy5oYW5kbGVLZXlkb3duKTtcclxuICAgICAgdGhpcy5hcGkubGlzdGVuZXJzLm9uKGVkaXRvckRpdiwgJ2lucHV0JywgdGhpcy5oYW5kbGVUeXBpbmcpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXBpLmxpc3RlbmVycy5vbihkb2N1bWVudC5ib2R5LCAnY2xpY2snLCB0aGlzLmhhbmRsZU91dHNpZGVDbGljayk7XHJcbiAgfVxyXG4gIHByaXZhdGUgX2luc2VydFRhZ0F0Q3Vyc29yKCkge1xyXG4gICAgY29uc3Qgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xyXG4gICAgaWYgKCFzZWxlY3Rpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7XHJcblxyXG4gICAgaWYgKCFyYW5nZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fY3VycmVudFRhZ1NwYW4gPSB0aGlzLnRlbXBsYXRlVGFnU3Bhbi5jbG9uZU5vZGUodHJ1ZSkgYXMgdHlwZW9mIHRoaXMudGVtcGxhdGVUYWdTcGFuO1xyXG5cclxuICAgIHJhbmdlLmluc2VydE5vZGUodGhpcy5fY3VycmVudFRhZ1NwYW4pO1xyXG4gICAgcmFuZ2Uuc2V0U3RhcnRBZnRlcih0aGlzLl9jdXJyZW50VGFnU3Bhbik7XHJcbiAgICByYW5nZS5zZXRFbmRBZnRlcih0aGlzLl9jdXJyZW50VGFnU3Bhbik7XHJcbiAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpO1xyXG5cclxuICAgIHRoaXMuX3Nob3dEcm9wZG93bigpO1xyXG4gIH1cclxuICBwcml2YXRlIF9zaG93RHJvcGRvd24oKSB7XHJcbiAgICBpZiAoIXRoaXMuX2N1cnJlbnRUYWdTcGFuKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuX3VwZGF0ZURyb3Bkb3duKHRoaXMudXNlcnMpO1xyXG5cclxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5kcm9wZG93bik7XHJcbiAgICBjb25zdCByZWN0ID0gdGhpcy5fY3VycmVudFRhZ1NwYW4uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICB0aGlzLmRyb3Bkb3duLnN0eWxlLnRvcCA9IGAke3JlY3QuYm90dG9tICsgd2luZG93LnNjcm9sbFl9cHhgO1xyXG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS5sZWZ0ID0gYCR7cmVjdC5sZWZ0ICsgd2luZG93LnNjcm9sbFh9cHhgO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfaGlkZURyb3Bkb3duKCkge1xyXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmRyb3Bkb3duKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3VwZGF0ZURyb3Bkb3duKHVzZXJzOiBVc2VyW10pIHtcclxuICAgIHRoaXMuZHJvcGRvd24uaW5uZXJIVE1MID0gJyc7XHJcblxyXG4gICAgaWYgKHVzZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICBjb25zdCBub1Jlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICBub1Jlc3VsdC50ZXh0Q29udGVudCA9ICdBdWN1biByw6lzdWx0YXQnO1xyXG4gICAgICBub1Jlc3VsdC5zdHlsZS5wYWRkaW5nID0gJzVweCc7XHJcbiAgICAgIHRoaXMuZHJvcGRvd24uYXBwZW5kQ2hpbGQobm9SZXN1bHQpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdXNlcnMuZm9yRWFjaCgodXNlciwgaW5kZXgpID0+IHtcclxuICAgICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgIG9wdGlvbi50ZXh0Q29udGVudCA9IHVzZXIubmFtZTtcclxuICAgICAgb3B0aW9uLnN0eWxlLnBhZGRpbmcgPSAnNXB4JztcclxuICAgICAgb3B0aW9uLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJztcclxuICAgICAgb3B0aW9uLmRhdGFzZXRbJ2luZGV4J10gPSBpbmRleC50b1N0cmluZygpO1xyXG5cclxuICAgICAgb3B0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5fc2VsZWN0VXNlcih1c2VyKSk7XHJcblxyXG4gICAgICB0aGlzLmRyb3Bkb3duLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3NlbGVjdFVzZXIodXNlcjogVXNlcikge1xyXG4gICAgaWYgKCF0aGlzLl9jdXJyZW50VGFnU3Bhbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVtcGxhY2UgbGUgY29udGVudSBkdSBzcGFuIGF2ZWMgbGUgbm9tIHPDqWxlY3Rpb25uw6lcclxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuLnRleHRDb250ZW50ID0gYEAke3VzZXIubmFtZX1gO1xyXG4gICAgdGhpcy5fY3VycmVudFRhZ1NwYW4uZGF0YXNldFsndXNlcklkJ10gPSB1c2VyLmlkO1xyXG5cclxuICAgIC8vIEluc8OocmUgdW4gbsWTdWQgdGV4dGUgYXByw6hzIGxhIHRhZyBwb3VyIMOpdml0ZXIgZGUgZ2FyZGVyIGxlIHN0eWxlXHJcbiAgICBjb25zdCB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdcXHUwMEEwJyk7IC8vIFVuIGVzcGFjZSBwb3VyIMOpdml0ZXIgcXVlIGxlIGN1cnNldXIgY29sbGVcclxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuLmFmdGVyKHRleHROb2RlKTtcclxuXHJcbiAgICAvLyDwn5SlIETDqXBsYWNlIGxlIGN1cnNldXIgYXByw6hzIGxhIHRhZyBwb3VyIGNvbnRpbnVlciDDoCDDqWNyaXJlIG5vcm1hbGVtZW50XHJcbiAgICBjb25zdCByYW5nZSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7XHJcbiAgICBjb25zdCBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICByYW5nZS5zZXRTdGFydEFmdGVyKHRleHROb2RlKTtcclxuICAgIHJhbmdlLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgc2VsZWN0aW9uPy5yZW1vdmVBbGxSYW5nZXMoKTtcclxuICAgIHNlbGVjdGlvbj8uYWRkUmFuZ2UocmFuZ2UpO1xyXG5cclxuICAgIC8vIENhY2hlIGxhIGRyb3Bkb3duIGV0IHLDqWluaXRpYWxpc2VcclxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuID0gbnVsbDtcclxuICAgIHRoaXMuX2hpZGVEcm9wZG93bigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfY2FuY2VsVGFnKCkge1xyXG4gICAgaWYgKCF0aGlzLl9jdXJyZW50VGFnU3Bhbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUsOpY3Vww6hyZSBsZSB0ZXh0ZSDDoCBsJ2ludMOpcmlldXIgZGUgbGEgc3BhblxyXG4gICAgY29uc3QgdGV4dENvbnRlbnQgPSB0aGlzLl9jdXJyZW50VGFnU3Bhbi50ZXh0Q29udGVudCB8fCAnJztcclxuXHJcbiAgICAvLyBDcsOpZSB1biBuxZN1ZCB0ZXh0ZSBhdmVjIGxlIG3Dqm1lIGNvbnRlbnVcclxuICAgIGNvbnN0IHRleHROb2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dENvbnRlbnQpO1xyXG5cclxuICAgIC8vIFJlbXBsYWNlIGxhIHNwYW4gcGFyIGxlIHRleHRlIGJydXRcclxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuLnJlcGxhY2VXaXRoKHRleHROb2RlKTtcclxuXHJcbiAgICAvLyBSw6lpbml0aWFsaXNlIGxhIHLDqWbDqXJlbmNlXHJcbiAgICB0aGlzLl9jdXJyZW50VGFnU3BhbiA9IG51bGw7XHJcbiAgICB0aGlzLl9oaWRlRHJvcGRvd24oKTtcclxuICB9XHJcbn1cclxuIl19