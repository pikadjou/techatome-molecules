export class TagTool {
    static get isInline() {
        return true;
    }
    static get shortcut() {
        return "CTRL+A";
    }
    static get sanitize() {
        return {
            span: {
                class: true,
                "data-user-id": true,
            },
        };
    }
    constructor({ api, config, }) {
        this.users = [];
        this.dropdown = document.createElement("div");
        this.templateTagSpan = document.createElement("span");
        this._currentTagSpan = null;
        this.handleKeydown = (event) => {
            if (!event || !(event instanceof KeyboardEvent)) {
                return;
            }
            if (event.key === "@") {
                event.preventDefault(); // Emp√™che l'insertion du @ par d√©faut
                this._insertTagAtCursor();
                return;
            }
            if (event.key === "Escape") {
                this._cancelTag();
            }
        };
        this.handleTyping = () => {
            if (!this._currentTagSpan) {
                return;
            }
            const text = this._currentTagSpan?.textContent?.trim();
            const query = text?.slice(1).toLowerCase(); // Supprime le @ et met en minuscule
            const filteredUsers = !query || query?.length === 0
                ? this.users
                : this.users.filter((user) => user.name.toLowerCase().includes(query));
            this._updateDropdown(filteredUsers);
        };
        this.handleOutsideClick = (event) => {
            if (!event) {
                return;
            }
            if (this.dropdown.hidden) {
                return;
            }
            // V√©rifie si le clic n'est PAS sur la dropdown ni sur la mention en cours
            if (!this.dropdown.contains(event.target) &&
                this._currentTagSpan !== event.target) {
                this._cancelTag();
            }
        };
        this.api = api;
        this.users = config?.users || [];
        this._initDOM();
    }
    render() {
        return {
            icon: "@",
            label: "Tag",
            onActivate: () => {
                this._insertTagAtCursor();
            },
        };
    }
    surround(range) {
        if (!range) {
            return;
        }
        if (!this._currentTagSpan) {
            return;
        }
        this._currentTagSpan = this.templateTagSpan.cloneNode(true);
        range.insertNode(this._currentTagSpan);
        this._showDropdown();
    }
    checkState() {
        return false;
    }
    _initDOM() {
        this.templateTagSpan.classList.add("tag-user", "text-color-text-brand-primary");
        this.templateTagSpan.dataset["userId"] = "";
        this.templateTagSpan.textContent = "@";
        this.dropdown.classList.add("tag-dropdown", "p-space-sm", "bxs-shadow-black-sm");
        this.dropdown.style.position = "absolute";
        this.dropdown.style.background = "white";
        this.dropdown.style.zIndex = "1000";
        this.dropdown.style.maxHeight = "150px";
        this.dropdown.style.overflowY = "auto";
        const editorDiv = document.body.querySelector(".editor-container");
        if (editorDiv) {
            this.api.listeners.on(editorDiv, "keydown", this.handleKeydown);
            this.api.listeners.on(editorDiv, "input", this.handleTyping);
        }
        this.api.listeners.on(document.body, "click", this.handleOutsideClick);
    }
    _insertTagAtCursor() {
        const selection = window.getSelection();
        if (!selection) {
            return;
        }
        const range = selection.getRangeAt(0);
        if (!range) {
            return;
        }
        this._currentTagSpan = this.templateTagSpan.cloneNode(true);
        range.insertNode(this._currentTagSpan);
        range.setStartAfter(this._currentTagSpan);
        range.setEndAfter(this._currentTagSpan);
        selection.removeAllRanges();
        selection.addRange(range);
        this._showDropdown();
    }
    _showDropdown() {
        if (!this._currentTagSpan) {
            return;
        }
        this._updateDropdown(this.users);
        document.body.appendChild(this.dropdown);
        const rect = this._currentTagSpan.getBoundingClientRect();
        this.dropdown.style.top = `${rect.bottom + window.scrollY}px`;
        this.dropdown.style.left = `${rect.left + window.scrollX}px`;
    }
    _hideDropdown() {
        document.body.removeChild(this.dropdown);
    }
    _updateDropdown(users) {
        this.dropdown.innerHTML = "";
        if (users.length === 0) {
            const noResult = document.createElement("div");
            noResult.textContent = "Aucun r√©sultat";
            noResult.style.padding = "5px";
            this.dropdown.appendChild(noResult);
            return;
        }
        users.forEach((user, index) => {
            const option = document.createElement("div");
            option.textContent = user.name;
            option.style.padding = "5px";
            option.style.cursor = "pointer";
            option.dataset["index"] = index.toString();
            option.addEventListener("click", () => this._selectUser(user));
            this.dropdown.appendChild(option);
        });
    }
    _selectUser(user) {
        if (!this._currentTagSpan) {
            return;
        }
        // Remplace le contenu du span avec le nom s√©lectionn√©
        this._currentTagSpan.textContent = `@${user.name}`;
        this._currentTagSpan.dataset["userId"] = user.id;
        // Ins√®re un n≈ìud texte apr√®s la tag pour √©viter de garder le style
        const textNode = document.createTextNode("\u00A0"); // Un espace pour √©viter que le curseur colle
        this._currentTagSpan.after(textNode);
        // üî• D√©place le curseur apr√®s la tag pour continuer √† √©crire normalement
        const range = document.createRange();
        const selection = window.getSelection();
        range.setStartAfter(textNode);
        range.collapse(true);
        selection?.removeAllRanges();
        selection?.addRange(range);
        // Cache la dropdown et r√©initialise
        this._currentTagSpan = null;
        this._hideDropdown();
    }
    _cancelTag() {
        if (!this._currentTagSpan) {
            return;
        }
        // R√©cup√®re le texte √† l'int√©rieur de la span
        const textContent = this._currentTagSpan.textContent || "";
        // Cr√©e un n≈ìud texte avec le m√™me contenu
        const textNode = document.createTextNode(textContent);
        // Remplace la span par le texte brut
        this._currentTagSpan.replaceWith(textNode);
        // R√©initialise la r√©f√©rence
        this._currentTagSpan = null;
        this._hideDropdown();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFnLWVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbW9kdWxlcy93eXNpc3d5Zy9jb21wb25lbnRzL3BsdWdpbnMvdGFnLWVkaXRvci90YWctZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVNBLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLE1BQU0sS0FBSyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNELE1BQU0sS0FBSyxRQUFRO1FBQ2pCLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDRCxNQUFNLEtBQUssUUFBUTtRQUNqQixPQUFPO1lBQ0wsSUFBSSxFQUFFO2dCQUNKLEtBQUssRUFBRSxJQUFJO2dCQUNYLGNBQWMsRUFBRSxJQUFJO2FBQ3JCO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFVRCxZQUFZLEVBQ1YsR0FBRyxFQUNILE1BQU0sR0FDOEM7UUFWL0MsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUVuQixhQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxvQkFBZSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFaEQsb0JBQWUsR0FBMkIsSUFBSSxDQUFDO1FBMENoRCxrQkFBYSxHQUFHLENBQUMsS0FBYSxFQUFFLEVBQUU7WUFDdkMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLGFBQWEsQ0FBQyxFQUFFLENBQUM7Z0JBQ2hELE9BQU87WUFDVCxDQUFDO1lBQ0QsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUN0QixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxzQ0FBc0M7Z0JBQzlELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUMxQixPQUFPO1lBQ1QsQ0FBQztZQUNELElBQUksS0FBSyxD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QUFRLENBQUMsQ0FBQztRQUUzQyw0QkFBNEI7UUFDNUIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFDNUIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFQSSxcbiAgQmxvY2tUb29sQ29uc3RydWN0b3JPcHRpb25zLFxuICBJbmxpbmVUb29sLFxufSBmcm9tIFwiQGVkaXRvcmpzL2VkaXRvcmpzXCI7XG5pbXBvcnQgeyBNZW51Q29uZmlnIH0gZnJvbSBcIkBlZGl0b3Jqcy9lZGl0b3Jqcy90eXBlcy90b29sc1wiO1xuXG50eXBlIFVzZXIgPSB7IGlkOiBzdHJpbmc7IG5hbWU6IHN0cmluZyB9O1xuXG5leHBvcnQgY2xhc3MgVGFnVG9vbCBpbXBsZW1lbnRzIElubGluZVRvb2wge1xuICBzdGF0aWMgZ2V0IGlzSW5saW5lKCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHN0YXRpYyBnZXQgc2hvcnRjdXQoKSB7XG4gICAgcmV0dXJuIFwiQ1RSTCtBXCI7XG4gIH1cbiAgc3RhdGljIGdldCBzYW5pdGl6ZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3Bhbjoge1xuICAgICAgICBjbGFzczogdHJ1ZSxcbiAgICAgICAgXCJkYXRhLXVzZXItaWRcIjogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHJlYWRvbmx5IGFwaTogQVBJO1xuICBwdWJsaWMgdXNlcnM6IFVzZXJbXSA9IFtdO1xuXG4gIHB1YmxpYyBkcm9wZG93biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gIHB1YmxpYyB0ZW1wbGF0ZVRhZ1NwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcblxuICBwcml2YXRlIF9jdXJyZW50VGFnU3BhbjogbnVsbCB8IEhUTUxTcGFuRWxlbWVudCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3Ioe1xuICAgIGFwaSxcbiAgICBjb25maWcsXG4gIH06IEJsb2NrVG9vbENvbnN0cnVjdG9yT3B0aW9uczxhbnksIHsgdXNlcnM6IFVzZXJbXSB9Pikge1xuICAgIHRoaXMuYXBpID0gYXBpO1xuICAgIHRoaXMudXNlcnMgPSBjb25maWc/LnVzZXJzIHx8IFtdO1xuXG4gICAgdGhpcy5faW5pdERPTSgpO1xuICB9XG5cbiAgcHVibGljIHJlbmRlcigpOiBNZW51Q29uZmlnIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWNvbjogXCJAXCIsXG4gICAgICBsYWJlbDogXCJUYWdcIixcbiAgICAgIG9uQWN0aXZhdGU6ICgpID0+IHtcbiAgICAgICAgdGhpcy5faW5zZXJ0VGFnQXRDdXJzb3IoKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBzdXJyb3VuZChyYW5nZTogUmFuZ2UgfCBudWxsKSB7XG4gICAgaWYgKCFyYW5nZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5fY3VycmVudFRhZ1NwYW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fY3VycmVudFRhZ1NwYW4gPSB0aGlzLnRlbXBsYXRlVGFnU3Bhbi5jbG9uZU5vZGUoXG4gICAgICB0cnVlXG4gICAgKSBhcyB0eXBlb2YgdGhpcy50ZW1wbGF0ZVRhZ1NwYW47XG4gICAgcmFuZ2UuaW5zZXJ0Tm9kZSh0aGlzLl9jdXJyZW50VGFnU3Bhbik7XG5cbiAgICB0aGlzLl9zaG93RHJvcGRvd24oKTtcbiAgfVxuXG4gIHB1YmxpYyBjaGVja1N0YXRlKCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVLZXlkb3duID0gKGV2ZW50PzogRXZlbnQpID0+IHtcbiAgICBpZiAoIWV2ZW50IHx8ICEoZXZlbnQgaW5zdGFuY2VvZiBLZXlib2FyZEV2ZW50KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZXZlbnQua2V5ID09PSBcIkBcIikge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gRW1ww6pjaGUgbCdpbnNlcnRpb24gZHUgQCBwYXIgZMOpZmF1dFxuICAgICAgdGhpcy5faW5zZXJ0VGFnQXRDdXJzb3IoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIikge1xuICAgICAgdGhpcy5fY2FuY2VsVGFnKCk7XG4gICAgfVxuICB9O1xuICBwdWJsaWMgaGFuZGxlVHlwaW5nID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5fY3VycmVudFRhZ1NwYW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdGV4dCA9IHRoaXMuX2N1cnJlbnRUYWdTcGFuPy50ZXh0Q29udGVudD8udHJpbSgpO1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGV4dD8uc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsgLy8gU3VwcHJpbWUgbGUgQCBldCBtZXQgZW4gbWludXNjdWxlXG5cbiAgICBjb25zdCBmaWx0ZXJlZFVzZXJzID1cbiAgICAgICFxdWVyeSB8fCBxdWVyeT8ubGVuZ3RoID09PSAwXG4gICAgICAgID8gdGhpcy51c2Vyc1xuICAgICAgICA6IHRoaXMudXNlcnMuZmlsdGVyKCh1c2VyKSA9PiB1c2VyLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxdWVyeSkpO1xuXG4gICAgdGhpcy5fdXBkYXRlRHJvcGRvd24oZmlsdGVyZWRVc2Vycyk7XG4gIH07XG4gIHB1YmxpYyBoYW5kbGVPdXRzaWRlQ2xpY2sgPSAoZXZlbnQ/OiBFdmVudCkgPT4ge1xuICAgIGlmICghZXZlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuZHJvcGRvd24uaGlkZGVuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVsOpcmlmaWUgc2kgbGUgY2xpYyBuJ2VzdCBQQVMgc3VyIGxhIGRyb3Bkb3duIG5pIHN1ciBsYSBtZW50aW9uIGVuIGNvdXJzXG4gICAgaWYgKFxuICAgICAgIXRoaXMuZHJvcGRvd24uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpICYmXG4gICAgICB0aGlzLl9jdXJyZW50VGFnU3BhbiAhPT0gZXZlbnQudGFyZ2V0XG4gICAgKSB7XG4gICAgICB0aGlzLl9jYW5jZWxUYWcoKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfaW5pdERPTSgpIHtcbiAgICB0aGlzLnRlbXBsYXRlVGFnU3Bhbi5jbGFzc0xpc3QuYWRkKFxuICAgICAgXCJ0YWctdXNlclwiLFxuICAgICAgXCJ0ZXh0LWNvbG9yLXRleHQtYnJhbmQtcHJpbWFyeVwiXG4gICAgKTtcbiAgICB0aGlzLnRlbXBsYXRlVGFnU3Bhbi5kYXRhc2V0W1widXNlcklkXCJdID0gXCJcIjtcbiAgICB0aGlzLnRlbXBsYXRlVGFnU3Bhbi50ZXh0Q29udGVudCA9IFwiQFwiO1xuXG4gICAgdGhpcy5kcm9wZG93bi5jbGFzc0xpc3QuYWRkKFxuICAgICAgXCJ0YWctZHJvcGRvd25cIixcbiAgICAgIFwicC1zcGFjZS1zbVwiLFxuICAgICAgXCJieHMtc2hhZG93LWJsYWNrLXNtXCJcbiAgICApO1xuICAgIHRoaXMuZHJvcGRvd24uc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS5iYWNrZ3JvdW5kID0gXCJ3aGl0ZVwiO1xuICAgIHRoaXMuZHJvcGRvd24uc3R5bGUuekluZGV4ID0gXCIxMDAwXCI7XG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS5tYXhIZWlnaHQgPSBcIjE1MHB4XCI7XG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS5vdmVyZmxvd1kgPSBcImF1dG9cIjtcblxuICAgIGNvbnN0IGVkaXRvckRpdiA9IGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5lZGl0b3ItY29udGFpbmVyXCIpO1xuICAgIGlmIChlZGl0b3JEaXYpIHtcbiAgICAgIHRoaXMuYXBpLmxpc3RlbmVycy5vbihlZGl0b3JEaXYsIFwia2V5ZG93blwiLCB0aGlzLmhhbmRsZUtleWRvd24pO1xuICAgICAgdGhpcy5hcGkubGlzdGVuZXJzLm9uKGVkaXRvckRpdiwgXCJpbnB1dFwiLCB0aGlzLmhhbmRsZVR5cGluZyk7XG4gICAgfVxuXG4gICAgdGhpcy5hcGkubGlzdGVuZXJzLm9uKGRvY3VtZW50LmJvZHksIFwiY2xpY2tcIiwgdGhpcy5oYW5kbGVPdXRzaWRlQ2xpY2spO1xuICB9XG4gIHByaXZhdGUgX2luc2VydFRhZ0F0Q3Vyc29yKCkge1xuICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcbiAgICBpZiAoIXNlbGVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7XG5cbiAgICBpZiAoIXJhbmdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fY3VycmVudFRhZ1NwYW4gPSB0aGlzLnRlbXBsYXRlVGFnU3Bhbi5jbG9uZU5vZGUoXG4gICAgICB0cnVlXG4gICAgKSBhcyB0eXBlb2YgdGhpcy50ZW1wbGF0ZVRhZ1NwYW47XG5cbiAgICByYW5nZS5pbnNlcnROb2RlKHRoaXMuX2N1cnJlbnRUYWdTcGFuKTtcbiAgICByYW5nZS5zZXRTdGFydEFmdGVyKHRoaXMuX2N1cnJlbnRUYWdTcGFuKTtcbiAgICByYW5nZS5zZXRFbmRBZnRlcih0aGlzLl9jdXJyZW50VGFnU3Bhbik7XG4gICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xuICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7XG5cbiAgICB0aGlzLl9zaG93RHJvcGRvd24oKTtcbiAgfVxuICBwcml2YXRlIF9zaG93RHJvcGRvd24oKSB7XG4gICAgaWYgKCF0aGlzLl9jdXJyZW50VGFnU3Bhbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVEcm9wZG93bih0aGlzLnVzZXJzKTtcblxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5kcm9wZG93bik7XG4gICAgY29uc3QgcmVjdCA9IHRoaXMuX2N1cnJlbnRUYWdTcGFuLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIHRoaXMuZHJvcGRvd24uc3R5bGUudG9wID0gYCR7cmVjdC5ib3R0b20gKyB3aW5kb3cuc2Nyb2xsWX1weGA7XG4gICAgdGhpcy5kcm9wZG93bi5zdHlsZS5sZWZ0ID0gYCR7cmVjdC5sZWZ0ICsgd2luZG93LnNjcm9sbFh9cHhgO1xuICB9XG5cbiAgcHJpdmF0ZSBfaGlkZURyb3Bkb3duKCkge1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5kcm9wZG93bik7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVEcm9wZG93bih1c2VyczogVXNlcltdKSB7XG4gICAgdGhpcy5kcm9wZG93bi5pbm5lckhUTUwgPSBcIlwiO1xuXG4gICAgaWYgKHVzZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3Qgbm9SZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgbm9SZXN1bHQudGV4dENvbnRlbnQgPSBcIkF1Y3VuIHLDqXN1bHRhdFwiO1xuICAgICAgbm9SZXN1bHQuc3R5bGUucGFkZGluZyA9IFwiNXB4XCI7XG4gICAgICB0aGlzLmRyb3Bkb3duLmFwcGVuZENoaWxkKG5vUmVzdWx0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB1c2Vycy5mb3JFYWNoKCh1c2VyLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgIG9wdGlvbi50ZXh0Q29udGVudCA9IHVzZXIubmFtZTtcbiAgICAgIG9wdGlvbi5zdHlsZS5wYWRkaW5nID0gXCI1cHhcIjtcbiAgICAgIG9wdGlvbi5zdHlsZS5jdXJzb3IgPSBcInBvaW50ZXJcIjtcbiAgICAgIG9wdGlvbi5kYXRhc2V0W1wiaW5kZXhcIl0gPSBpbmRleC50b1N0cmluZygpO1xuXG4gICAgICBvcHRpb24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHRoaXMuX3NlbGVjdFVzZXIodXNlcikpO1xuXG4gICAgICB0aGlzLmRyb3Bkb3duLmFwcGVuZENoaWxkKG9wdGlvbik7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9zZWxlY3RVc2VyKHVzZXI6IFVzZXIpIHtcbiAgICBpZiAoIXRoaXMuX2N1cnJlbnRUYWdTcGFuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gUmVtcGxhY2UgbGUgY29udGVudSBkdSBzcGFuIGF2ZWMgbGUgbm9tIHPDqWxlY3Rpb25uw6lcbiAgICB0aGlzLl9jdXJyZW50VGFnU3Bhbi50ZXh0Q29udGVudCA9IGBAJHt1c2VyLm5hbWV9YDtcbiAgICB0aGlzLl9jdXJyZW50VGFnU3Bhbi5kYXRhc2V0W1widXNlcklkXCJdID0gdXNlci5pZDtcblxuICAgIC8vIEluc8OocmUgdW4gbsWTdWQgdGV4dGUgYXByw6hzIGxhIHRhZyBwb3VyIMOpdml0ZXIgZGUgZ2FyZGVyIGxlIHN0eWxlXG4gICAgY29uc3QgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShcIlxcdTAwQTBcIik7IC8vIFVuIGVzcGFjZSBwb3VyIMOpdml0ZXIgcXVlIGxlIGN1cnNldXIgY29sbGVcbiAgICB0aGlzLl9jdXJyZW50VGFnU3Bhbi5hZnRlcih0ZXh0Tm9kZSk7XG5cbiAgICAvLyDwn5SlIETDqXBsYWNlIGxlIGN1cnNldXIgYXByw6hzIGxhIHRhZyBwb3VyIGNvbnRpbnVlciDDoCDDqWNyaXJlIG5vcm1hbGVtZW50XG4gICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xuICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcbiAgICByYW5nZS5zZXRTdGFydEFmdGVyKHRleHROb2RlKTtcbiAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTtcbiAgICBzZWxlY3Rpb24/LnJlbW92ZUFsbFJhbmdlcygpO1xuICAgIHNlbGVjdGlvbj8uYWRkUmFuZ2UocmFuZ2UpO1xuXG4gICAgLy8gQ2FjaGUgbGEgZHJvcGRvd24gZXQgcsOpaW5pdGlhbGlzZVxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuID0gbnVsbDtcbiAgICB0aGlzLl9oaWRlRHJvcGRvd24oKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NhbmNlbFRhZygpIHtcbiAgICBpZiAoIXRoaXMuX2N1cnJlbnRUYWdTcGFuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gUsOpY3Vww6hyZSBsZSB0ZXh0ZSDDoCBsJ2ludMOpcmlldXIgZGUgbGEgc3BhblxuICAgIGNvbnN0IHRleHRDb250ZW50ID0gdGhpcy5fY3VycmVudFRhZ1NwYW4udGV4dENvbnRlbnQgfHwgXCJcIjtcblxuICAgIC8vIENyw6llIHVuIG7Fk3VkIHRleHRlIGF2ZWMgbGUgbcOqbWUgY29udGVudVxuICAgIGNvbnN0IHRleHROb2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dENvbnRlbnQpO1xuXG4gICAgLy8gUmVtcGxhY2UgbGEgc3BhbiBwYXIgbGUgdGV4dGUgYnJ1dFxuICAgIHRoaXMuX2N1cnJlbnRUYWdTcGFuLnJlcGxhY2VXaXRoKHRleHROb2RlKTtcblxuICAgIC8vIFLDqWluaXRpYWxpc2UgbGEgcsOpZsOpcmVuY2VcbiAgICB0aGlzLl9jdXJyZW50VGFnU3BhbiA9IG51bGw7XG4gICAgdGhpcy5faGlkZURyb3Bkb3duKCk7XG4gIH1cbn1cbiJdfQ==